<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SISPO HK - Kesiswaan & Wali Asrama</title>
  <link rel="stylesheet" href="sispo.css" />
  <style>
    :root {
      --blue: #1d4ed8;
      --blue-soft: #bfdbfe;
      --blue-soft2: #dbeafe;
      --green: #10b981;
      --green-soft: #bbf7d0;
      --green-soft2: #dcfce7;
      --white: #ffffff;
      --text: #000000;
      --red: #ef4444;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #dbeafe, #dcfce7);
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 12px;
      color: var(--text);
    }

    .app-shell {
      width: 100%;
      max-width: 1280px;
      min-height: 620px;
      background: var(--white);
      border-radius: 18px;
      overflow: hidden;
      display: flex;
      box-shadow: 0 16px 40px rgba(0,0,0,0.2);
    }

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--white);
    }

    .main-header {
      padding: 12px 18px;
      border-bottom: 2px solid var(--blue-soft2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .main-header-left {
      display: flex;
      flex-direction: column;
    }

    .main-title {
      font-size: 17px;
      font-weight: 700;
    }

    .main-subtitle {
      font-size: 11px;
      opacity: 0.75;
    }

    .main-header-right {
      font-size: 11px;
      text-align: right;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--green);
      background: var(--green);
      color: var(--white);
      font-size: 11.5px;
    }

    .main-body {
      flex: 1;
      padding: 14px 18px 16px;
      background: linear-gradient(135deg, #ffffff, #eff6ff);
      overflow-y: auto;
    }

    .btn {
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--blue);
      background: var(--blue);
      color: var(--white);
      font-size: 11.5px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .btn.secondary {
      border-color: var(--green);
      background: var(--green);
    }

    .btn.danger {
      border-color: var(--red);
      background: var(--red);
    }

    .btn:hover {
      opacity: 0.92;
    }

    .btn-xs {
      padding: 3px 7px;
      font-size: 10px;
      border-radius: 999px;
    }

    /* LOGIN KESISWAAN */
    .login-page {
      max-width: 420px;
      margin: 32px auto;
      background: var(--white);
      border-radius: 16px;
      border: 1px solid var(--blue-soft2);
      box-shadow: 0 12px 30px rgba(0,0,0,0.15);
      padding: 20px 18px 18px;
    }

    .login-header {
      text-align: center;
      margin-bottom: 16px;
    }

    .login-badge {
      display: inline-flex;
      padding: 3px 10px;
      border-radius: 999px;
      background: var(--green-soft);
      font-size: 11px;
      margin-bottom: 6px;
    }

    .login-title {
      font-size: 19px;
      font-weight: 700;
    }

    .login-subtitle {
      font-size: 12px;
      opacity: 0.75;
    }

    .login-form-group {
      text-align: left;
      margin-bottom: 12px;
      font-size: 13px;
    }

    .login-form-group label {
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
    }

    .login-form-group input {
      width: 100%;
      padding: 9px 11px;
      border-radius: 10px;
      border: 1px solid var(--blue-soft2);
      font-size: 13px;
      outline: none;
    }

    .login-form-group input:focus {
      border-color: var(--blue);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.35);
    }

    .password-wrapper {
      position: relative;
    }

    .password-wrapper input {
      padding-right: 70px;
    }

    .toggle-password {
      position: absolute;
      right: 9px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 11px;
      padding: 2px 4px;
    }

    .login-button {
      width: 100%;
      margin-top: 8px;
      padding: 10px 10px;
      border-radius: 999px;
      border: 1px solid var(--green);
      background: var(--green);
      color: var(--white);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .login-button:hover {
      background: #059669;
      border-color: #059669;
    }

    .login-error {
      margin-top: 8px;
      font-size: 12px;
      color: #b91c1c;
      min-height: 16px;
    }

    .login-footer {
      margin-top: 10px;
      font-size: 11px;
      text-align: center;
      opacity: 0.8;
    }

    /* WRAPPER MODE KESISWAAN */
    .kesiswaan-wrapper {
      max-width: 1100px;
      margin: 0 auto;
      display: none;
      flex-direction: column;
      gap: 16px;
    }

    /* FILTER */
    .kesiswaan-filter-card {
      background: var(--white);
      border-radius: 14px;
      padding: 10px 11px;
      border: 1px solid var(--blue-soft2);
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      font-size: 12px;
    }

    .kesiswaan-filter-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 8px 12px;
    }

    @media (max-width: 820px) {
      .kesiswaan-filter-grid {
        grid-template-columns: repeat(2, minmax(0,1fr));
      }
    }

    @media (max-width: 600px) {
      .kesiswaan-filter-grid {
        grid-template-columns: 1fr;
      }
    }

    .kesiswaan-filter-item {
      display: flex;
      flex-direction: column;
    }

    .kesiswaan-filter-item label {
      font-size: 11px;
      margin-bottom: 2px;
      font-weight: 600;
    }

    .kesiswaan-filter-item select,
    .kesiswaan-filter-item input[type="date"] {
      padding: 4px 6px;
      border-radius: 999px;
      border: 1px solid var(--blue-soft2);
      font-size: 12px;
      background: var(--white);
      outline: none;
    }

    .kesiswaan-filter-item select:focus,
    .kesiswaan-filter-item input[type="date"]:focus {
      border-color: var(--blue);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.35);
    }

    .kesiswaan-filter-note {
      margin-top: 6px;
      font-size: 10.5px;
      opacity: 0.8;
    }

    .kesiswaan-filter-actions {
      margin-top: 8px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* TABEL KETIDAKHADIRAN */
    .kesiswaan-table-card {
      background: var(--white);
      border-radius: 14px;
      padding: 10px 11px 9px;
      border: 1px solid var(--blue-soft2);
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
      margin-top: 4px;
      font-size: 11.5px;
    }

    .kesiswaan-table-title {
      font-size: 13.5px;
      font-weight: 700;
      margin-bottom: 7px;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      flex-wrap: wrap;
    }

    .kesiswaan-table-title small {
      font-size: 11px;
      opacity: 0.8;
    }

    .kesiswaan-table-wrapper {
      width: 100%;
      overflow-x: auto;
    }

    .kesiswaan-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11.5px;
      min-width: 960px;
    }

    .kesiswaan-table th,
    .kesiswaan-table td {
      border: 1px solid var(--blue-soft2);
      padding: 4px 5px;
      text-align: center;
      vertical-align: middle;
    }

    .kesiswaan-table th {
      background: var(--blue-soft2);
      font-weight: 600;
    }

    .kesiswaan-table td.align-left {
      text-align: left;
    }

    .kesiswaan-table input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      padding: 2px 4px;
      border-radius: 6px;
      border: 1px solid var(--blue-soft2);
      font-size: 11px;
      outline: none;
    }

    .kesiswaan-table input[type="text"]:focus {
      border-color: var(--green);
      box-shadow: 0 0 0 1px rgba(16,185,129,0.35);
    }

    .kesiswaan-table input[type="radio"] {
      cursor: pointer;
    }

    .readonly-cell {
      background: #f9fafb;
    }

    .kesiswaan-footer-note {
      margin-top: 6px;
      font-size: 10.5px;
      opacity: 0.8;
    }

    .kesiswaan-actions {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .kesiswaan-actions-right {
      margin-left: auto;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* AUTOCOMPLETE NAMA SANTRI */
    .nama-wrapper {
      position: relative;
    }

    .suggestion-box {
      position: absolute;
      left: 0;
      right: 0;
      top: 100%;
      margin-top: 2px;
      background: #ffffff;
      border-radius: 8px;
      border: 1px solid var(--blue-soft2);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-height: 180px;
      overflow-y: auto;
      z-index: 20;
      font-size: 11px;
    }

    .suggestion-item {
      padding: 4px 6px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }

    .suggestion-item span:first-child {
      font-weight: 600;
    }

    .suggestion-item:hover {
      background: var(--blue-soft2);
    }

    .empty-text {
      font-size: 10.5px;
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo-box">
          <img src="https://uploads.onecompiler.io/444e96suz/444e96fm2/cropped-00_Logo-HK-Utama.webp" alt="Logo HK">
        </div>
        <div class="sidebar-title">
          <strong>SISPO HK</strong>
          <span>Sistem Informasi Santri</span>
        </div>
      </div>

      <div class="sidebar-nav">
        <div class="nav-section-title">Mode Akses</div>

        <div class="nav-item">
          <a href="index.html">
            <span>Santri &amp; Wali Santri</span>
            <span class="nav-tag">Rapot</span>
          </a>
        </div>

        <div class="nav-item">
          <a href="guru.html">
            <span>Guru</span>
            <span class="nav-tag">Akademik</span>
          </a>
        </div>

        <div class="nav-item">
          <a href="musyrif.html">
            <span>Musyrif</span>
            <span class="nav-tag">TTQ</span>
          </a>
        </div>

        <div class="nav-item">
          <a href="murobbi.html">
            <span>Murobbi</span>
            <span class="nav-tag">Mutabaah</span>
          </a>
        </div>

        <div class="nav-item">
          <a href="bahasa.html">
            <span>Bahasa</span>
            <span class="nav-tag">Arab &amp; Inggris</span>
          </a>
        </div>

        <div class="nav-item">
          <a href="pengasuhan.html">
            <span>Pengasuhan</span>
            <span class="nav-tag">Poin Pelanggaran</span>
          </a>
        </div>

        <div class="nav-item active">
          <span>Kesiswaan &amp; Wali Asrama</span>
          <span class="nav-tag">Ketidakhadiran</span>
        </div>

        <div class="nav-item">
          <a href="admin.html">
            <span>Admin</span>
            <span class="nav-tag">Data Profil</span>
          </a>
        </div>
      </div>

      <div class="sidebar-footer">
        Pontren Husnul Khotimah
        <span>Dashboard Rapot Terintegrasi</span>
      </div>
    </aside>

    <!-- MAIN -->
    <div class="main">
      <header class="main-header">
        <div class="main-header-left">
          <div class="main-title">Sistem Informasi Santri Pontren Husnul Khotimah</div>
          <div class="main-subtitle">
            Input Ketidakhadiran Santri oleh Kesiswaan &amp; Wali Asrama.
          </div>
        </div>
        <div class="main-header-right">
          Mode: <span>Kesiswaan &amp; Wali Asrama</span>
          <span class="badge" id="statusBadgeKesiswaan">Login diperlukan</span>
          <button type="button"
                  id="logoutKesiswaanBtn"
                  class="btn"
                  onclick="handleLogoutKesiswaan()"
                  style="display:none;">
            Logout
          </button>
        </div>
      </header>

      <main class="main-body">
        <!-- LOGIN KESISWAAN -->
        <div id="loginKesiswaanContainer" class="login-page">
          <div class="login-header">
            <div class="login-badge">ðŸ”‘ Login</div>
            <div class="login-title">Kesiswaan &amp; Wali Asrama</div>
            <div class="login-subtitle">
              Masuk dengan akun kesiswaan atau wali asrama untuk mengisi ketidakhadiran santri.
            </div>
          </div>

          <form id="loginKesiswaanForm" onsubmit="handleLoginKesiswaan(event)">
            <div class="login-form-group">
              <label for="loginKesiswaanID">Email Pengguna</label>
              <input type="text" id="loginKesiswaanID" placeholder="nama@domain.com" autocomplete="username" />
            </div>
            <div class="login-form-group">
              <label for="loginKesiswaanPassword">Password</label>
              <div class="password-wrapper">
                <input type="password" id="loginKesiswaanPassword" placeholder="password" autocomplete="current-password" />
                <button
                  type="button"
                  class="toggle-password"
                  data-target="loginKesiswaanPassword"
                  onclick="togglePassword(this)">
                  Show
                </button>
              </div>
            </div>
            <button class="login-button" type="submit">Masuk</button>
          </form>

          <div id="loginKesiswaanError" class="login-error"></div>

          <div class="login-footer">
            Akun dikelola melalui dashboard Supabase. Role yang diizinkan: <b>kesiswaan</b> dan <b>wali_asrama</b>.
          </div>
        </div>

        <!-- MODE KESISWAAN -->
        <div id="kesiswaanWrapper" class="kesiswaan-wrapper">
          <!-- FILTER -->
          <div class="kesiswaan-filter-card">
            <div style="font-weight:700; font-size:13.5px; margin-bottom:6px;">
              Filter Ketidakhadiran Santri
            </div>

            <div class="kesiswaan-filter-grid">
              <!-- Tahun Ajaran -->
              <div class="kesiswaan-filter-item">
                <label for="kesiswaanTahun">Tahun Ajaran</label>
                <select id="kesiswaanTahun">
                  <option value="2023_2024">2023/2024</option>
                  <option value="2024_2025" selected>2024/2025</option>
                  <option value="2025_2026">2025/2026</option>
                </select>
              </div>

              <!-- Semester -->
              <div class="kesiswaan-filter-item">
                <label for="kesiswaanSemester">Semester</label>
                <select id="kesiswaanSemester">
                  <option value="1" selected>1</option>
                  <option value="2">2</option>
                </select>
              </div>

              <!-- Jenjang -->
              <div class="kesiswaan-filter-item">
                <label for="kesiswaanJenjang">Jenjang</label>
                <select id="kesiswaanJenjang">
                  <option value="MTs (HK1)">MTs (HK1)</option>
                  <option value="MTs (HK2)">MTs (HK2)</option>
                  <option value="MA" selected>MA</option>
                </select>
              </div>

              <!-- Kelas -->
              <div class="kesiswaan-filter-item">
                <label for="kesiswaanKelas">Kelas</label>
                <select id="kesiswaanKelas">
                  <option value="VII">VII</option>
                  <option value="VIII">VIII</option>
                  <option value="IX">IX</option>
                  <option value="X">X</option>
                  <option value="XI" selected>XI</option>
                  <option value="XII">XII</option>
                </select>
              </div>

              <!-- Paralel / Rombel -->
              <div class="kesiswaan-filter-item">
                <label for="kesiswaanParalel">Paralel / Rombel</label>
                <select id="kesiswaanParalel">
                  <option value="">(Semua / Campur)</option>
                  <option value="A">A</option>
                  <option value="B">B</option>
                  <option value="C">C</option>
                  <option value="D">D</option>
                  <option value="E">E</option>
                  <option value="F">F</option>
                  <option value="G">G</option>
                  <option value="H">H</option>
                  <option value="I">I</option>
                  <option value="J">J</option>
                  <option value="K">K</option>
                  <option value="L">L</option>
                  <option value="M">M</option>
                  <option value="N">N</option>
                  <option value="O">O</option>
                  <option value="P">P</option>
                  <option value="Q">Q</option>
                  <option value="R">R</option>
                  <option value="S">S</option>
                  <option value="T">T</option>
                  <option value="U">U</option>
                  <option value="V">V</option>
                  <option value="W">W</option>
                  <option value="X">X</option>
                  <option value="Y">Y</option>
                  <option value="Z">Z</option>
                  <!-- contoh rombel khusus -->
                  <option value="IPA 1">IPA 1</option>
                  <option value="IPA 2">IPA 2</option>
                  <option value="IPA 3">IPA 3</option>
                  <option value="IPA 4">IPA 4</option>
                  <option value="IPA 5">IPA 5</option>
                  <option value="IPA 6">IPA 6</option>
                  <option value="IPA 7">IPA 7</option>
                  <option value="IPA 8">IPA 8</option>
                  <option value="IPA 9">IPA 9</option>
                  <option value="IPA 10">IPA 10</option>
                  <option value="IPA 11">IPA 11</option>
                  <option value="IPA 12">IPA 12</option>
                  <option value="IPA 13">IPA 13</option>
                  <option value="IPA 14">IPA 14</option>
                  <option value="IPA 15">IPA 15</option>
                  <option value="IPS 1">IPS 1</option>
                  <option value="IPS 2">IPS 2</option>
                  <option value="IPS 3">IPS 3</option>
                  <option value="IPS 4">IPS 4</option>
                  <option value="IPS 5">IPS 5</option>
                  <option value="IPS 6">IPS 6</option>
                  <option value="IPS 7">IPS 7</option>
                  <option value="IPS 8">IPS 8</option>
                  <option value="PK 1">PK 1</option>
                  <option value="PK 2">PK 2</option>
                  <option value="PK 3">PK 3</option>
                  <option value="PK 4">PK 4</option>
                  <option value="PK 5">PK 5</option>
                  <option value="PK 6">PK 6</option>
                  <option value="PK 7">PK 7</option>
                  <option value="PK 8">PK 8</option>
                </select>
              </div>

              <!-- Tanggal -->
              <div class="kesiswaan-filter-item">
                <label for="kesiswaanTanggal">Tanggal Ketidakhadiran</label>
                <input type="date" id="kesiswaanTanggal" />
              </div>
            </div>

            <div class="kesiswaan-filter-note">
              Data ketidakhadiran akan disimpan per tanggal dan NIS.  
              Nama santri <b>cukup yang tidak hadir</b> (S/I/A), bukan seluruh kelas.
            </div>

            <div class="kesiswaan-filter-actions">
              <button class="btn secondary" type="button" onclick="tambahBarisKetidakhadiran()">
                âž• Tambah Baris Ketidakhadiran
              </button>
            </div>
          </div>

          <!-- TABEL KETIDAKHADIRAN -->
          <div class="kesiswaan-table-card">
            <div class="kesiswaan-table-title">
              <span>Input Ketidakhadiran Harian Santri</span>
              <small>
                Tanggal: <span id="labelKesiswaanTanggal">-</span> /
                TA <span id="labelKesiswaanTahun">2024/2025</span> /
                Sem <span id="labelKesiswaanSemester">1</span>
              </small>
            </div>

            <div class="kesiswaan-table-wrapper">
              <table class="kesiswaan-table" id="ketidakhadiranTable">
                <thead>
                  <tr>
                    <th>No.</th>
                    <th>Nama Santri</th>
                    <th>Jenjang</th>
                    <th>Kelas</th>
                    <th>Paralel</th>
                    <th>S</th>
                    <th>I</th>
                    <th>A</th>
                    <th>Keterangan</th>
                    <th>Hapus</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Diisi JS -->
                </tbody>
              </table>
            </div>

            <div class="kesiswaan-actions">
              <span class="empty-text" id="infoBarisKosong">
                Belum ada baris. Klik <b>Tambah Baris Ketidakhadiran</b> untuk mulai mencatat.
              </span>
              <div class="kesiswaan-actions-right">
                <button class="btn secondary" type="button" onclick="tambahBarisKetidakhadiran()">
                  âž• Tambah Baris
                </button>
                <button class="btn" type="button" onclick="simpanKetidakhadiran()">
                  ðŸ’¾ Simpan Ketidakhadiran ke Database
                </button>
              </div>
            </div>

            <div class="kesiswaan-footer-note">
              *S = Sakit, I = Izin, A = Alfa (tanpa keterangan).  
              *Penyimpanan menggunakan <code>upsert</code> berdasarkan kombinasi (Tanggal, NIS).  
              *Autocomplete nama santri mengambil data dari tabel <code>rekap_santri</code>.
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    const { createClient } = supabase;

    const SUPABASE_URL = 'https://esravodnlmwstdtudism.supabase.co';
    const SUPABASE_ANON_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzcmF2b2RubG13c3RkdHVkaXNtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4NDE1ODUsImV4cCI6MjA3OTQxNzU4NX0.rWxlzueSdUvd6Vc6VKaGwZv47djT-3HvyhgfI3BpxAY';

    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <script>
    // --- SESSION LOGIN KESISWAAN/WALI ASRAMA ---
    const KESISWAAN_SESSION_KEY = "sispo_kesiswaan_session";
    const SESSION_DURATION_MS = 5 * 60 * 1000;
    let kesiswaanLogoutTimer = null;

    let kesiswaanRowCounter = 0;

    function getKesiswaanSession() {
      const raw = localStorage.getItem(KESISWAAN_SESSION_KEY);
      if (!raw) return null;
      try {
        return JSON.parse(raw);
      } catch {
        return null;
      }
    }

    function setKesiswaanSession(userId, role) {
      const expiresAt = Date.now() + SESSION_DURATION_MS;
      localStorage.setItem(
        KESISWAAN_SESSION_KEY,
        JSON.stringify({ userId, role, expiresAt })
      );
    }

    function clearKesiswaanSession() {
      localStorage.removeItem(KESISWAAN_SESSION_KEY);
      if (kesiswaanLogoutTimer) {
        clearTimeout(kesiswaanLogoutTimer);
        kesiswaanLogoutTimer = null;
      }
    }

    function scheduleKesiswaanAutoLogout() {
      const session = getKesiswaanSession();
      if (!session || !session.expiresAt) return;

      const remaining = session.expiresAt - Date.now();
      if (remaining <= 0) {
        handleLogoutKesiswaan();
      } else {
        if (kesiswaanLogoutTimer) clearTimeout(kesiswaanLogoutTimer);
        kesiswaanLogoutTimer = setTimeout(handleLogoutKesiswaan, remaining);
      }
    }

    function applyKesiswaanLoginUI() {
      document.getElementById("loginKesiswaanContainer").style.display = "none";
      document.getElementById("kesiswaanWrapper").style.display = "flex";
      document.getElementById("statusBadgeKesiswaan").textContent = "Login";
      const btn = document.getElementById("logoutKesiswaanBtn");
      if (btn) btn.style.display = "inline-block";
    }

    function applyKesiswaanLogoutUI() {
      document.getElementById("loginKesiswaanContainer").style.display = "block";
      document.getElementById("kesiswaanWrapper").style.display = "none";
      document.getElementById("statusBadgeKesiswaan").textContent = "Login diperlukan";
      const btn = document.getElementById("logoutKesiswaanBtn");
      if (btn) btn.style.display = "none";
    }

    async function handleLoginKesiswaan(event) {
      event.preventDefault();
      const email = document.getElementById("loginKesiswaanID").value.trim();
      const pass  = document.getElementById("loginKesiswaanPassword").value.trim();
      const errorEl = document.getElementById("loginKesiswaanError");

      if (!email || !pass) {
        errorEl.textContent = "Email dan password wajib diisi.";
        return;
      }

      const { data, error } = await db.auth.signInWithPassword({
        email,
        password: pass
      });

      if (error) {
        console.error(error);
        errorEl.textContent = "Login gagal. Periksa kembali email dan password.";
        return;
      }

      // cek role di tabel user_roles
      const { data: roleData, error: roleError } = await db
        .from("user_roles")
        .select("mode")
        .eq("id", data.user.id)
        .single();

      if (roleError || !roleData) {
        console.error(roleError);
        errorEl.textContent = "Role pengguna tidak ditemukan.";
        await db.auth.signOut();
        return;
      }

      if (roleData.mode !== "kesiswaan" && roleData.mode !== "wali_asrama") {
        errorEl.textContent = "Akun ini bukan akun Kesiswaan/Wali Asrama.";
        await db.auth.signOut();
        return;
      }

      errorEl.textContent = "";
      setKesiswaanSession(data.user.id, roleData.mode);
      applyKesiswaanLoginUI();
      updateKesiswaanLabels();
      scheduleKesiswaanAutoLogout();
    }

    async function handleLogoutKesiswaan() {
      clearKesiswaanSession();
      applyKesiswaanLogoutUI();

      try {
        await db.auth.signOut();
      } catch (e) {
        console.warn("Gagal signOut Supabase (boleh diabaikan di sisi UI).", e);
      }

      const form = document.getElementById("loginKesiswaanForm");
      if (form) form.reset();
      const errorEl = document.getElementById("loginKesiswaanError");
      if (errorEl) errorEl.textContent = "";
    }

    // --- UTIL LABEL ---
    function updateKesiswaanLabels() {
      const tahunValue = document.getElementById("kesiswaanTahun").value;
      const tahunAjaran = tahunValue.replace("_", "/");
      const semester = document.getElementById("kesiswaanSemester").value;
      const tanggal = document.getElementById("kesiswaanTanggal").value || "-";

      document.getElementById("labelKesiswaanTahun").textContent = tahunAjaran;
      document.getElementById("labelKesiswaanSemester").textContent = semester;
      document.getElementById("labelKesiswaanTanggal").textContent = tanggal;
    }

    // --- AUTOCOMPLETE NAMA SANTRI ---
    async function cariSantriUntukRow(rowIndex, keyword) {
      const tahunValue = document.getElementById("kesiswaanTahun").value;
      const tahunAjaran = tahunValue.replace("_", "/");
      const jenjang = document.getElementById("kesiswaanJenjang").value;
      const kelas = document.getElementById("kesiswaanKelas").value;
      const paralel = document.getElementById("kesiswaanParalel").value;

      let query = db
        .from("rekap_santri")
        .select("nis,nama,jenjang,kelas,paralel")
        .eq("tahun_ajaran", tahunAjaran)
        .eq("jenjang", jenjang)
        .ilike("nama", "%" + keyword + "%")
        .limit(10);

      if (kelas) {
        query = query.eq("kelas", kelas);
      }
      if (paralel) {
        query = query.eq("paralel", paralel);
      }

      const { data, error } = await query;

      const box = document.getElementById("suggestions-row-" + rowIndex);
      if (!box) return;

      box.innerHTML = "";

      if (error) {
        console.error(error);
        const div = document.createElement("div");
        div.className = "suggestion-item";
        div.textContent = "Terjadi kesalahan mengambil data santri.";
        box.appendChild(div);
        return;
      }

      if (!data || data.length === 0) {
        const div = document.createElement("div");
        div.className = "suggestion-item";
        div.textContent = "Tidak ada santri dengan nama tersebut.";
        box.appendChild(div);
        return;
      }

      data.forEach((row) => {
        const div = document.createElement("div");
        div.className = "suggestion-item";
        const left = document.createElement("span");
        left.textContent = row.nama;
        const right = document.createElement("span");
        right.textContent = row.kelas + " - " + row.paralel;
        div.appendChild(left);
        div.appendChild(right);

        div.onclick = () => {
          pilihSantriUntukRow(rowIndex, row);
        };

        box.appendChild(div);
      });
    }

    function handleNamaInput(event) {
      const input = event.target;
      const rowIndex = input.dataset.row;
      const keyword = input.value.trim();

      const box = document.getElementById("suggestions-row-" + rowIndex);
      if (!box) return;

      if (keyword.length < 2) {
        box.innerHTML = "";
        return;
      }

      cariSantriUntukRow(rowIndex, keyword);
    }

    function pilihSantriUntukRow(rowIndex, santri) {
      const tbody = document.querySelector("#ketidakhadiranTable tbody");
      const tr = tbody.querySelector('tr[data-row-index="' + rowIndex + '"]');
      if (!tr) return;

      const nisInput = tr.querySelector(".input-nis");
      const namaInput = tr.querySelector(".input-nama");
      const jenjangInput = tr.querySelector(".field-jenjang");
      const kelasInput = tr.querySelector(".field-kelas");
      const paralelInput = tr.querySelector(".field-paralel");
      const box = document.getElementById("suggestions-row-" + rowIndex);

      if (nisInput) nisInput.value = santri.nis || "";
      if (namaInput) namaInput.value = santri.nama || "";
      if (jenjangInput) jenjangInput.value = santri.jenjang || "";
      if (kelasInput) kelasInput.value = santri.kelas || "";
      if (paralelInput) paralelInput.value = santri.paralel || "";
      if (box) box.innerHTML = "";
    }

    // --- TABEL KETIDAKHADIRAN ---
    function renumberRows() {
      const rows = document.querySelectorAll("#ketidakhadiranTable tbody tr");
      rows.forEach((tr, idx) => {
        const noCell = tr.querySelector(".col-no");
        if (noCell) noCell.textContent = idx + 1;
      });

      const info = document.getElementById("infoBarisKosong");
      if (info) {
        info.style.display = rows.length === 0 ? "inline" : "none";
      }
    }

    function tambahBarisKetidakhadiran() {
      const tbody = document.querySelector("#ketidakhadiranTable tbody");
      kesiswaanRowCounter += 1;
      const rowIndex = kesiswaanRowCounter;

      const tr = document.createElement("tr");
      tr.dataset.rowIndex = rowIndex;

      tr.innerHTML = `
        <td class="col-no"></td>
        <td>
          <div class="nama-wrapper">
            <input type="hidden" class="input-nis" />
            <input
              type="text"
              class="input-nama"
              data-row="${rowIndex}"
              placeholder="Ketik nama santri..."
              oninput="handleNamaInput(event)"
              autocomplete="off"
            />
            <div class="suggestion-box" id="suggestions-row-${rowIndex}"></div>
          </div>
        </td>
        <td><input type="text" class="field-jenjang readonly-cell" readonly /></td>
        <td><input type="text" class="field-kelas readonly-cell" readonly /></td>
        <td><input type="text" class="field-paralel readonly-cell" readonly /></td>
        <td><input type="radio" name="status-${rowIndex}" value="S" /></td>
        <td><input type="radio" name="status-${rowIndex}" value="I" /></td>
        <td><input type="radio" name="status-${rowIndex}" value="A" /></td>
        <td><input type="text" class="field-ket" placeholder="Keterangan (opsional)" /></td>
        <td>
          <button type="button" class="btn btn-xs danger" onclick="hapusBarisKetidakhadiran(this)">
            âœ–
          </button>
        </td>
      `;

      tbody.appendChild(tr);
      renumberRows();
    }

    function hapusBarisKetidakhadiran(btn) {
      const tr = btn.closest("tr");
      if (!tr) return;
      tr.remove();
      renumberRows();
    }

    async function simpanKetidakhadiran() {
      const session = getKesiswaanSession();
      if (!session) {
        alert("Sesi login sudah berakhir atau belum login.");
        return;
      }

      const tanggal = document.getElementById("kesiswaanTanggal").value;
      const tahunValue = document.getElementById("kesiswaanTahun").value;
      const tahunAjaran = tahunValue.replace("_", "/");
      const semester = parseInt(document.getElementById("kesiswaanSemester").value, 10);

      if (!tanggal) {
        alert("Tanggal ketidakhadiran wajib diisi.");
        return;
      }

      const rows = document.querySelectorAll("#ketidakhadiranTable tbody tr");
      if (rows.length === 0) {
        alert("Belum ada baris ketidakhadiran yang diisi.");
        return;
      }

      const payload = [];
      let adaBarisInvalid = false;

      rows.forEach((tr) => {
        const rowIndex = tr.dataset.rowIndex;
        const nis = (tr.querySelector(".input-nis")?.value || "").trim();
        const nama = (tr.querySelector(".input-nama")?.value || "").trim();
        const jenjang = (tr.querySelector(".field-jenjang")?.value || "").trim();
        const kelas = (tr.querySelector(".field-kelas")?.value || "").trim();
        const paralel = (tr.querySelector(".field-paralel")?.value || "").trim();
        const ket = (tr.querySelector(".field-ket")?.value || "").trim();
        const statusEl = tr.querySelector('input[name="status-' + rowIndex + '"]:checked');
        const status = statusEl ? statusEl.value : "";

        // Abaikan baris kosong total
        if (!nis && !nama && !status && !ket) return;

        if (!nama || !status) {
          adaBarisInvalid = true;
          return;
        }

        payload.push({
          tanggal,
          tahun_ajaran: tahunAjaran,
          semester,
          nis,
          nama,
          jenjang,
          kelas,
          paralel,
          status,      // 'S' / 'I' / 'A'
          keterangan: ket,
          dibuat_oleh: session.userId,
          role_input: session.role
        });
      });

      if (adaBarisInvalid) {
        alert("Ada baris yang sudah diisi nama tapi belum memilih status S/I/A. Mohon lengkapi dulu.");
        return;
      }

      if (payload.length === 0) {
        alert("Tidak ada data yang valid untuk disimpan.");
        return;
      }

      const { error } = await db
        .from("ketidakhadiran_santri")
        .upsert(payload, { onConflict: ["tanggal", "nis"] });

      if (error) {
        console.error(error);
        alert("Terjadi kesalahan saat menyimpan ke database.");
        return;
      }

      alert("Data ketidakhadiran berhasil disimpan.");
    }

    // --- TOGGLE PASSWORD ---
    function togglePassword(btn) {
      const targetId = btn.getAttribute("data-target");
      const input = document.getElementById(targetId);
      if (!input) return;
      if (input.type === "password") {
        input.type = "text";
        btn.textContent = "Hide";
      } else {
        input.type = "password";
        btn.textContent = "Show";
      }
    }

    // --- INIT ---
    document.addEventListener("DOMContentLoaded", () => {
      // set default tanggal = hari ini
      const tglInput = document.getElementById("kesiswaanTanggal");
      if (tglInput && !tglInput.value) {
        const today = new Date();
        const y = today.getFullYear();
        const m = String(today.getMonth() + 1).padStart(2, "0");
        const d = String(today.getDate()).padStart(2, "0");
        tglInput.value = `${y}-${m}-${d}`;
      }

      ["kesiswaanTahun","kesiswaanSemester","kesiswaanTanggal"].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener("change", updateKesiswaanLabels);
        }
      });
      updateKesiswaanLabels();

      const session = getKesiswaanSession();
      if (session && session.expiresAt && session.expiresAt > Date.now()) {
        applyKesiswaanLoginUI();
        scheduleKesiswaanAutoLogout();
      }
    });
  </script>
</body>
</html>
