<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SISPO HK - Admin</title>
  <link rel="stylesheet" href="sispo.css" />
  <style>
    :root {
      --blue: #1d4ed8;
      --blue-soft: #bfdbfe;
      --blue-soft2: #dbeafe;
      --green: #10b981;
      --green-soft: #bbf7d0;
      --green-soft2: #dcfce7;
      --white: #ffffff;
      --text: #000000;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #dbeafe, #dcfce7);
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 12px;
      color: var(--text);
    }
    .app-shell {
      width: 100%;
      max-width: 1280px;
      min-height: 620px;
      background: var(--white);
      border-radius: 18px;
      overflow: hidden;
      display: flex;
      box-shadow: 0 16px 40px rgba(0,0,0,0.2);
    }
    /* MAIN */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--white);
    }
    .main-header {
      padding: 12px 18px;
      border-bottom: 2px solid var(--blue-soft2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .main-header-left {
      display: flex;
      flex-direction: column;
    }
    .main-title {
      font-size: 17px;
      font-weight: 700;
    }
    .main-subtitle {
      font-size: 11px;
      opacity: 0.75;
    }
    .main-header-right {
      font-size: 11px;
      text-align: right;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--green);
      background: var(--green);
      color: var(--white);
      font-size: 11.5px;
    }
    .main-body {
      flex: 1;
      padding: 14px 18px 16px;
      background: linear-gradient(135deg, #ffffff, #eff6ff);
      overflow-y: auto;
    }
    .btn {
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--blue);
      background: var(--blue);
      color: var(--white);
      font-size: 11.5px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    .btn.secondary {
      border-color: var(--green);
      background: var(--green);
    }
    .btn:hover {
      opacity: 0.92;
    }

    /* LOGIN ADMIN */
    .login-page {
      max-width: 420px;
      margin: 32px auto;
      background: var(--white);
      border-radius: 16px;
      border: 1px solid var(--blue-soft2);
      box-shadow: 0 12px 30px rgba(0,0,0,0.15);
      padding: 20px 18px 18px;
    }
    .login-header {
      text-align: center;
      margin-bottom: 16px;
    }
    .login-badge {
      display: inline-flex;
      padding: 3px 10px;
      border-radius: 999px;
      background: var(--green-soft);
      font-size: 11px;
      margin-bottom: 6px;
    }
    .login-title {
      font-size: 19px;
      font-weight: 700;
    }
    .login-subtitle {
      font-size: 12px;
      opacity: 0.75;
    }
    .login-form-group {
      text-align: left;
      margin-bottom: 12px;
      font-size: 13px;
    }
    .login-form-group label {
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
    }
    .login-form-group input {
      width: 100%;
      padding: 9px 11px;
      border-radius: 10px;
      border: 1px solid var(--blue-soft2);
      font-size: 13px;
      outline: none;
    }
    .login-form-group input:focus {
      border-color: var(--blue);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.35);
    }
    .password-wrapper {
      position: relative;
    }
    .password-wrapper input {
      padding-right: 70px;
    }
    .toggle-password {
      position: absolute;
      right: 9px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 11px;
      padding: 2px 4px;
    }
    .login-button {
      width: 100%;
      margin-top: 8px;
      padding: 10px 10px;
      border-radius: 999px;
      border: 1px solid var(--green);
      background: var(--green);
      color: var(--white);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .login-button:hover {
      background: #059669;
      border-color: #059669;
    }
    .login-error {
      margin-top: 8px;
      font-size: 12px;
      color: #b91c1c;
      min-height: 16px;
    }
    .login-footer {
      margin-top: 10px;
      font-size: 11px;
      text-align: center;
      opacity: 0.8;
    }

    /* ADMIN MODE WRAPPER */
    .admin-wrapper {
      max-width: 980px;
      margin: 0 auto;
      display: none;
      flex-direction: column;
      gap: 16px;
    }

    /* FILTER INPUT PROFIL SANTRI (ADMIN) */
    .admin-filter-card {
      background: var(--white);
      border-radius: 14px;
      padding: 10px 11px;
      border: 1px solid var(--blue-soft2);
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      font-size: 12px;
    }
    .admin-filter-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 8px 12px;
    }
    @media (max-width: 820px) {
      .admin-filter-grid {
        grid-template-columns: repeat(2, minmax(0,1fr));
      }
    }
    @media (max-width: 600px) {
      .admin-filter-grid {
        grid-template-columns: 1fr;
      }
    }
    .admin-filter-item {
      display: flex;
      flex-direction: column;
    }
    .admin-filter-item label {
      font-size: 11px;
      margin-bottom: 2px;
      font-weight: 600;
    }
    .admin-filter-item select {
      padding: 4px 6px;
      border-radius: 999px;
      border: 1px solid var(--blue-soft2);
      font-size: 12px;
      background: var(--white);
      outline: none;
    }
    .admin-filter-item select:focus {
      border-color: var(--blue);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.35);
    }
    .admin-filter-note {
      margin-top: 6px;
      font-size: 10.5px;
      opacity: 0.8;
    }

    .admin-actions {
      margin-top: 8px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
    }
    .admin-footer-note {
      margin-top: 6px;
      font-size: 10.5px;
      opacity: 0.8;
    }

    /* Tombol template */
    .template-btn {
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--blue);
      background: var(--blue);
      color: var(--white);
      font-size: 11.5px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    .template-btn.secondary {
      border-color: var(--green);
      background: var(--green);
    }
    .template-btn:hover {
      opacity: 0.92;
    }
    .template-btn input[type="file"] {
      display: none;
    }

    /* TABEL INPUT DATA SANTRI (ADMIN) */
    .admin-table-card {
      background: var(--white);
      border-radius: 14px;
      padding: 10px 11px 9px;
      border: 1px solid var(--blue-soft2);
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
      margin-top: 4px;
      font-size: 11.5px;
    }
    .admin-table-title {
      font-size: 13.5px;
      font-weight: 700;
      margin-bottom: 7px;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      flex-wrap: wrap;
    }
    .admin-table-title small {
      font-size: 11px;
      opacity: 0.8;
    }
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11.5px;
    }
    .admin-table th,
    .admin-table td {
      border: 1px solid var(--blue-soft2);
      padding: 4px 5px;
      text-align: center;
    }
    .admin-table th {
      background: var(--blue-soft2);
      font-weight: 600;
    }
    .admin-table td.align-left {
      text-align: left;
    }
    .admin-table input[type="text"],
    .admin-table input[type="date"],
    .admin-table input[type="tel"],
    .admin-table input[type="file"],
    .admin-table select {
      width: 100%;
      box-sizing: border-box;
      padding: 2px 4px;
      border-radius: 6px;
      border: 1px solid var(--blue-soft2);
      font-size: 11px;
      outline: none;
      text-align: left;
    }
    .admin-table select {
      padding-right: 18px;
    }
    .admin-table input:focus,
    .admin-table select:focus {
      border-color: var(--green);
      box-shadow: 0 0 0 1px rgba(16,185,129,0.35);
    }
    /* Tombol upload foto */
    .admin-photo-upload {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--green);
      background: var(--green);
      color: var(--white);
      font-size: 10.5px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }
    .admin-photo-upload:hover {
      opacity: 0.92;
    }
    .admin-photo-upload input[type="file"] {
      display: none;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo-box">
          <img src="https://uploads.onecompiler.io/444e96suz/444e96fm2/cropped-00_Logo-HK-Utama.webp" alt="Logo HK">
        </div>
        <div class="sidebar-title">
          <strong>SISPO HK</strong>
          <span>Sistem Informasi Santri</span>
        </div>
      </div>

      <div class="sidebar-nav">
        <div class="nav-section-title">Mode Akses</div>

        <div class="nav-item">
          <a href="index.html">
            <span>Santri &amp; Wali Santri</span>
            <span class="nav-tag">Rapot</span>
          </a>
        </div>

        <div class="nav-item">
          <a href="guru.html">
            <span>Guru</span>
            <span class="nav-tag">Akademik</span>
          </a>
        </div>

        <div class="nav-item">
          <a href="musyrif.html">
            <span>Musyrif</span>
            <span class="nav-tag">TTQ</span>
          </a>
        </div>

        <div class="nav-item">
          <a href="murobbi.html">
            <span>Murobbi</span>
            <span class="nav-tag">Mutabaah</span>
          </a>
        </div>

        <div class="nav-item">
          <a href="bahasa.html">
            <span>Bahasa</span>
            <span class="nav-tag">Arab &amp; Inggris</span>
          </a>
        </div>

        <div class="nav-item">
          <a href="pengasuhan.html">
            <span>Pengasuhan</span>
            <span class="nav-tag">Poin Pelanggaran</span>
          </a>
        </div>

        <div class="nav-item active">
          <span>Admin</span>
          <span class="nav-tag">Data Profil</span>
        </div>
      </div>

      <div class="sidebar-footer">
        Pontren Husnul Khotimah
        <span>Dashboard Rapot Terintegrasi</span>
      </div>
    </aside>

    <!-- MAIN -->
    <div class="main">
      <header class="main-header">
        <div class="main-header-left">
          <div class="main-title">Sistem Informasi Santri Pontren Husnul Khotimah</div>
          <div class="main-subtitle">
            Form input Data Profil Santri oleh Admin.
          </div>
        </div>
        <div class="main-header-right">
          Mode: <span>Admin</span>
          <span class="badge" id="statusBadgeAdmin">Login diperlukan</span>
          <button type="button"
                  id="logoutAdminBtn"
                  class="btn"
                  onclick="handleLogoutAdmin()"
                  style="display:none;">
            Logout
          </button>
        </div>
      </header>

      <main class="main-body">
        <!-- LOGIN ADMIN -->
        <div id="loginAdminContainer" class="login-page">
          <div class="login-header">
            <div class="login-badge">ðŸ”‘ Login</div>
            <div class="login-title">Admin</div>
            <div class="login-subtitle">
              Masuk dengan akun admin untuk mengelola data profil santri.
            </div>
          </div>

          <form id="loginAdminForm" onsubmit="handleLoginAdmin(event)">
            <div class="login-form-group">
              <label for="loginAdminID">Email Admin</label>
              <input type="text" id="loginAdminID" placeholder="nama@domain.com" autocomplete="username" />
            </div>
            <div class="login-form-group">
              <label for="loginAdminPassword">Password</label>
              <div class="password-wrapper">
                <input type="password" id="loginAdminPassword" placeholder="password" autocomplete="current-password" />
                <button
                  type="button"
                  class="toggle-password"
                  data-target="loginAdminPassword"
                  onclick="togglePassword(this)">
                  Show
                </button>
              </div>
            </div>
            <button class="login-button" type="submit">Masuk</button>
          </form>

          <div id="loginAdminError" class="login-error"></div>

          <div class="login-footer">
            Akun admin dikelola melalui dashboard Supabase.
          </div>
        </div>

        <!-- ADMIN MODE -->
        <div id="adminWrapper" class="admin-wrapper">
          <!-- FILTER PROFIL SANTRI -->
          <div class="admin-filter-card">
            <div style="font-weight:700; font-size:13.5px; margin-bottom:6px;">
              Input Status Akademik Santri
            </div>

            <div class="admin-filter-grid">
              <!-- Tahun Ajaran -->
              <div class="admin-filter-item">
                <label for="adminTahun">Tahun Ajaran</label>
                <select id="adminTahun">
                  <option value="2023_2024">2023/2024</option>
                  <option value="2024_2025" selected>2024/2025</option>
                  <option value="2025_2026">2025/2026</option>
                </select>
              </div>

              <!-- Semester -->
              <div class="admin-filter-item">
                <label for="adminSemester">Semester</label>
                <select id="adminSemester">
                  <option value="1" selected>1</option>
                  <option value="2">2</option>
                </select>
              </div>

              <!-- Jenjang -->
              <div class="admin-filter-item">
                <label for="adminJenjang">Jenjang</label>
                <select id="adminJenjang">
                  <option value="MTs (HK1)">MTs (HK1)</option>
                  <option value="MTs (HK2)">MTs (HK2)</option>
                  <option value="MA" selected>MA</option>
                </select>
              </div>

              <!-- Kelas -->
              <div class="admin-filter-item">
                <label for="adminKelas">Kelas</label>
                <select id="adminKelas">
                  <option value="VII">VII</option>
                  <option value="VIII">VIII</option>
                  <option value="IX">IX</option>
                  <option value="X">X</option>
                  <option value="XI" selected>XI</option>
                  <option value="XII">XII</option>
                </select>
              </div>

              <!-- Paralel -->
              <div class="admin-filter-item">
                <label for="adminParalel">Paralel / Rombel</label>
                <select id="adminParalel">
                  <!-- A-Z -->
                  <option value="A">A</option>
                  <option value="B">B</option>
                  <option value="C">C</option>
                  <option value="D">D</option>
                  <option value="E">E</option>
                  <option value="F">F</option>
                  <option value="G">G</option>
                  <option value="H">H</option>
                  <option value="I">I</option>
                  <option value="J">J</option>
                  <option value="K">K</option>
                  <option value="L">L</option>
                  <option value="M">M</option>
                  <option value="N">N</option>
                  <option value="O">O</option>
                  <option value="P">P</option>
                  <option value="Q">Q</option>
                  <option value="R">R</option>
                  <option value="S">S</option>
                  <option value="T">T</option>
                  <option value="U">U</option>
                  <option value="V">V</option>
                  <option value="W">W</option>
                  <option value="X">X</option>
                  <option value="Y">Y</option>
                  <option value="Z">Z</option>
                  <!-- contoh rombel khusus (opsional, biar tetap ada) -->
                  <option value="IPA 1">IPA 1</option>
                  <option value="IPA 2">IPA 2</option>
                  <option value="IPA 3">IPA 3</option>
                  <option value="IPA 4">IPA 4</option>
                  <option value="IPA 5">IPA 5</option>
                  <option value="IPA 6">IPA 6</option>
                  <option value="IPA 7">IPA 7</option>
                  <option value="IPA 8">IPA 8</option>
                  <option value="IPA 9">IPA 9</option>
                  <option value="IPA 10">IPA 10</option>
                  <option value="IPS 1">IPS 1</option>
                  <option value="IPS 2">IPS 2</option>
                  <option value="IPS 3">IPS 3</option>
                  <option value="PK 1">PK 1</option>
                  <option value="PK 2">PK 2</option>
                  <option value="PK 3">PK 3</option>
                </select>
              </div>
            </div>

            <div class="admin-filter-note">
              Data profil santri yang Anda isi di tabel bawah akan tersimpan untuk
              Tahun Ajaran, Semester, Jenjang, dan Paralel yang dipilih di sini.
            </div>
          </div>

          <!-- TABEL PROFIL SANTRI -->
          <div class="admin-table-card">
            <div class="admin-table-title">
              <span>Input Data Profil Santri</span>
              <small>
                Kelas: <span id="labelAdminKelas">XI</span> /
                TA <span id="labelAdminTahun">2024/2025</span> /
                Sem <span id="labelAdminSemester">1</span>
              </small>
            </div>

            <!-- TOOLS TEMPLATE -->
            <div class="template-tools">
              <div class="template-left">
                <button class="template-btn" type="button" onclick="downloadTemplateAdmin()">
                  â¬‡ Download Template (.xls)
                </button>
                <label class="template-btn secondary">
                  â¬† Upload Data (.xls)
                  <input type="file" id="adminUpload" accept=".xls,.xlsx" onchange="uploadTemplateAdmin(event)" />
                </label>
              </div>
              <div class="template-right">
                Admin dapat mengisi / memperbarui profil santri melalui template Excel,
                lalu upload agar otomatis muncul di tabel, kemudian klik "Simpan ke Database".
              </div>
            </div>

            <table class="admin-table" id="adminProfilTable">
              <thead>
                <tr>
                  <th>No.</th>
                  <th>Foto</th>
                  <th>Nama Lengkap</th>
                  <th>NIS</th>
                  <th>NISN</th>
                  <th style="width:95px;">Jenis Kelamin</th>
                  <th>Tempat Lahir</th>
                  <th>Tanggal Lahir</th>
                  <th>Alamat</th>
                  <th>Nama Ayah</th>
                  <th>No. Telp. Ayah</th>
                  <th>Nama Ibu</th>
                  <th>No. Telp. Ibu</th>
                </tr>
              </thead>
              <tbody>
                <!-- Baris dibuat lewat JS, tidak ada dummy -->
              </tbody>
            </table>

            <div class="admin-actions">
              <button class="btn secondary" type="button" onclick="tambahBarisAdmin()">âž• Tambah Baris</button>
              <button class="btn" type="button" onclick="simpanAdminProfil()">ðŸ’¾ Simpan ke Database</button>
            </div>

            <div class="admin-footer-note">
              *Minimal isi NIS dan Nama Lengkap. Kolom lain bisa dilengkapi bertahap.  
              *Upload template akan mengisi tabel otomatis, lalu tinggal klik "Simpan ke Database".
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- SheetJS (xlsx) untuk baca file Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    const { createClient } = supabase;

    const SUPABASE_URL = 'https://esravodnlmwstdtudism.supabase.co';
    const SUPABASE_ANON_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzcmF2b2RubG13c3RkdHVkaXNtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4NDE1ODUsImV4cCI6MjA3OTQxNzU4NX0.rWxlzueSdUvd6Vc6VKaGwZv47djT-3HvyhgfI3BpxAY';

    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <!-- Logic Admin -->
  <script>
    // --- SESSION LOGIN ADMIN ---
    const ADMIN_SESSION_KEY = "sispo_admin_session";
    const SESSION_DURATION_MS = 5 * 60 * 1000;
    let adminLogoutTimer = null;

    // cache file foto per baris (key = nomor baris)
    const adminFotoFiles = {};

    async function handleLoginAdmin(event) {
      event.preventDefault();
      const email = document.getElementById("loginAdminID").value.trim();
      const pass  = document.getElementById("loginAdminPassword").value.trim();
      const errorEl = document.getElementById("loginAdminError");

      if (!email || !pass) {
        errorEl.textContent = "Username dan password wajib diisi.";
        return;
      }

      const { data, error } = await db.auth.signInWithPassword({
        email,
        password: pass
      });

      if (error) {
        console.error(error);
        errorEl.textContent = "Login gagal. Periksa kembali username dan password.";
        return;
      }

      // cek role admin
      const { data: roleData, error: roleError } = await db
        .from("user_roles")
        .select("mode")
        .eq("id", data.user.id)
        .single();

      if (roleError || !roleData) {
        console.error(roleError);
        errorEl.textContent = "Role pengguna tidak ditemukan.";
        await db.auth.signOut();
        return;
      }

      if (roleData.mode !== "admin") {
        errorEl.textContent = "Akun ini bukan akun Admin.";
        await db.auth.signOut();
        return;
      }

      errorEl.textContent = "";
      setAdminSession();
      applyAdminLoginUI();
      initAdminProfilTable();
      scheduleAdminAutoLogout();
    }

    function applyAdminLoginUI() {
      document.getElementById("loginAdminContainer").style.display = "none";
      document.getElementById("adminWrapper").style.display = "flex";
      document.getElementById("statusBadgeAdmin").textContent = "Login";
      const btn = document.getElementById("logoutAdminBtn");
      if (btn) btn.style.display = "inline-block";
    }

    function applyAdminLogoutUI() {
      document.getElementById("loginAdminContainer").style.display = "block";
      document.getElementById("adminWrapper").style.display = "none";
      document.getElementById("statusBadgeAdmin").textContent = "Login diperlukan";
      const btn = document.getElementById("logoutAdminBtn");
      if (btn) btn.style.display = "none";
    }

    function setAdminSession() {
      const expiresAt = Date.now() + SESSION_DURATION_MS;
      localStorage.setItem(ADMIN_SESSION_KEY, JSON.stringify({ expiresAt }));
    }

    function clearAdminSession() {
      localStorage.removeItem(ADMIN_SESSION_KEY);
      if (adminLogoutTimer) {
        clearTimeout(adminLogoutTimer);
        adminLogoutTimer = null;
      }
    }

    function scheduleAdminAutoLogout() {
      const raw = localStorage.getItem(ADMIN_SESSION_KEY);
      if (!raw) return;

      try {
        const { expiresAt } = JSON.parse(raw);
        const remaining = expiresAt - Date.now();
        if (remaining <= 0) {
          handleLogoutAdmin();
        } else {
          if (adminLogoutTimer) clearTimeout(adminLogoutTimer);
          adminLogoutTimer = setTimeout(handleLogoutAdmin, remaining);
        }
      } catch (e) {
        handleLogoutAdmin();
      }
    }

    async function handleLogoutAdmin() {
      try {
        await db.auth.signOut();
      } catch (e) {
        console.error(e);
      }
      clearAdminSession();
      applyAdminLogoutUI();

      const form = document.getElementById("loginAdminForm");
      if (form) form.reset();
      const errorEl = document.getElementById("loginAdminError");
      if (errorEl) errorEl.textContent = "";
    }

    document.addEventListener("DOMContentLoaded", function () {
      const raw = localStorage.getItem(ADMIN_SESSION_KEY);

      if (!raw) return;

      try {
        const { expiresAt } = JSON.parse(raw);
        if (expiresAt && expiresAt > Date.now()) {
          applyAdminLoginUI();
          initAdminProfilTable();
          scheduleAdminAutoLogout();
        } else {
          clearAdminSession();
          applyAdminLogoutUI();
        }
      } catch (e) {
        clearAdminSession();
        applyAdminLogoutUI();
      }
    });

    // toggle password
    function togglePassword(btn) {
      const targetId = btn.getAttribute("data-target");
      const input = document.getElementById(targetId);
      if (!input) return;

      if (input.type === "password") {
        input.type = "text";
        btn.textContent = "Hide";
      } else {
        input.type = "password";
        btn.textContent = "Show";
      }
    }

    // --- LOGIC TABEL PROFIL SANTRI ---

    function handleAdminFotoChange(event) {
      const input = event.target;
      const rowIndex = input.getAttribute("data-row");
      if (!rowIndex) return;
      adminFotoFiles[rowIndex] = input.files[0] || null;
    }

    function createAdminRow(no) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${no}</td>
        <td>
          <label class="admin-photo-upload">
            Upload
            <input
              type="file"
              accept="image/*"
              data-row="${no}"
              onchange="handleAdminFotoChange(event)"
            />
          </label>
        </td>
        <td><input type="text" data-field="nama_lengkap" /></td>
        <td><input type="text" data-field="nis" /></td>
        <td><input type="text" data-field="nisn" /></td>
        <td>
          <select data-field="jenis_kelamin">
            <option value="">-</option>
            <option value="Ikhwan">Ikhwan</option>
            <option value="Akhwat">Akhwat</option>
          </select>
        </td>
        <td><input type="text" data-field="tempat_lahir" /></td>
        <td><input type="date" data-field="tanggal_lahir" /></td>
        <td><input type="text" data-field="alamat" /></td>
        <td><input type="text" data-field="nama_ayah" /></td>
        <td><input type="tel" data-field="telp_ayah" /></td>
        <td><input type="text" data-field="nama_ibu" /></td>
        <td><input type="tel" data-field="telp_ibu" /></td>
      `;
      return tr;
    }

    function initAdminProfilTable() {
      const tbody = document.querySelector("#adminProfilTable tbody");
      if (!tbody) return;
      tbody.innerHTML = "";
      // awal: 5 baris kosong
      for (let i = 1; i <= 5; i++) {
        tbody.appendChild(createAdminRow(i));
      }
      updateAdminLabels();
      setupAdminFilterListeners();
    }

    function tambahBarisAdmin() {
      const tbody = document.querySelector("#adminProfilTable tbody");
      if (!tbody) return;
      const no = tbody.children.length + 1;
      tbody.appendChild(createAdminRow(no));
    }

    function setupAdminFilterListeners() {
      ["adminTahun","adminKelas","adminSemester"].forEach(id => {
        const el = document.getElementById(id);
        if (el && !el.dataset.listenerAttached) {
          el.addEventListener("change", updateAdminLabels);
          el.dataset.listenerAttached = "true";
        }
      });
    }

    function updateAdminLabels() {
      const tahun = document.getElementById("adminTahun").value;
      const kelas = document.getElementById("adminKelas").value;
      const semester = document.getElementById("adminSemester").value;

      document.getElementById("labelAdminTahun").textContent = tahun.replace("_","/");
      document.getElementById("labelAdminKelas").textContent = kelas;
      document.getElementById("labelAdminSemester").textContent = semester;
    }

    // --- UPLOAD FOTO KE SUPABASE STORAGE ---
    async function uploadAdminFoto(file, nis) {
      try {
        if (!file || !nis) {
          console.warn("uploadAdminFoto: file atau NIS kosong");
          return null;
        }

        const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
        const filePath = `${nis}_${Date.now()}.${ext}`;

        const { data, error } = await db
          .storage
          .from("foto-santri")
          .upload(filePath, file, { upsert: true });

        if (error) {
          console.error("Gagal upload foto ke Supabase Storage:", error);
          alert("Upload foto gagal: " + (error.message || "lihat console browser"));
          return null;
        }

        const { data: publicData, error: publicError } = db
          .storage
          .from("foto-santri")
          .getPublicUrl(filePath);

        if (publicError) {
          console.error("Gagal ambil public URL:", publicError);
          alert("Gagal mengambil URL publik foto. Cek console.");
          return null;
        }

        return publicData.publicUrl || null;
      } catch (err) {
        console.error("Exception di uploadAdminFoto:", err);
        alert("Terjadi error saat upload foto. Cek console browser.");
        return null;
      }
    }

    // SIMPAN PROFIL SANTRI KE SUPABASE
    async function simpanAdminProfil() {
      const tbody = document.querySelector("#adminProfilTable tbody");
      if (!tbody) return;

      const tahun = document.getElementById("adminTahun").value;
      const semester = parseInt(document.getElementById("adminSemester").value, 10);
      const jenjang = document.getElementById("adminJenjang").value;
      const kelas = document.getElementById("adminKelas").value;
      const paralel = document.getElementById("adminParalel").value;

      const rows = Array.from(tbody.querySelectorAll("tr"));
      const payload = [];

      for (const tr of rows) {
        const get = (field) => {
          const el = tr.querySelector(`[data-field="${field}"]`);
          return el ? el.value.trim() : "";
        };

        const nis  = get("nis");
        const nama = get("nama_lengkap");

        // lewati baris kosong / tidak lengkap
        if (!nis && !nama) continue;
        if (!nis || !nama) continue;

        const rowNo = tr.children[0]?.textContent.trim() || "";
        const fotoFile = adminFotoFiles[rowNo] || null;
        let foto_url = null;

        if (fotoFile) {
          foto_url = await uploadAdminFoto(fotoFile, nis);
        }

        payload.push({
          nama_lengkap: nama,
          nis,
          nisn: get("nisn") || null,
          jenis_kelamin: get("jenis_kelamin") || null,
          tempat_lahir: get("tempat_lahir") || null,
          tanggal_lahir: get("tanggal_lahir") || null,
          alamat: get("alamat") || null,
          nama_ayah: get("nama_ayah") || null,
          telp_ayah: get("telp_ayah") || null,
          nama_ibu: get("nama_ibu") || null,
          telp_ibu: get("telp_ibu") || null,
          tahun_ajaran: tahun,
          semester,
          jenjang,
          kelas,
          paralel,
          foto_url: foto_url
        });
      }

      if (payload.length === 0) {
        alert("Tidak ada baris yang berisi NIS dan Nama santri.");
        return;
      }

      const { data, error } = await db
        .from("profil_santri")
        .insert(payload);

      if (error) {
        console.error(error);
        alert("Gagal menyimpan data profil santri: " + error.message);
      } else {
        alert("Data profil santri berhasil disimpan ke Supabase.");
        console.log("Data tersimpan:", data);
      }
    }

      // DOWNLOAD TEMPLATE ADMIN (file .xlsx rapi seperti tabel manual)
     
      function downloadTemplateAdmin() {
        // sesuaikan path dengan lokasi file di repo
        window.location.href = "template_profil_santri.xlsx";
      }

      // UPLOAD TEMPLATE -> ISI TABEL MANUAL
      function uploadTemplateAdmin(event) {
        const file = event.target.files[0];
        if (!file) return;
      
        const ext = file.name.toLowerCase().split(".").pop();
        if (ext !== "xls" && ext !== "xlsx" && ext !== "csv") {
          alert("Gunakan file .xls, .xlsx, atau .csv.");
          return;
        }
      
        const reader = new FileReader();
        reader.onload = function (e) {
          // cellDates:true agar tanggal bisa jadi Date, bukan angka mentah
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array", cellDates: true });
          const firstSheetName = workbook.SheetNames[0];
          const ws = workbook.Sheets[firstSheetName];
      
          const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
      
          if (!rows || rows.length === 0) {
            alert("File kosong atau tidak terbaca.");
            return;
          }
      
          // Cari baris header (kolom pertama "No" atau "No.")
          let headerIndex = rows.findIndex(row =>
            row &&
            row[0] &&
            row[0].toString().toLowerCase().startsWith("no")
          );
      
          if (headerIndex === -1) {
            alert("Header 'No' tidak ditemukan. Pastikan format template tidak diubah.");
            return;
          }
      
          const dataRows = rows
            .slice(headerIndex + 1)
            .filter(r => r && (r[1] || r[2])); // ada NIS atau Nama
      
          const tbody = document.querySelector("#adminProfilTable tbody");
          if (!tbody) return;
          tbody.innerHTML = "";
      
          // reset cache foto (karena data baru)
          for (const k in adminFotoFiles) {
            if (Object.prototype.hasOwnProperty.call(adminFotoFiles, k)) {
              delete adminFotoFiles[k];
            }
          }
      
          dataRows.forEach((row, idx) => {
            const no = idx + 1;
            const tr = createAdminRow(no);
      
            const setField = (field, value) => {
              const el = tr.querySelector(`[data-field="${field}"]`);
              if (el) el.value = (value === undefined || value === null) ? "" : value;
            };
      
            // urutan: [0]=No, [1]=Nama Lengkap, [2]=NIS, [3]=NISN, [4]=JK,
            // [5]=Tempat Lahir, [6]=Tanggal Lahir, [7]=Alamat, [8]=Nama Ayah,
            // [9]=Telp Ayah, [10]=Nama Ibu, [11]=Telp Ibu
            setField("nama_lengkap", row[1]);
            setField("nis", row[2]);
            setField("nisn", row[3]);
            setField("jenis_kelamin", row[4]);
            setField("tempat_lahir", row[5]);
      
            // tangani tanggal lahir: bisa string, bisa Date, bisa kosong
            let tgl = row[6];
            if (tgl instanceof Date) {
              // format: dd-mm-yyyy agar cocok dengan <input type="date">
              const dd = String(tgl.getDate()).padStart(2, "0");
              const mm = String(tgl.getMonth() + 1).padStart(2, "0");
              const yyyy = tgl.getFullYear();
              tgl = `${dd}-${mm}-${yyyy}`;
            }
            setField("tanggal_lahir", tgl);
      
            setField("alamat", row[7]);
            setField("nama_ayah", row[8]);
            setField("telp_ayah", row[9]);
            setField("nama_ibu", row[10]);
            setField("telp_ibu", row[11]);
      
            tbody.appendChild(tr);
          });
      
          alert("Template berhasil dibaca dan tabel terisi.\nSilakan cek datanya, lalu klik 'Simpan ke Database'.");
        };
      
        reader.readAsArrayBuffer(file);
      }

  </script>
</body>
</html>





