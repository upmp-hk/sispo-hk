<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SISPO HK - Santri & Wali Santri</title>
  <link rel="stylesheet" href="sispo.css" />
  <style>
    :root {
      --blue: #1d4ed8;
      --blue-soft: #bfdbfe;
      --blue-soft2: #dbeafe;
      --green: #10b981;
      --green-soft: #bbf7d0;
      --green-soft2: #dcfce7;
      --white: #ffffff;
      --text: #000000;
      --gray-soft: #f3f4f6;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #dbeafe, #dcfce7);
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 12px;
      color: var(--text);
    }
    .app-shell {
      width: 100%;
      max-width: 1280px;
      min-height: 620px;
      background: var(--white);
      border-radius: 18px;
      overflow: hidden;
      display: flex;
      box-shadow: 0 16px 40px rgba(0,0,0,0.2);
    }
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--white);
    }
    .main-header {
      padding: 12px 18px;
      border-bottom: 2px solid var(--blue-soft2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .main-header-left {
      display: flex;
      flex-direction: column;
    }
    .main-title {
      font-size: 17px;
      font-weight: 700;
    }
    .main-subtitle {
      font-size: 11px;
      opacity: 0.75;
    }
    .main-header-right {
      font-size: 11px;
      text-align: right;
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-end;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 11px;
      border-radius: 999px;
      border: 1px solid var(--green);
      background: var(--green);
      color: var(--white);
      font-size: 11.5px;
    }
    .main-body {
      flex: 1;
      padding: 14px 18px 16px;
      background: linear-gradient(135deg, #ffffff, #eff6ff);
      overflow-y: auto;
    }
    .btn {
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--blue);
      background: var(--blue);
      color: var(--white);
      font-size: 11.5px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    .btn.secondary {
      border-color: var(--green);
      background: var(--green);
    }
    .btn:hover {
      opacity: 0.93;
    }

    /* KARTU LOGIN SANTRI (NIS SAJA) */
    .santri-login-card {
      max-width: 420px;
      background: var(--white);
      border-radius: 16px;
      border: 1px solid var(--blue-soft2);
      box-shadow: 0 10px 26px rgba(0,0,0,0.12);
      padding: 16px 16px 12px;
      margin: 0 auto 14px;
      font-size: 12px;
    }
    .santri-login-title {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .santri-login-subtitle {
      font-size: 11px;
      opacity: 0.8;
      margin-bottom: 8px;
    }
    .santri-login-item {
      display: flex;
      flex-direction: column;
      margin-bottom: 8px;
    }
    .santri-login-item label {
      font-size: 11px;
      margin-bottom: 2px;
      font-weight: 600;
    }
    .santri-login-item input {
      padding: 7px 9px;
      border-radius: 999px;
      border: 1px solid var(--blue-soft2);
      font-size: 12px;
      outline: none;
      background: var(--white);
    }
    .santri-login-item input:focus {
      border-color: var(--blue);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.35);
    }
    .santri-login-actions {
      margin-top: 8px;
      display: flex;
      justify-content: flex-end;
    }
    .santri-login-info {
      margin-top: 4px;
      font-size: 10.5px;
      opacity: 0.8;
    }
    .santri-login-error {
      margin-top: 6px;
      font-size: 11px;
      color: #b91c1c;
      min-height: 14px;
    }

    /* FORM FILTER RAPOT SETELAH LOGIN */
    .rapot-search-card {
      max-width: 520px;
      background: var(--white);
      border-radius: 16px;
      border: 1px solid var(--blue-soft2);
      box-shadow: 0 10px 26px rgba(0,0,0,0.12);
      padding: 14px 14px 12px;
      margin-bottom: 14px;
      font-size: 12px;
    }
    .rapot-search-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .rapot-search-subtitle {
      font-size: 11px;
      opacity: 0.8;
      margin-bottom: 8px;
    }
    .rapot-search-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 6px 10px;
    }
    @media (max-width: 640px) {
      .rapot-search-grid {
        grid-template-columns: 1fr 1fr;
      }
    }
    @media (max-width: 520px) {
      .rapot-search-grid {
        grid-template-columns: 1fr;
      }
    }
    .rapot-search-item {
      display: flex;
      flex-direction: column;
    }
    .rapot-search-item label {
      font-size: 11px;
      margin-bottom: 2px;
      font-weight: 600;
    }
    .rapot-search-item input,
    .rapot-search-item select {
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid var(--blue-soft2);
      font-size: 12px;
      outline: none;
      background: var(--white);
    }
    .rapot-search-item input:focus,
    .rapot-search-item select:focus {
      border-color: var(--blue);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.35);
    }
    .rapot-search-static {
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid var(--blue-soft2);
      background: #f9fafb;
      font-size: 12px;
    }
    .rapot-search-actions {
      margin-top: 8px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
    }
    .rapot-search-info {
      margin-top: 4px;
      font-size: 10.5px;
      opacity: 0.8;
    }
    .rapot-error {
      margin-top: 6px;
      font-size: 11px;
      color: #b91c1c;
      min-height: 14px;
    }

    /* LAYOUT RAPOT */
    .rapot-layout {
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 2fr);
      gap: 12px;
    }
    @media (max-width: 900px) {
      .rapot-layout {
        grid-template-columns: 1fr;
      }
    }

    /* KARTU RAPOT GENERIK */
    .rapot-card {
      background: var(--white);
      border-radius: 16px;
      border: 1px solid var(--blue-soft2);
      box-shadow: 0 8px 20px rgba(15,23,42,0.08);
      padding: 10px 11px 9px;
      font-size: 11.5px;
    }
    .rapot-card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
      gap: 8px;
      flex-wrap: wrap;
    }
    .rapot-card-title {
      font-size: 13px;
      font-weight: 700;
    }
    .rapot-card-subtitle {
      font-size: 11px;
      opacity: 0.8;
    }

    .rapot-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11.5px;
    }
    .rapot-table th,
    .rapot-table td {
      border: 1px solid var(--blue-soft2);
      padding: 4px 6px;
      text-align: center;
    }
    .rapot-table th {
      background: var(--blue-soft2);
      font-weight: 600;
    }
    .rapot-table td.align-left {
      text-align: left;
    }
    .rapot-note {
      margin-top: 6px;
      font-size: 10px;
      opacity: 0.8;
    }

    /* KARTU DATA SANTRI */
    .data-santri-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 4px 10px;
      font-size: 11.5px;
    }
    @media (max-width: 640px) {
      .data-santri-grid {
        grid-template-columns: 1fr;
      }
    }
    .data-santri-item-label {
      font-weight: 600;
      opacity: 0.8;
    }

    /* KARTU PENGASUHAN */
    .pengasuhan-flex {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 11.5px;
    }
    .pengasuhan-poin {
      font-size: 24px;
      font-weight: 700;
      color: #b91c1c;
    }
    .pengasuhan-badge {
      display: inline-flex;
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--gray-soft);
      font-size: 10px;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo-box">
          <img src="https://uploads.onecompiler.io/444e96suz/444e96fm2/cropped-00_Logo-HK-Utama.webp" alt="Logo HK">
        </div>
        <div class="sidebar-title">
          <strong>SISPO HK</strong>
          <span>Sistem Informasi Santri</span>
        </div>
      </div>

      <div class="sidebar-nav">
        <div class="nav-section-title">Mode Akses</div>

        <div class="nav-item active">
          <span>Santri &amp; Wali Santri</span>
          <span class="nav-tag">Rapot</span>
        </div>

        <div class="nav-item">
          <a href="guru.html">
            <span>Guru</span>
            <span class="nav-tag">Akademik</span>
          </a>
        </div>

        <div class="nav-item">
          <a href="musyrif.html">
            <span>Musyrif</span>
            <span class="nav-tag">TTQ</span>
          </a>
        </div>

        <div class="nav-item">
          <a href="murobbi.html">
            <span>Murobbi</span>
            <span class="nav-tag">Mutabaah</span>
          </a>
        </div>

        <div class="nav-item">
          <a href="bahasa.html">
            <span>Bahasa</span>
            <span class="nav-tag">Arab &amp; Inggris</span>
          </a>
        </div>

        <div class="nav-item">
          <a href="pengasuhan.html">
            <span>Pengasuhan</span>
            <span class="nav-tag">Poin Pelanggaran</span>
          </a>
        </div>

        <div class="nav-item">
          <a href="admin.html">
            <span>Admin</span>
            <span class="nav-tag">Data Profil</span>
          </a>
        </div>
      </div>

      <div class="sidebar-footer">
        Pontren Husnul Khotimah
        <span>Dashboard Rapot Terintegrasi</span>
      </div>
    </aside>

    <!-- MAIN -->
    <div class="main">
      <header class="main-header">
        <div class="main-header-left">
          <div class="main-title">Sistem Informasi Santri Pontren Husnul Khotimah</div>
          <div class="main-subtitle">
            Akses rapot santri oleh santri &amp; wali santri.
          </div>
        </div>
        <div class="main-header-right">
          <span id="statusSantriShort">Belum login.</span>
          <span class="badge" id="statusSantriBadge">Silakan masukkan NIS untuk login</span>
        </div>
      </header>

      <main class="main-body">
        <!-- LOGIN SANTRI (NIS SAJA) -->
        <section id="santriLoginCard" class="santri-login-card">
          <div class="santri-login-title">Login Santri / Wali Santri</div>
          <div class="santri-login-subtitle">
            Masukkan NIS santri untuk mengakses data rapot.
          </div>
          <div class="santri-login-item">
            <label for="loginNIS">NIS Santri</label>
            <input
              type="text"
              id="loginNIS"
              placeholder="Contoh: 202412345"
              onkeydown="if(event.key==='Enter'){handleSantriLogin();}"
            />
          </div>
          <div class="santri-login-actions">
            <button class="btn" type="button" onclick="handleSantriLogin()">Masuk</button>
          </div>
          <div class="santri-login-info">
            *NIS harus sesuai dengan data yang sudah dimasukkan Admin.  
            *Jika NIS tidak ditemukan, akses akan ditolak.
          </div>
          <div id="santriLoginError" class="santri-login-error"></div>
        </section>

        <!-- FILTER RAPOT (SETELAH LOGIN) -->
        <section id="rapotFilterCard" class="rapot-search-card hidden">
          <div class="rapot-search-title">Filter Rapot</div>
          <div class="rapot-search-subtitle">
            Pilih Tahun Ajaran dan Semester. NIS sudah terkunci sesuai akun yang login.
          </div>

          <div class="rapot-search-grid">
            <div class="rapot-search-item">
              <label>NIS Saat Ini</label>
              <div id="currentNisDisplay" class="rapot-search-static">-</div>
            </div>

            <div class="rapot-search-item">
              <label for="searchTahun">Tahun Ajaran</label>
              <select id="searchTahun">
                <option value="2023_2024">2023/2024</option>
                <option value="2024_2025" selected>2024/2025</option>
                <option value="2025_2026">2025/2026</option>
              </select>
            </div>

            <div class="rapot-search-item">
              <label for="searchSemester">Semester</label>
              <select id="searchSemester">
                <option value="1" selected>1</option>
                <option value="2">2</option>
              </select>
            </div>

            <div class="rapot-search-item">
              <label for="searchTanggalLahir">Tanggal Lahir (opsional)</label>
              <input type="date" id="searchTanggalLahir" />
            </div>
          </div>

          <div class="rapot-search-actions">
            <button class="btn secondary" type="button" onclick="resetFormRapot()">Reset Filter</button>
            <button class="btn" type="button" onclick="cekRapotSantri()">üîç Lihat Rapot</button>
          </div>

          <div class="rapot-search-info">
            *Tanggal lahir bersifat opsional, tetapi jika diisi akan ikut dicek untuk keamanan tambahan.  
            *Data diambil dari tabel <code>rekap_santri</code>.
          </div>
          <div id="rapotError" class="rapot-error"></div>
        </section>

        <!-- LAYOUT RAPOT -->
        <section id="rapotContainer" class="rapot-layout hidden">
          <!-- KOLOM KIRI -->
          <div class="rapot-col-left">
            <!-- DATA SANTRI -->
            <article class="rapot-card">
              <div class="rapot-card-header">
                <div class="rapot-card-title">Profil Santri</div>
                <div class="rapot-card-subtitle" id="profilHeaderRight"></div>
              </div>
              <div class="data-santri-grid" id="profilSantri"></div>
            </article>

            <!-- RAPOT AKADEMIK -->
            <article class="rapot-card" style="margin-top:10px;">
              <div class="rapot-card-header">
                <div class="rapot-card-title">Rapot Akademik</div>
                <div class="rapot-card-subtitle" id="akademikHeaderRight"></div>
              </div>
              <div style="width:100%; overflow-x:auto;">
                <table class="rapot-table" id="akademikTable">
                  <thead>
                    <tr>
                      <th>No.</th>
                      <th>Mata Pelajaran</th>
                      <th>Pengetahuan</th>
                      <th>Keterampilan</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
              <div class="rapot-note">
                *Jika suatu mata pelajaran kosong, artinya nilai belum diinput atau tidak diambil oleh santri.
              </div>
            </article>

            <!-- RAPOT PENGASUHAN -->
            <article class="rapot-card" style="margin-top:10px;">
              <div class="rapot-card-header">
                <div class="rapot-card-title">Ringkasan Pengasuhan</div>
                <div class="rapot-card-subtitle" id="pengasuhanHeaderRight"></div>
              </div>
              <div class="pengasuhan-flex">
                <div>
                  <span class="pengasuhan-badge">Total Poin Pelanggaran</span><br />
                  <span class="pengasuhan-poin" id="pengasuhanPoin">-</span>
                </div>
                <div>
                  <span class="pengasuhan-badge">Catatan Pembinaan</span><br />
                  <div id="pengasuhanCatatan" style="margin-top:4px; font-size:11.5px;">-</div>
                </div>
              </div>
              <div class="rapot-note">
                *Semakin besar poin pelanggaran menandakan semakin banyak pelanggaran yang dilakukan santri.  
                *Catatan pembinaan diisi oleh unit pengasuhan.
              </div>
            </article>
          </div>

          <!-- KOLOM KANAN -->
          <div class="rapot-col-right">
            <!-- RAPOT TTQ -->
            <article class="rapot-card">
              <div class="rapot-card-header">
                <div class="rapot-card-title">Rapot Tahsin dan Tahfidz Qur'an (TTQ)</div>
                <div class="rapot-card-subtitle" id="ttqHeaderRight"></div>
              </div>
              <table class="rapot-table">
                <thead>
                  <tr>
                    <th>Komponen</th>
                    <th>Nilai</th>
                    <th>Komponen</th>
                    <th>Nilai</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="align-left">Hafalan Muqorror</td>
                    <td id="ttqHafMuq">-</td>
                    <td class="align-left">Hafalan Ziyadah</td>
                    <td id="ttqHafZiyadah">-</td>
                  </tr>
                  <tr>
                    <td class="align-left">Ujian Muqorror</td>
                    <td id="ttqUjianMuq">-</td>
                    <td class="align-left">Ujian Ziyadah</td>
                    <td id="ttqUjianZiyadah">-</td>
                  </tr>
                  <tr>
                    <td class="align-left">Hafalan Murojaah</td>
                    <td id="ttqHafMuro">-</td>
                    <td class="align-left"></td>
                    <td></td>
                  </tr>
                </tbody>
              </table>
              <div class="rapot-note">
                *Mencakup Hafalan Muqorror, Ujian Muqorror, Hafalan Murojaah, Hafalan Ziyadah, dan Ujian Ziyadah.
              </div>
            </article>

            <!-- RAPOT MUTABAAH -->
            <article class="rapot-card" style="margin-top:10px;">
              <div class="rapot-card-header">
                <div class="rapot-card-title">Rapot Mutabaah Yaumiyyah</div>
                <div class="rapot-card-subtitle" id="mutabaahHeaderRight"></div>
              </div>
              <table class="rapot-table">
                <thead>
                  <tr>
                    <th>Amalan</th>
                    <th>Nilai</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="align-left">Shalat Berjamaah</td>
                    <td id="mutShalatJamaah">-</td>
                  </tr>
                  <tr>
                    <td class="align-left">Shalat Rawatib</td>
                    <td id="mutShalatRawatib">-</td>
                  </tr>
                  <tr>
                    <td class="align-left">Shalat Qiyamullail</td>
                    <td id="mutQiyamullail">-</td>
                  </tr>
                  <tr>
                    <td class="align-left">Shalat Dhuha</td>
                    <td id="mutShalatDhuha">-</td>
                  </tr>
                  <tr>
                    <td class="align-left">Tilawah</td>
                    <td id="mutTilawah">-</td>
                  </tr>
                  <tr>
                    <td class="align-left">Matsurat</td>
                    <td id="mutMatsurat">-</td>
                  </tr>
                  <tr>
                    <td class="align-left">Shaum Sunnah</td>
                    <td id="mutShaumSunnah">-</td>
                  </tr>
                  <tr>
                    <td class="align-left">Olahraga</td>
                    <td id="mutOlahraga">-</td>
                  </tr>
                </tbody>
              </table>
              <div class="rapot-note">
                *Nilai Mutabaah Yaumiyyah diisi oleh Murobbi / pembina asrama.
              </div>
            </article>

            <!-- RAPOT BAHASA -->
            <article class="rapot-card" style="margin-top:10px;">
              <div class="rapot-card-header">
                <div class="rapot-card-title">Rapot Bahasa Asing (Arab dan Inggris)</div>
                <div class="rapot-card-subtitle" id="bahasaHeaderRight"></div>
              </div>
              <table class="rapot-table">
                <thead>
                  <tr>
                    <th>Aspek</th>
                    <th>Nilai</th>
                    <th>Aspek</th>
                    <th>Nilai</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="align-left">Muhadhoroh</td>
                    <td id="bahasaMuhadhoroh">-</td>
                    <td class="align-left">Speaking</td>
                    <td id="bahasaSpeaking">-</td>
                  </tr>
                  <tr>
                    <td class="align-left">Hiwar</td>
                    <td id="bahasaHiwar">-</td>
                    <td class="align-left">Conversation</td>
                    <td id="bahasaConversation">-</td>
                  </tr>
                  <tr>
                    <td class="align-left">Mufrodat</td>
                    <td id="bahasaMufrodat">-</td>
                    <td class="align-left">Vocabulary</td>
                    <td id="bahasaVocabulary">-</td>
                  </tr>
                </tbody>
              </table>
              <div class="rapot-note">
                *Muhadhoroh ‚Äî Speaking, Hiwar ‚Äî Conversation, Mufrodat ‚Äî Vocabulary.  
                *Nilai diisi oleh Lembaga Bahasa.
              </div>
            </article>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const { createClient } = supabase;

    const SUPABASE_URL = 'https://esravodnlmwstdtudism.supabase.co';
    const SUPABASE_ANON_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzcmF2b2RubG13c3RkdHVkaXNtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4NDE1ODUsImV4cCI6MjA3OTQxNzU4NX0.rWxlzueSdUvd6Vc6VKaGwZv47djT-3HvyhgfI3BpxAY';

    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <script>
    // --- KONFIGURASI MAPEL AKADEMIK UNTUK RAPOT ---
    const AKADEMIK_MAPEL_CONFIG = [
      { label: "Tafsir", p: "nilai_tafsir_p", k: "nilai_tafsir_k" },
      { label: "Aqidah Akhlak", p: "nilai_aqidah_akhlak_p", k: "nilai_aqidah_akhlak_k" },
      { label: "Fiqih", p: "nilai_fiqih_p", k: "nilai_fiqih_k" },
      { label: "Sejarah Kebudayaan Islam", p: "nilai_ski_p", k: "nilai_ski_k" },
      { label: "Pendidikan Kewarganegaraan", p: "nilai_pkn_p", k: "nilai_pkn_k" },
      { label: "Bahasa Indonesia", p: "nilai_b_indonesia_p", k: "nilai_b_indonesia_k" },
      { label: "Bahasa Arab", p: "nilai_b_arab_p", k: "nilai_b_arab_k" },
      { label: "Matematika", p: "nilai_matematika_p", k: "nilai_matematika_k" },
      { label: "Sejarah Indonesia", p: "nilai_sejarah_indo_p", k: "nilai_sejarah_indo_k" },
      { label: "Bahasa Inggris", p: "nilai_b_inggris_p", k: "nilai_b_inggris_k" },
      { label: "Fisika", p: "nilai_fisika_p", k: "nilai_fisika_k" },
      { label: "Kimia", p: "nilai_kimia_p", k: "nilai_kimia_k" },
      { label: "Biologi", p: "nilai_biologi_p", k: "nilai_biologi_k" },
      { label: "Ekonomi", p: "nilai_ekonomi_p", k: "nilai_ekonomi_k" },
      { label: "Geografi", p: "nilai_geografi_p", k: "nilai_geografi_k" },
      { label: "Sosiologi", p: "nilai_sosiologi_p", k: "nilai_sosiologi_k" },
      { label: "Informatika", p: "nilai_informatika_p", k: "nilai_informatika_k" },
      { label: "Matematika Peminatan", p: "nilai_mtk_ipa_p", k: "nilai_mtk_ipa_k" },
      { label: "Fisika Peminatan", p: "nilai_fisika_ipa_p", k: "nilai_fisika_ipa_k" },
      { label: "Kimia Peminatan", p: "nilai_kimia_ipa_p", k: "nilai_kimia_ipa_k" },
      { label: "Biologi Peminatan", p: "nilai_biologi_ipa_p", k: "nilai_biologi_ipa_k" },
      { label: "Sejarah Peminatan", p: "nilai_sejarah_ips_p", k: "nilai_sejarah_ips_k" },
      { label: "Ekonomi Peminatan", p: "nilai_ekonomi_ips_p", k: "nilai_ekonomi_ips_k" },
      { label: "Geografi Peminatan", p: "nilai_geografi_ips_p", k: "nilai_geografi_ips_k" },
      { label: "Sosiologi Peminatan", p: "nilai_sosiologi_ips_p", k: "nilai_sosiologi_ips_k" },
      { label: "Ilmu Tafsir", p: "nilai_ilmu_tafsir_p", k: "nilai_ilmu_tafsir_k" },
      { label: "Ilmu Hadits", p: "nilai_ilmu_hadits_p", k: "nilai_ilmu_hadits_k" },
      { label: "Ushul Fiqih", p: "nilai_ushul_fiqih_p", k: "nilai_ushul_fiqih_k" },
      { label: "Balaghoh", p: "nilai_balaghoh_p", k: "nilai_balaghoh_k" },
      { label: "Bahasa Inggris Tingkat Lanjut", p: "nilai_b_inggris_bhs_p", k: "nilai_b_inggris_bhs_k" },
      { label: "Nahwu (Qawaid)", p: "nilai_qowaid_p", k: "nilai_qowaid_k" },
      { label: "Hadits", p: "nilai_hadits_p", k: "nilai_hadits_k" },
      { label: "Faroidh", p: "nilai_faroidh_p", k: "nilai_faroidh_k" },
      { label: "Bimbingan Konseling (BK)", p: "nilai_bk_p", k: "nilai_bk_k" }
    ];

    const SANTRI_SESSION_KEY = "sispo_santri_session";

    function setSantriSession(nis) {
      localStorage.setItem(SANTRI_SESSION_KEY, JSON.stringify({ nis }));
    }
    function clearSantriSession() {
      localStorage.removeItem(SANTRI_SESSION_KEY);
    }
    function getSantriSession() {
      const raw = localStorage.getItem(SANTRI_SESSION_KEY);
      if (!raw) return null;
      try {
        return JSON.parse(raw);
      } catch {
        return null;
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const session = getSantriSession();
      if (session && session.nis) {
        applySantriLoggedInUI(session.nis);
      } else {
        applySantriLoggedOutUI();
      }
    });

    function applySantriLoggedOutUI() {
      document.getElementById("santriLoginCard").classList.remove("hidden");
      document.getElementById("rapotFilterCard").classList.add("hidden");
      document.getElementById("rapotContainer").classList.add("hidden");
      document.getElementById("statusSantriShort").textContent = "Belum login.";
      document.getElementById("statusSantriBadge").textContent = "Silakan masukkan NIS untuk login";
      document.getElementById("loginNIS").value = "";
      document.getElementById("santriLoginError").textContent = "";
    }

    function applySantriLoggedInUI(nis) {
      document.getElementById("santriLoginCard").classList.add("hidden");
      document.getElementById("rapotFilterCard").classList.remove("hidden");
      document.getElementById("currentNisDisplay").textContent = nis;
      document.getElementById("statusSantriShort").textContent = `Login sebagai NIS ${nis}`;
      document.getElementById("statusSantriBadge").textContent = "Silakan pilih Tahun Ajaran & Semester";
    }

    async function handleSantriLogin() {
      const nis = document.getElementById("loginNIS").value.trim();
      const errorEl = document.getElementById("santriLoginError");
      errorEl.textContent = "";

      if (!nis) {
        errorEl.textContent = "NIS wajib diisi.";
        return;
      }

      // cek ke rekap_santri apakah NIS ada
      const { data, error } = await db
        .from("rekap_santri")
        .select("nis")
        .eq("nis", nis)
        .limit(1);

      if (error) {
        console.error(error);
        errorEl.textContent = "Terjadi kesalahan saat memeriksa NIS.";
        return;
      }

      if (!data || data.length === 0) {
        errorEl.textContent = "NIS tidak ditemukan. Periksa kembali NIS yang dimasukkan.";
        return;
      }

      // NIS valid ‚Üí "login"
      setSantriSession(nis);
      applySantriLoggedInUI(nis);
    }

    function resetFormRapot() {
      document.getElementById("searchTahun").value = "2024_2025";
      document.getElementById("searchSemester").value = "1";
      document.getElementById("searchTanggalLahir").value = "";
      document.getElementById("rapotError").textContent = "";
    }

    async function cekRapotSantri() {
      const session = getSantriSession();
      const errorEl = document.getElementById("rapotError");
      errorEl.textContent = "";

      if (!session || !session.nis) {
        errorEl.textContent = "Silakan login dengan NIS terlebih dahulu.";
        applySantriLoggedOutUI();
        return;
      }

      const nis = session.nis;
      const tahunRaw = document.getElementById("searchTahun").value;
      const semester = parseInt(document.getElementById("searchSemester").value, 10);
      const tglLahirInput = document.getElementById("searchTanggalLahir").value;
      const tahun = tahunRaw.replace("_","/");

      let query = db
        .from("rekap_santri")
        .select("*")
        .eq("nis", nis)
        .eq("tahun_ajaran", tahun)
        .eq("semester", semester);

      if (tglLahirInput) {
        query = query.eq("tanggal_lahir", tglLahirInput);
      }

      const { data, error } = await query.single();

      if (error) {
        console.error(error);
        if (error.code === "PGRST116" || error.message?.includes("JSON object requested")) {
          errorEl.textContent = "Data rapot tidak ditemukan. Periksa kembali pilihan Tahun Ajaran, Semester, dan Tanggal Lahir (jika diisi).";
        } else {
          errorEl.textContent = "Terjadi kesalahan saat mengambil data rapot: " + error.message;
        }
        document.getElementById("rapotContainer").classList.add("hidden");
        document.getElementById("statusSantriShort").textContent = `Login sebagai NIS ${nis}`;
        document.getElementById("statusSantriBadge").textContent = "Data rapot tidak ditemukan untuk filter tersebut";
        return;
      }

      tampilkanRapot(data);
    }

    function safeValue(v, fallback = "-") {
      if (v === null || v === undefined || v === "") return fallback;
      return v;
    }
    function formatNilai(v) {
      if (v === null || v === undefined || v === "") return "-";
      const num = parseFloat(v);
      if (isNaN(num)) return "-";
      return num.toString().replace(".", ",");
    }

    function tampilkanRapot(row) {
      const tahun = row.tahun_ajaran;
      const semester = row.semester;
      const jenjang = safeValue(row.jenjang);
      const kelas = safeValue(row.kelas);
      const paralel = safeValue(row.paralel);

      document.getElementById("statusSantriShort").textContent =
        `${safeValue(row.nama_lengkap)} (${safeValue(row.nis)}) ‚Äî ${tahun} / Semester ${semester}`;
      document.getElementById("statusSantriBadge").textContent = "Data rapot berhasil dimuat";

      document.getElementById("rapotContainer").classList.remove("hidden");

      const profilHeaderRight = document.getElementById("profilHeaderRight");
      profilHeaderRight.textContent = `TA ${tahun} ‚Äî Sem ${semester}`;

      const profilSantri = document.getElementById("profilSantri");
      profilSantri.innerHTML = `
        <div>
          <div class="data-santri-item-label">Nama Lengkap</div>
          <div>${safeValue(row.nama_lengkap)}</div>
        </div>
        <div>
          <div class="data-santri-item-label">NIS / NISN</div>
          <div>${safeValue(row.nis)} / ${safeValue(row.nisn,"-")}</div>
        </div>
        <div>
          <div class="data-santri-item-label">Jenjang</div>
          <div>${jenjang}</div>
        </div>
        <div>
          <div class="data-santri-item-label">Kelas &amp; Paralel</div>
          <div>${kelas} ${paralel}</div>
        </div>
        <div>
          <div class="data-santri-item-label">Jenis Kelamin</div>
          <div>${safeValue(row.jenis_kelamin,"-")}</div>
        </div>
        <div>
          <div class="data-santri-item-label">Alamat</div>
          <div>${safeValue(row.alamat,"-")}</div>
        </div>
      `;

      document.getElementById("akademikHeaderRight").textContent   = `TA ${tahun} ‚Äî Sem ${semester}`;
      document.getElementById("ttqHeaderRight").textContent        = `TA ${tahun} ‚Äî Sem ${semester}`;
      document.getElementById("mutabaahHeaderRight").textContent   = `TA ${tahun} ‚Äî Sem ${semester}`;
      document.getElementById("bahasaHeaderRight").textContent     = `TA ${tahun} ‚Äî Sem ${semester}`;
      document.getElementById("pengasuhanHeaderRight").textContent = `TA ${tahun} ‚Äî Sem ${semester}`;

      // RAPOT AKADEMIK
      const tbodyAkad = document.querySelector("#akademikTable tbody");
      tbodyAkad.innerHTML = "";
      let no = 1;
      AKADEMIK_MAPEL_CONFIG.forEach(cfg => {
        const nilaiP = row[cfg.p];
        const nilaiK = row[cfg.k];
        if (nilaiP !== null && nilaiP !== undefined && nilaiP !== "" ||
            nilaiK !== null && nilaiK !== undefined && nilaiK !== "") {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${no++}</td>
            <td class="align-left">${cfg.label}</td>
            <td>${formatNilai(nilaiP)}</td>
            <td>${formatNilai(nilaiK)}</td>
          `;
          tbodyAkad.appendChild(tr);
        }
      });
      if (tbodyAkad.children.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td colspan="4" style="text-align:center; font-size:11px; opacity:0.75;">
            Belum ada nilai akademik yang tercatat pada tahun ajaran & semester ini.
          </td>
        `;
        tbodyAkad.appendChild(tr);
      }

      // RAPOT TTQ
      document.getElementById("ttqHafMuq").textContent      = formatNilai(row.nilai_hafalan_muqorror);
      document.getElementById("ttqUjianMuq").textContent    = formatNilai(row.nilai_ujian_muqorror);
      document.getElementById("ttqHafMuro").textContent     = formatNilai(row.nilai_hafalan_murojaah);
      document.getElementById("ttqHafZiyadah").textContent  = formatNilai(row.nilai_hafalan_ziyadah);
      document.getElementById("ttqUjianZiyadah").textContent= formatNilai(row.nilai_ujian_ziyadah);

      // RAPOT MUTABAAH
      document.getElementById("mutShalatJamaah").textContent   = formatNilai(row.nilai_shalat_berjamaah);
      document.getElementById("mutShalatRawatib").textContent  = formatNilai(row.nilai_shalat_rawatib);
      document.getElementById("mutQiyamullail").textContent    = formatNilai(row.nilai_qiyamullail);
      document.getElementById("mutShalatDhuha").textContent    = formatNilai(row.nilai_shalat_dhuha);
      document.getElementById("mutTilawah").textContent        = formatNilai(row.nilai_tilawah);
      document.getElementById("mutMatsurat").textContent       = formatNilai(row.nilai_matsurat);
      document.getElementById("mutShaumSunnah").textContent    = formatNilai(row.nilai_shaum_sunnah);
      document.getElementById("mutOlahraga").textContent       = formatNilai(row.nilai_olahraga);

      // RAPOT BAHASA
      document.getElementById("bahasaMuhadhoroh").textContent  = formatNilai(row.nilai_muhadhoroh);
      document.getElementById("bahasaHiwar").textContent       = formatNilai(row.nilai_hiwar);
      document.getElementById("bahasaMufrodat").textContent    = formatNilai(row.nilai_mufrodat);
      document.getElementById("bahasaSpeaking").textContent    = formatNilai(row.nilai_speaking);
      document.getElementById("bahasaConversation").textContent= formatNilai(row.nilai_conversation);
      document.getElementById("bahasaVocabulary").textContent  = formatNilai(row.nilai_vocabulary);

      // PENGASUHAN
      const poin = row.poin_pelanggaran;
      document.getElementById("pengasuhanPoin").textContent =
        poin === null || poin === undefined || poin === "" ? "-" : poin;

      const catatan = row.catatan_pembinaan;
      document.getElementById("pengasuhanCatatan").textContent =
        catatan && catatan.trim() !== "" ? catatan : "-";
    }
  </script>
</body>
</html>