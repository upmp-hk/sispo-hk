<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SISPO HK - Santri & Wali Santri</title>
  <link rel="stylesheet" href="sispo.css" />
  <style>
    :root {
      --blue: #1d4ed8;
      --blue-soft: #bfdbfe;
      --blue-soft2: #dbeafe;
      --green: #10b981;
      --green-soft: #bbf7d0;
      --green-soft2: #dcfce7;
      --white: #ffffff;
      --text: #000000;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #dbeafe, #dcfce7);
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 12px;
      color: var(--text);
    }
    .app-shell {
      width: 100%;
      max-width: 1280px;
      min-height: 620px;
      background: var(--white);
      border-radius: 18px;
      overflow: hidden;
      display: flex;
      box-shadow: 0 16px 40px rgba(0,0,0,0.2);
    }
    /* MAIN */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--white);
    }
    .main-header {
      padding: 12px 18px;
      border-bottom: 2px solid var(--blue-soft2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .main-header-left {
      display: flex;
      flex-direction: column;
    }
    .main-title {
      font-size: 17px;
      font-weight: 700;
    }
    .main-subtitle {
      font-size: 11px;
      opacity: 0.75;
    }
    .main-header-right {
      font-size: 11px;
      text-align: right;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--green);
      background: var(--green);
      color: var(--white);
      font-size: 11.5px;
    }
    .main-body {
      flex: 1;
      padding: 14px 18px 16px;
      background: linear-gradient(135deg, #ffffff, #eff6ff);
      overflow-y: auto;
    }
    /* LOGIN */
    .login-page {
      max-width: 420px;
      margin: 32px auto;
      background: var(--white);
      border-radius: 16px;
      border: 1px solid var(--blue-soft2);
      box-shadow: 0 12px 30px rgba(0,0,0,0.15);
      padding: 20px 18px 18px;
    }
    .login-header {
      text-align: center;
      margin-bottom: 16px;
    }
    .login-badge {
      display: inline-flex;
      padding: 3px 10px;
      border-radius: 999px;
      background: var(--green-soft);
      font-size: 11px;
      margin-bottom: 6px;
    }
    .login-title {
      font-size: 19px;
      font-weight: 700;
    }
    .login-subtitle {
      font-size: 12px;
      opacity: 0.75;
    }
    .login-form-group {
      text-align: left;
      margin-bottom: 12px;
      font-size: 13px;
    }
    .login-form-group label {
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
    }
    .login-form-group input {
      width: 100%;
      padding: 9px 11px;
      border-radius: 10px;
      border: 1px solid var(--blue-soft2);
      font-size: 13px;
      outline: none;
    }
    .login-form-group input:focus {
      border-color: var(--blue);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.35);
    }
    .password-wrapper {
      position: relative;
    }
    .toggle-password {
      display: none; /* tidak dipakai karena login tanpa password */
    }
    .login-button {
      width: 100%;
      margin-top: 8px;
      padding: 10px 10px;
      border-radius: 999px;
      border: 1px solid var(--green);
      background: var(--green);
      color: var(--white);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .login-button:hover {
      background: #059669;
      border-color: #059669;
    }
    .login-error {
      margin-top: 8px;
      font-size: 12px;
      color: #b91c1c;
      min-height: 16px;
    }
    .login-footer {
      margin-top: 10px;
      font-size: 11px;
      text-align: center;
      opacity: 0.8;
    }
    /* RAPOT PAGE */
    .rapot-page {
      display: none;
      flex-direction: column;
      gap: 10px;
    }
    .rapot-header {
      margin-bottom: 6px;
    }
    .rapot-title {
      font-size: 17px;
      font-weight: 700;
    }
    .rapot-subtitle {
      font-size: 11px;
      opacity: 0.75;
    }
    .profile {
      display: grid;
      grid-template-columns: minmax(220px, 0.9fr) minmax(200px, 0.9fr) minmax(260px, 1.2fr);
      gap: 14px;
      margin-top: 10px;
      margin-bottom: 10px;
      align-items: stretch; /* supaya tiga kotak sejajar tingginya */
    }
    @media (max-width: 1024px) {
      .profile {
        grid-template-columns: minmax(220px, 0.9fr) minmax(220px, 1.1fr);
      }
      .profile-data { grid-column: 1 / -1; }
    }
    @media (max-width: 780px) {
      .profile { grid-template-columns: 1fr; }
    }
    .profile-photo {
      background: var(--blue-soft2);
      border-radius: 14px;
      padding: 10px;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .profile-photo img {
      width: 140px;          /* diperkecil */
      height: 180px;
      object-fit: cover;
      border-radius: 12px;
      border: 2px solid var(--white);
      box-shadow: 0 8px 20px rgba(0,0,0,0.25);
      margin: 0 auto;
      display: block;
    }
    .photo-label {
      margin-top: 7px;
      font-size: 12px;
      opacity: 0.85;
    }
    .profile-data {
      border-radius: 14px;
      border: 1px solid var(--blue-soft2);
      padding: 10px 12px;
      background: var(--white);
    }
    .profile-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12.5px;
    }
    .profile-table td {
      padding: 3px 4px;
      vertical-align: top;
    }
    .profile-table td.label {
      width: 130px;
      font-weight: 600;
    }
    .profile-table td.sep {
      width: 8px;
    }
    .academic-status {
      border-radius: 14px;
      border: 1px solid var(--green-soft);
      padding: 10px 11px;
      background: linear-gradient(180deg, var(--green-soft2), var(--white));
      font-size: 11.5px;
    }
    .academic-status-title {
      font-weight: 700;
      font-size: 12.5px;
      margin-bottom: 6px;
      text-align: center;
    }
    .academic-status .field-row {
      display: flex;
      flex-direction: column;
      margin-bottom: 5px;
    }
    .academic-status label {
      font-size: 10.5px;
      margin-bottom: 2px;
    }
    .academic-status select {
      width: 100%;
      padding: 4px 6px;
      border-radius: 999px;
      border: 1px solid var(--blue-soft2);
      font-size: 11.5px;
      background: var(--white);
      outline: none;
    }
    .academic-status select:focus {
      border-color: var(--blue);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.35);
    }
    .academic-status-info {
      margin-top: 6px;
      font-size: 10px;
      text-align: center;
    }
    .academic-status-info span {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--blue-soft);
      margin: 2px 2px 0 0;
    }
    .semester-info {
      font-size: 11.5px;
      margin-bottom: 6px;
      padding: 5px 10px;
      border-radius: 999px;
      background: var(--green-soft2);
      display: inline-block;
    }
    .data-layout {
      display: grid;
      grid-template-columns: minmax(320px, 1.1fr) minmax(320px, 1fr);
      gap: 12px;
    }
    @media (max-width: 960px) {
      .data-layout { grid-template-columns: 1fr; }
    }
    .card {
      background: var(--white);
      border-radius: 14px;
      padding: 10px 11px 9px;
      border: 1px solid var(--blue-soft2);
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
    }
    .card-title {
      font-size: 13.5px;
      font-weight: 700;
      margin-bottom: 7px;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }
    .card-title small {
      font-size: 11px;
      font-weight: 400;
      opacity: 0.85;
    }
    .card-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11.5px;
    }
    .card-table th,
    .card-table td {
      border: 1px solid var(--blue-soft2);
      padding: 4px 5px;
      text-align: center;
    }
    .card-table th {
      background: var(--blue-soft2);
      font-weight: 600;
    }
    .card-table td.label-left {
      text-align: left;
    }
    .table-4col th,
    .table-4col td {
      width: 25%;
    }
    .card-footer {
      margin-top: 5px;
      font-size: 10.5px;
      opacity: 0.85;
    }
    .col-right {
      display: flex;
      flex-direction: column;
      gap: 9px;
    }
    .actions {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    .btn {
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--blue);
      background: var(--blue);
      color: var(--white);
      font-size: 11.5px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    .btn.secondary {
      border-color: var(--green);
      background: var(--green);
    }
    .btn:hover { opacity: 0.92; }
    @media print {
      .no-print { display: none !important; }
      body {
        background: var(--white);
        padding: 0;
      }
      .app-shell {
        box-shadow: none;
        border-radius: 0;
      }
      .sidebar { display: none; }
      .main-header { border-bottom: 1px solid #000; }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- SIDEBAR -->
    <aside class="sidebar no-print">
      <div class="sidebar-header">
        <div class="logo-box">
          <img src="https://uploads.onecompiler.io/444e96suz/444e96fm2/cropped-00_Logo-HK-Utama.webp" alt="Logo HK">
        </div>
        <div class="sidebar-title">
          <strong>SISPO HK</strong>
          <span>Sistem Informasi Santri</span>
        </div>
      </div>

      <div class="sidebar-nav">
        <div class="nav-section-title">Mode Akses</div>

        <!-- Santri (aktif) -->
        <div class="nav-item active">
          <span>Santri & Wali Santri</span>
          <span class="nav-tag">Rapot</span>
        </div>

        <!-- Guru -->
        <div class="nav-item">
          <a href="guru.html">
            <span>Guru</span>
            <span class="nav-tag">Akademik</span>
          </a>
        </div>

        <!-- Musyrif -->
        <div class="nav-item">
          <a href="musyrif.html">
            <span>Musyrif</span>
            <span class="nav-tag">TTQ</span>
          </a>
        </div>

        <!-- Murobbi -->
        <div class="nav-item">
          <a href="murobbi.html">
            <span>Murobbi</span>
            <span class="nav-tag">Mutabaah</span>
          </a>
        </div>

        <!-- Bahasa -->
        <div class="nav-item">
          <a href="bahasa.html">
            <span>Bahasa</span>
            <span class="nav-tag">Arab &amp; Inggris</span>
          </a>
        </div>

        <!-- Pengasuhan -->
        <div class="nav-item">
          <a href="pengasuhan.html">
            <span>Pengasuhan</span>
            <span class="nav-tag">Poin Pelanggaran</span>
          </a>
        </div>

        <!-- Admin -->
        <div class="nav-item">
          <a href="admin.html">
            <span>Admin</span>
            <span class="nav-tag">Data Profil</span>
          </a>
        </div>
      </div>

      <div class="sidebar-footer">
        Pontren Husnul Khotimah
        <span>Dashboard Rapot Terintegrasi</span>
      </div>
    </aside>

    <!-- MAIN -->
    <div class="main">
      <header class="main-header no-print">
        <div class="main-header-left">
          <div class="main-title">Sistem Informasi Santri Pontren Husnul Khotimah</div>
          <div class="main-subtitle">
            Antarmuka Rapot Santri, TTQ, Bahasa, Mutabaah, dan Poin Pelanggaran dalam satu layar.
          </div>
        </div>
        <div class="main-header-right">
          Mode: <span>Santri &amp; Wali Santri</span>
          <span class="badge" id="statusBadge">Login diperlukan</span>
          <button type="button"
                  id="logoutSantriBtn"
                  class="btn"
                  onclick="handleLogoutSantri()"
                  style="display:none;">
            Logout
          </button>
        </div>
      </header>

      <main class="main-body">
        <!-- LOGIN -->
        <div id="loginContainer" class="login-page no-print">
          <div class="login-header">
            <div class="login-badge">ðŸ”‘ Login</div>
            <div class="login-title">Santri & Wali Santri</div>
            <div class="login-subtitle">
              Masukkan NIS santri untuk melihat Rapot Santri.
            </div>
          </div>

          <form id="loginForm" onsubmit="handleLoginSantri(event)">
            <div class="login-form-group">
              <label for="loginNIS">NIS Santri</label>
              <input type="text" id="loginNIS" placeholder="2023.001234" autocomplete="off" />
            </div>
            <button type="submit" class="login-button">Masuk</button>
          </form>

          <div id="loginError" class="login-error"></div>

          <div class="login-footer">
            NIS harus sesuai dengan data di sistem. Tanpa NIS yang valid, rapot tidak dapat ditampilkan.
          </div>
        </div>

        <!-- RAPOT -->
        <div class="rapot-page" id="rapotContainer">
          <div class="rapot-header">
            <div class="rapot-title">Rapot Santri</div>
            <div class="rapot-subtitle">
              Tampilan portofolio nilai, Rapot TTQ, Rapot Bahasa Asing, Mutabaah Yaumiyyah, dan Rapot Pelanggaran (Tata Tertib).
            </div>
          </div>

          <!-- PROFIL -->
          <!-- PROFIL -->
          <section class="profile">
            <!-- STATUS AKADEMIK (kiri) -->
            <div class="academic-status no-print">
              <div class="academic-status-title">Status Akademik</div>

              <!-- 1. Tahun Ajaran -->
              <div class="field-row">
                <label for="filterTahun">Tahun Ajaran</label>
                <select id="filterTahun">
                  <option value="2023_2024">2023/2024</option>
                  <option value="2024_2025" selected>2024/2025</option>
                  <option value="2025_2026">2025/2026</option>
                </select>
              </div>

              <!-- 2. Semester -->
              <div class="field-row">
                <label for="filterSemester">Semester (1/2)</label>
                <select id="filterSemester">
                  <option value="1" selected>1</option>
                  <option value="2">2</option>
                </select>
              </div>

              <!-- 3. Jenjang -->
              <div class="field-row">
                <label for="filterJenjang">Jenjang</label>
                <select id="filterJenjang">
                  <option value="MTs (HK1)">MTs (HK1)</option>
                  <option value="MTs (HK2)">MTs (HK2)</option>
                  <option value="MA" selected>MA</option>
                </select>
              </div>

              <!-- 4. Kelas -->
              <div class="field-row">
                <label for="filterKelas">Kelas (VIIâ€“XII)</label>
                <select id="filterKelas">
                  <option value="VII">VII</option>
                  <option value="VIII">VIII</option>
                  <option value="IX">IX</option>
                  <option value="X">X</option>
                  <option value="XI" selected>XI</option>
                  <option value="XII">XII</option>
                </select>
              </div>

              <!-- 5. Paralel / Rombel -->
              <div class="field-row">
                <label for="filterParalel">Paralel / Rombel</label>
                <select id="filterParalel">
                  <!-- A-Z -->
                  <option value="A">A</option>
                  <option value="B">B</option>
                  <option value="C">C</option>
                  <option value="D">D</option>
                  <option value="E">E</option>
                  <option value="F">F</option>
                  <option value="G">G</option>
                  <option value="H">H</option>
                  <option value="I">I</option>
                  <option value="J">J</option>
                  <option value="K">K</option>
                  <option value="L">L</option>
                  <option value="M">M</option>
                  <option value="N">N</option>
                  <option value="O">O</option>
                  <option value="P">P</option>
                  <option value="Q">Q</option>
                  <option value="R">R</option>
                  <option value="S">S</option>
                  <option value="T">T</option>
                  <option value="U">U</option>
                  <option value="V">V</option>
                  <option value="W">W</option>
                  <option value="X">X</option>
                  <option value="Y">Y</option>
                  <option value="Z">Z</option>
                  <!-- IPA -->
                  <option value="IPA 1">IPA 1</option>
                  <option value="IPA 2">IPA 2</option>
                  <option value="IPA 3">IPA 3</option>
                  <option value="IPA 4">IPA 4</option>
                  <option value="IPA 5">IPA 5</option>
                  <option value="IPA 6">IPA 6</option>
                  <option value="IPA 7">IPA 7</option>
                  <option value="IPA 8">IPA 8</option>
                  <option value="IPA 9">IPA 9</option>
                  <option value="IPA 10">IPA 10</option>
                  <option value="IPA 11">IPA 11</option>
                  <option value="IPA 12">IPA 12</option>
                  <option value="IPA 13">IPA 13</option>
                  <option value="IPA 14">IPA 14</option>
                  <option value="IPA 15">IPA 15</option>
                  <!-- IPS -->
                  <option value="IPS 1">IPS 1</option>
                  <option value="IPS 2">IPS 2</option>
                  <option value="IPS 3">IPS 3</option>
                  <option value="IPS 4">IPS 4</option>
                  <option value="IPS 5">IPS 5</option>
                  <option value="IPS 6">IPS 6</option>
                  <option value="IPS 7">IPS 7</option>
                  <option value="IPS 8">IPS 8</option>
                  <option value="IPS 9">IPS 9</option>
                  <option value="IPS 10">IPS 10</option>
                  <!-- PK -->
                  <option value="PK 1">PK 1</option>
                  <option value="PK 2">PK 2</option>
                  <option value="PK 3">PK 3</option>
                  <option value="PK 4">PK 4</option>
                  <option value="PK 5">PK 5</option>
                  <option value="PK 6">PK 6</option>
                  <option value="PK 7">PK 7</option>
                  <option value="PK 8">PK 8</option>
                  <option value="PK 9">PK 9</option>
                  <option value="PK 10">PK 10</option>
                </select>
              </div>

              <div class="academic-status-info" id="statusRingkasan"></div>
            </div>

            <!-- FOTO (tengah) -->
            <div class="profile-photo">
              <img id="fotoSantri" src="" alt="Foto Santri">
              <div class="photo-label">Foto Santri</div>
            </div>

            <!-- IDENTITAS (kanan) -->
            <div class="profile-data">
              <table class="profile-table">
                <tr>
                  <td class="label">Nama</td><td class="sep">:</td>
                  <td id="fieldNama">-</td>
                </tr>
                <tr>
                  <td class="label">NIS</td><td class="sep">:</td>
                  <td id="fieldNIS">-</td>
                </tr>
                <tr>
                  <td class="label">NISN</td><td class="sep">:</td>
                  <td id="fieldNISN">-</td>
                </tr>
                <tr>
                  <td class="label">Jenis Kelamin</td><td class="sep">:</td>
                  <td id="fieldGender">-</td>
                </tr>
                <tr>
                  <td class="label">Tempat Lahir</td><td class="sep">:</td>
                  <td id="fieldTempat">-</td>
                </tr>
                <tr>
                  <td class="label">Tanggal Lahir</td><td class="sep">:</td>
                  <td id="fieldTglLahir">-</td>
                </tr>
                <tr>
                  <td class="label">Jenjang</td><td class="sep">:</td>
                  <td id="fieldJenjang">-</td>
                </tr>
                <tr>
                  <td class="label">Kelas</td><td class="sep">:</td>
                  <td id="fieldKelas">-</td>
                </tr>
                <tr>
                  <td class="label">Paralel/Rombel</td><td class="sep">:</td>
                  <td id="fieldParalel">-</td>
                </tr>
                <tr>
                  <td class="label">Alamat</td><td class="sep">:</td>
                  <td id="fieldAlamat">-</td>
                </tr>
                <tr>
                  <td class="label">Nama Ayah</td><td class="sep">:</td>
                  <td id="fieldAyah">-</td>
                </tr>
                <tr>
                  <td class="label">No. Telp. Ayah</td><td class="sep">:</td>
                  <td id="fieldTelpAyah">-</td>
                </tr>
                <tr>
                  <td class="label">Nama Ibu</td><td class="sep">:</td>
                  <td id="fieldIbu">-</td>
                </tr>
                <tr>
                  <td class="label">No. Telp. Ibu</td><td class="sep">:</td>
                  <td id="fieldTelpIbu">-</td>
                </tr>
              </table>
            </div>
          </section>

          <div class="semester-info">
            Menampilkan: TA <span id="labelTahun">-</span>,
            Jenjang <span id="labelJenjangInfo">-</span>,
            Kelas <span id="labelKelasInfo">-</span>,
            Paralel <span id="labelParalelInfo">-</span>,
            Semester <span id="labelSemester">-</span>.
          </div>

          <!-- DATA RAPOT -->
          <section class="data-layout">
            <!-- KIRI: AKADEMIK -->
            <div class="col-left">
              <div class="card">
                <div class="card-title">
                  <span>Rapot Akademik</span>
                  <small>TA <span id="miniTahun1">-</span> &mdash; Sem <span id="miniSem1">-</span></small>
                </div>
                <table class="card-table" id="tabelNilai">
                  <thead>
                    <tr>
                      <th>Mapel</th>
                      <th>Pengetahuan</th>
                      <th>Keterampilan</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
                <div class="card-footer">
                  *Data diambil dari rekap nilai akademik sesuai tahun ajaran, semester, jenjang, kelas, dan paralel.
                </div>
              </div>
            </div>

            <!-- KANAN: TTQ, BAHASA, MUTABAAH, PELANGGARAN -->
            <div class="col-right">
              <div class="card">
                <div class="card-title">
                  <span>Rapot Tahsin dan Tahfidz Qur'an (TTQ)</span>
                  <small>TA <span id="miniTahun2">-</span> &mdash; Sem <span id="miniSem2">-</span></small>
                </div>
                <table class="card-table table-4col" id="tabelHafalan">
                  <thead>
                    <tr>
                      <th>Komponen</th>
                      <th>Nilai</th>
                      <th>Komponen</th>
                      <th>Nilai</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
                <div class="card-footer">
                  *Data diambil dari rekap TTQ sesuai filter akademik.
                </div>
              </div>

              <div class="card">
                <div class="card-title">
                  <span>Rapot Bahasa Asing (Arab dan Inggris)</span>
                  <small>TA <span id="miniTahun4">-</span> &mdash; Sem <span id="miniSem4">-</span></small>
                </div>
                <table class="card-table table-4col" id="tabelBahasa">
                  <thead>
                    <tr>
                      <th>Aspek</th>
                      <th>Nilai</th>
                      <th>Aspek</th>
                      <th>Nilai</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
                <div class="card-footer">
                  *Data diambil dari rekap Bahasa sesuai filter akademik.
                </div>
              </div>

              <div class="card">
                <div class="card-title">
                  <span>Rapot Mutabaah Yaumiyyah</span>
                  <small>TA <span id="miniTahun5">-</span> &mdash; Sem <span id="miniSem5">-</span></small>
                </div>
                <table class="card-table" id="tabelMutabaah">
                  <thead>
                    <tr>
                      <th>Amalan</th>
                      <th>Nilai</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
                <div class="card-footer">
                  *Data mutabaah diambil dari rekap sesuai filter akademik.
                </div>
              </div>

              <div class="card">
                <div class="card-title">
                  <span>Rapot Pelanggaran (Tata Tertib)</span>
                  <small>TA <span id="miniTahun3">-</span> &mdash; Sem <span id="miniSem3">-</span></small>
                </div>
                <table class="card-table" id="tabelPelanggaran">
                  <thead>
                    <tr>
                      <th>Jenis Pelanggaran</th>
                      <th>Jumlah Poin</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                  <tfoot>
                    <tr>
                      <th>Total Poin</th>
                      <th id="totalPoin">0</th>
                    </tr>
                  </tfoot>
                </table>
                <div class="card-footer">
                  *Akumulasi poin pelanggaran pada semester terpilih.
                </div>
              </div>
            </div>
          </section>

          <!-- TOMBOL CETAK -->
          <div class="actions no-print">
            <button class="btn secondary" onclick="window.print()">ðŸ–¨ Cetak Rapot</button>
            <button class="btn" onclick="exportPDF()">ðŸ“„ Export PDF</button>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- html2pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <script>
    const { createClient } = supabase;

    const SUPABASE_URL = 'https://esravodnlmwstdtudism.supabase.co';
    const SUPABASE_ANON_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzcmF2b2RubG13c3RkdHVkaXNtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4NDE1ODUsImV4cCI6MjA3OTQxNzU4NX0.rWxlzueSdUvd6Vc6VKaGwZv47djT-3HvyhgfI3BpxAY';

    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // SESSION LOGIN SANTRI/WALI â€“ 5 MENIT
    const SANTRI_SESSION_KEY = "sispo_santri_session";
    const SESSION_DURATION_MS = 5 * 60 * 1000;
    let santriLogoutTimer = null;

    function getCurrentSession() {
      const raw = localStorage.getItem(SANTRI_SESSION_KEY);
      if (!raw) return null;
      try {
        return JSON.parse(raw);
      } catch {
        return null;
      }
    }

    function getCurrentNIS() {
      const session = getCurrentSession();
      return session?.nis || null;
    }

    function setSantriSession(nis) {
      const expiresAt = Date.now() + SESSION_DURATION_MS;
      localStorage.setItem(SANTRI_SESSION_KEY, JSON.stringify({ nis, expiresAt }));
    }

    function clearSantriSession() {
      localStorage.removeItem(SANTRI_SESSION_KEY);
      if (santriLogoutTimer) {
        clearTimeout(santriLogoutTimer);
        santriLogoutTimer = null;
      }
    }

    function scheduleSantriAutoLogout() {
      const session = getCurrentSession();
      if (!session || !session.expiresAt) return;

      const remaining = session.expiresAt - Date.now();
      if (remaining <= 0) {
        handleLogoutSantri();
      } else {
        if (santriLogoutTimer) clearTimeout(santriLogoutTimer);
        santriLogoutTimer = setTimeout(handleLogoutSantri, remaining);
      }
    }

    function applySantriLoginUI() {
      document.getElementById("loginContainer").style.display = "none";
      document.getElementById("rapotContainer").style.display = "flex";
      document.getElementById("statusBadge").textContent = "Login";
      const btn = document.getElementById("logoutSantriBtn");
      if (btn) btn.style.display = "inline-block";
    }

    function applySantriLogoutUI() {
      document.getElementById("loginContainer").style.display = "block";
      document.getElementById("rapotContainer").style.display = "none";
      document.getElementById("statusBadge").textContent = "Login diperlukan";
      const btn = document.getElementById("logoutSantriBtn");
      if (btn) btn.style.display = "none";
    }

    async function handleLoginSantri(event) {
      event.preventDefault();
      const nisInput = document.getElementById("loginNIS").value.trim();
      const errorEl = document.getElementById("loginError");

      if (!nisInput) {
        errorEl.textContent = "NIS wajib diisi.";
        return;
      }

      // cek apakah NIS ada di rekap_santri (tanpa filter lain dulu)
      const { data, error } = await db
        .from("rekap_santri")
        .select("nis")
        .eq("nis", nisInput)
        .limit(1);

      if (error) {
        console.error(error);
        errorEl.textContent = "Terjadi kesalahan saat memeriksa NIS.";
        return;
      }

      if (!data || data.length === 0) {
        errorEl.textContent = "NIS tidak ditemukan di sistem.";
        return;
      }

      errorEl.textContent = "";
      setSantriSession(nisInput);
      applySantriLoginUI();
      scheduleSantriAutoLogout();
      updateStatusRingkasan();
      loadDataSantri();
    }

    async function handleLogoutSantri() {
      clearSantriSession();
      applySantriLogoutUI();

      const form = document.getElementById("loginForm");
      if (form) form.reset();
      const errorEl = document.getElementById("loginError");
      if (errorEl) errorEl.textContent = "";
    }

    function updateStatusRingkasan() {
      const tahunValue = document.getElementById("filterTahun").value;
      const tahunAjaran = tahunValue.replace("_", "/");
      const jenjang = document.getElementById("filterJenjang").value;
      const kelas = document.getElementById("filterKelas").value;
      const paralel = document.getElementById("filterParalel").value;
      const semester = document.getElementById("filterSemester").value;

      const statusEl = document.getElementById("statusRingkasan");
      statusEl.innerHTML = `
        <span>${tahunAjaran}</span>
        <span>Semester ${semester}</span>
        <span>${jenjang}</span>
        <span>Kelas ${kelas}</span>
        <span>Paralel/Rombel ${paralel}</span>
      `;

      document.getElementById("labelTahun").textContent = tahunAjaran;
      document.getElementById("labelJenjangInfo").textContent = jenjang;
      document.getElementById("labelKelasInfo").textContent = kelas;
      document.getElementById("labelParalelInfo").textContent = paralel;
      document.getElementById("labelSemester").textContent = semester;

      ["miniTahun1","miniTahun2","miniTahun3","miniTahun4","miniTahun5"].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.textContent = tahunAjaran;
      });
      ["miniSem1","miniSem2","miniSem3","miniSem4","miniSem5"].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.textContent = semester;
      });
    }

    function exportPDF() {
      const original = document.querySelector('.app-shell');
      const clone = original.cloneNode(true);
      clone.querySelectorAll('.no-print').forEach(el => el.remove());

      const opt = {
        margin:       0.5,
        filename:     'rapot-santri-hk.pdf',
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2 },
        jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
      };
      html2pdf().set(opt).from(clone).save();
    }

    async function loadDataSantri() {
      const nis = getCurrentNIS();
      if (!nis) return; // belum login

      const tahunValue   = document.getElementById("filterTahun").value;
      const tahunAjaran  = tahunValue.replace("_", "/");
      const jenjangFilter = document.getElementById("filterJenjang").value;
      const kelasFilter   = document.getElementById("filterKelas").value;
      const paralelFilter = document.getElementById("filterParalel").value;
      const semesterStr   = document.getElementById("filterSemester").value;
      const semester      = parseInt(semesterStr, 10);

      const tbodyNilai       = document.querySelector("#tabelNilai tbody");
      const tbodyHafalan     = document.querySelector("#tabelHafalan tbody");
      const tbodyPelanggaran = document.querySelector("#tabelPelanggaran tbody");
      const tbodyBahasa      = document.querySelector("#tabelBahasa tbody");
      const tbodyMutabaah    = document.querySelector("#tabelMutabaah tbody");
      const totalPoinEl      = document.getElementById("totalPoin");

      tbodyNilai.innerHTML       = "";
      tbodyHafalan.innerHTML     = "";
      tbodyPelanggaran.innerHTML = "";
      tbodyBahasa.innerHTML      = "";
      tbodyMutabaah.innerHTML    = "";
      totalPoinEl.textContent    = "0";

      // ====== 1. PROFIL / IDENTITAS dari rekap_santri ======
      const { data: profil, error: profilError } = await db
        .from("rekap_santri")
        .select("*")
        .eq("nis", nis)
        .eq("tahun_ajaran", tahunAjaran)
        .eq("semester", semester)
        .eq("jenjang", jenjangFilter)
        .eq("kelas", kelasFilter)
        .eq("paralel", paralelFilter)
        .maybeSingle();

      if (profilError) {
        console.error(profilError);
      }

      const fotoEl      = document.getElementById("fotoSantri");
      const fieldNama   = document.getElementById("fieldNama");
      const fieldNIS    = document.getElementById("fieldNIS");
      const fieldNISN   = document.getElementById("fieldNISN");
      const fieldGender = document.getElementById("fieldGender");
      const fieldTempat = document.getElementById("fieldTempat");
      const fieldTglLahir = document.getElementById("fieldTglLahir");
      const fieldJenjang  = document.getElementById("fieldJenjang");
      const fieldKelas    = document.getElementById("fieldKelas");
      const fieldParalel  = document.getElementById("fieldParalel");
      const fieldAlamat   = document.getElementById("fieldAlamat");
      const fieldAyah     = document.getElementById("fieldAyah");
      const fieldTelpAyah = document.getElementById("fieldTelpAyah");
      const fieldIbu      = document.getElementById("fieldIbu");
      const fieldTelpIbu  = document.getElementById("fieldTelpIbu");

      if (!profil) {
        // kombinasi NIS + status akademik tidak ditemukan
        if (fotoEl) fotoEl.src = "";
        fieldNama.textContent   = "-";
        fieldNIS.textContent    = nis;
        fieldNISN.textContent   = "-";
        fieldGender.textContent = "-";
        fieldTempat.textContent = "-";
        fieldTglLahir.textContent = "-";
        fieldJenjang.textContent  = jenjangFilter;
        fieldKelas.textContent    = kelasFilter;
        fieldParalel.textContent  = paralelFilter;
        fieldAlamat.textContent   = "-";
        fieldAyah.textContent     = "-";
        fieldTelpAyah.textContent = "-";
        fieldIbu.textContent      = "-";
        fieldTelpIbu.textContent  = "-";

        const trInfo = document.createElement("tr");
        trInfo.innerHTML = `<td colspan="3" class="label-left"><em>Data rapot belum tersedia untuk kombinasi NIS dan status akademik ini.</em></td>`;
        tbodyNilai.appendChild(trInfo);
        return;
      } else {
        if (fotoEl) fotoEl.src = profil.foto_url || "";
        fieldNama.textContent   = profil.nama_lengkap || "-";
        fieldNIS.textContent    = profil.nis || "-";
        fieldNISN.textContent   = profil.nisn || "-";
        fieldGender.textContent = profil.jenis_kelamin || "-";
        fieldTempat.textContent = profil.tempat_lahir || "-";
        fieldTglLahir.textContent = profil.tanggal_lahir || "-";
        fieldJenjang.textContent  = profil.jenjang || jenjangFilter;
        fieldKelas.textContent    = profil.kelas || kelasFilter;
        fieldParalel.textContent  = profil.paralel || paralelFilter;
        fieldAlamat.textContent   = profil.alamat || "-";
        fieldAyah.textContent     = profil.nama_ayah || "-";
        fieldTelpAyah.textContent = profil.telp_ayah || "-";
        fieldIbu.textContent      = profil.nama_ibu || "-";
        fieldTelpIbu.textContent  = profil.telp_ibu || "-";
      }

      // ====== 2. AKADEMIK (sama seperti sebelumnya, tapi pakai profil yg ini) ======
      const akademikMapel = [
        { label: "Al-Qur'an Hadits (Tafsir)", p: "nilai_tafsir_p", k: "nilai_tafsir_k" },
        { label: "Akidah Akhlak", p: "nilai_aqidah_akhlak_p", k: "nilai_aqidah_akhlak_k" },
        { label: "Fikih", p: "nilai_fiqih_p", k: "nilai_fiqih_k" },
        { label: "Sejarah Kebudayaan Islam", p: "nilai_ski_p", k: "nilai_ski_k" },
        { label: "Pendidikan Kewarganegaraan", p: "nilai_pkn_p", k: "nilai_pkn_k" },
        { label: "Bahasa Indonesia", p: "nilai_b_indonesia_p", k: "nilai_b_indonesia_k" },
        { label: "Bahasa Arab", p: "nilai_b_arab_p", k: "nilai_b_arab_k" },
        { label: "Matematika", p: "nilai_matematika_p", k: "nilai_matematika_k" },
        { label: "Sejarah Indonesia", p: "nilai_sejarah_indo_p", k: "nilai_sejarah_indo_k" },
        { label: "Bahasa Inggris", p: "nilai_b_inggris_p", k: "nilai_b_inggris_k" },
        { label: "Fisika", p: "nilai_fisika_p", k: "nilai_fisika_k" },
        { label: "Kimia", p: "nilai_kimia_p", k: "nilai_kimia_k" },
        { label: "Biologi", p: "nilai_biologi_p", k: "nilai_biologi_k" },
        { label: "Ekonomi", p: "nilai_ekonomi_p", k: "nilai_ekonomi_k" },
        { label: "Geografi", p: "nilai_geografi_p", k: "nilai_geografi_k" },
        { label: "Sosiologi", p: "nilai_sosiologi_p", k: "nilai_sosiologi_k" },
        { label: "Informatika", p: "nilai_informatika_p", k: "nilai_informatika_k" },
        { label: "Matematika Peminatan (IPA)", p: "nilai_mtk_ipa_p", k: "nilai_mtk_ipa_k" },
        { label: "Fisika Peminatan", p: "nilai_fisika_ipa_p", k: "nilai_fisika_ipa_k" },
        { label: "Kimia Peminatan", p: "nilai_kimia_ipa_p", k: "nilai_kimia_ipa_k" },
        { label: "Biologi Peminatan", p: "nilai_biologi_ipa_p", k: "nilai_biologi_ipa_k" },
        { label: "Sejarah Peminatan (IPS)", p: "nilai_sejarah_ips_p", k: "nilai_sejarah_ips_k" },
        { label: "Ekonomi Peminatan (IPS)", p: "nilai_ekonomi_ips_p", k: "nilai_ekonomi_ips_k" },
        { label: "Geografi Peminatan (IPS)", p: "nilai_geografi_ips_p", k: "nilai_geografi_ips_k" },
        { label: "Sosiologi Peminatan (IPS)", p: "nilai_sosiologi_ips_p", k: "nilai_sosiologi_ips_k" },
        { label: "Tafsir - Ilmu Tafsir", p: "nilai_ilmu_tafsir_p", k: "nilai_ilmu_tafsir_k" },
        { label: "Hadis - Ilmu Hadis", p: "nilai_ilmu_hadits_p", k: "nilai_ilmu_hadits_k" },
        { label: "Fiqih - Ushul Fiqih", p: "nilai_ushul_fiqih_p", k: "nilai_ushul_fiqih_k" },
        { label: "Bahasa Arab Peminatan (Balaghoh)", p: "nilai_balaghoh_p", k: "nilai_balaghoh_k" },
        { label: "Bahasa Inggris Tingkat Lanjut", p: "nilai_b_inggris_bhs_p", k: "nilai_b_inggris_bhs_k" },
        { label: "Nahwu (Qawaid)", p: "nilai_qowaid_p", k: "nilai_qowaid_k" },
        { label: "Hadits (Pesantren)", p: "nilai_hadits_p", k: "nilai_hadits_k" },
        { label: "Faroidh", p: "nilai_faroidh_p", k: "nilai_faroidh_k" },
        { label: "Bimbingan Konseling (BK)", p: "nilai_bk_p", k: "nilai_bk_k" }
      ];

      let punyaAkademik = false;
      akademikMapel.forEach(m => {
        const p = profil[m.p];
        const k = profil[m.k];
        if (p == null && k == null) return;
        punyaAkademik = true;
        const tr = document.createElement("tr");
        tr.innerHTML =
          `<td class="label-left">${m.label}</td>` +
          `<td>${p ?? ""}</td>` +
          `<td>${k ?? ""}</td>`;
        tbodyNilai.appendChild(tr);
      });

      if (!punyaAkademik) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="3" class="label-left"><em>Data nilai akademik belum tersedia.</em></td>`;
        tbodyNilai.appendChild(tr);
      }

      // ====== 3. TTQ ======
      const ttqPairs = [
        ["Hafalan Muqorror", "nilai_hafalan_muqorror", "Ujian Muqorror", "nilai_ujian_muqorror"],
        ["Hafalan Murojaah", "nilai_hafalan_murojaah", "Hafalan Ziyadah", "nilai_hafalan_ziyadah"],
        ["Ujian Ziyadah", "nilai_ujian_ziyadah", "", ""]
      ];

      let punyaTTQ = false;
      ttqPairs.forEach(([label1, key1, label2, key2]) => {
        const v1 = profil[key1];
        const v2 = key2 ? profil[key2] : null;
        if (v1 != null || v2 != null) punyaTTQ = true;

        const tr = document.createElement("tr");
        tr.innerHTML =
          `<td class="label-left">${label1}</td><td>${v1 ?? ""}</td>` +
          `<td class="label-left">${label2}</td><td>${v2 ?? ""}</td>`;
        tbodyHafalan.appendChild(tr);
      });

      if (!punyaTTQ) {
        tbodyHafalan.innerHTML = `<tr><td colspan="4" class="label-left"><em>Data TTQ belum tersedia.</em></td></tr>`;
      }

      // ====== 4. BAHASA ======
      const bahasaPairs = [
        ["Muhadhoroh", "nilai_muhadhoroh", "Speaking", "nilai_speaking"],
        ["Hiwar", "nilai_hiwar", "Conversation", "nilai_conversation"],
        ["Mufrodat", "nilai_mufrodat", "Vocabulary", "nilai_vocabulary"]
      ];

      let punyaBahasa = false;
      bahasaPairs.forEach(([label1, key1, label2, key2]) => {
        const v1 = profil[key1];
        const v2 = profil[key2];
        if (v1 != null || v2 != null) punyaBahasa = true;

        const tr = document.createElement("tr");
        tr.innerHTML =
          `<td class="label-left">${label1}</td><td>${v1 ?? ""}</td>` +
          `<td class="label-left">${label2}</td><td>${v2 ?? ""}</td>`;
        tbodyBahasa.appendChild(tr);
      });

      if (!punyaBahasa) {
        tbodyBahasa.innerHTML = `<tr><td colspan="4" class="label-left"><em>Data Bahasa belum tersedia.</em></td></tr>`;
      }

      // ====== 5. MUTABAAH ======
      const mutabaahFields = [
        ["Shalat Berjamaah", "nilai_shalat_berjamaah"],
        ["Shalat Rawatib", "nilai_shalat_rawatib"],
        ["Shalat Qiyamullail", "nilai_qiyamullail"],
        ["Shalat Dhuha", "nilai_shalat_dhuha"],
        ["Tilawah", "nilai_tilawah"],
        ["Matsurat", "nilai_matsurat"],
        ["Shaum Sunnah", "nilai_shaum_sunnah"],
        ["Olahraga", "nilai_olahraga"]
      ];

      let punyaMutabaah = false;
      mutabaahFields.forEach(([label, key]) => {
        const v = profil[key];
        if (v == null) return;
        punyaMutabaah = true;
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="label-left">${label}</td><td>${v}</td>`;
        tbodyMutabaah.appendChild(tr);
      });

      if (!punyaMutabaah) {
        tbodyMutabaah.innerHTML = `<tr><td colspan="2" class="label-left"><em>Data Mutabaah belum tersedia.</em></td></tr>`;
      }

      // ====== 6. PELANGGARAN ======
      const poin    = profil.poin_pelanggaran;
      const catatan = profil.catatan_pembinaan;

      if (poin == null && !catatan) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="2" class="label-left"><em>Belum ada data pelanggaran.</em></td>`;
        tbodyPelanggaran.appendChild(tr);
        totalPoinEl.textContent = "0";
      } else {
        const tr = document.createElement("tr");
        tr.innerHTML =
          `<td class="label-left">${catatan || "Pelanggaran (detail tidak diisi)"}</td>` +
          `<td>${poin ?? 0}</td>`;
        tbodyPelanggaran.appendChild(tr);
        totalPoinEl.textContent = poin ?? 0;
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      ["filterTahun","filterJenjang","filterKelas","filterParalel","filterSemester"]
        .forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.addEventListener("change", () => {
              updateStatusRingkasan();
              loadDataSantri();
            });
          }
        });

      updateStatusRingkasan();

      const session = getCurrentSession();
      if (session && session.expiresAt && session.expiresAt > Date.now()) {
        applySantriLoginUI();
        scheduleSantriAutoLogout();
        loadDataSantri();
      } else {
        clearSantriSession();
        applySantriLogoutUI();
      }
    });
  </script>

  <!-- html2pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
</body>
</html>
