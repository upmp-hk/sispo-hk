<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SISPO HK - Santri & Wali Santri</title>
  <link rel="stylesheet" href="sispo.css" />
  <style>
    :root {
      --blue: #1d4ed8;
      --blue-soft: #bfdbfe;
      --blue-soft2: #dbeafe;
      --green: #10b981;
      --green-soft: #bbf7d0;
      --green-soft2: #dcfce7;
      --white: #ffffff;
      --text: #000000;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #dbeafe, #dcfce7);
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 12px;
      color: var(--text);
    }
    .app-shell {
      width: 100%;
      max-width: 1280px;
      min-height: 620px;
      background: var(--white);
      border-radius: 18px;
      overflow: hidden;
      display: flex;
      box-shadow: 0 16px 40px rgba(0,0,0,0.2);
    }
    /* MAIN */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--white);
    }
    .main-header {
      padding: 12px 18px;
      border-bottom: 2px solid var(--blue-soft2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .main-header-left {
      display: flex;
      flex-direction: column;
    }
    .main-title {
      font-size: 17px;
      font-weight: 700;
    }
    .main-subtitle {
      font-size: 11px;
      opacity: 0.75;
    }
    .main-header-right {
      font-size: 11px;
      text-align: right;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--green);
      background: var(--green);
      color: var(--white);
      font-size: 11.5px;
    }
    .main-body {
      flex: 1;
      padding: 14px 18px 16px;
      background: linear-gradient(135deg, #ffffff, #eff6ff);
      overflow-y: auto;
    }
    /* LOGIN */
    .login-page {
      max-width: 420px;
      margin: 32px auto;
      background: var(--white);
      border-radius: 16px;
      border: 1px solid var(--blue-soft2);
      box-shadow: 0 12px 30px rgba(0,0,0,0.15);
      padding: 20px 18px 18px;
    }
    .login-header {
      text-align: center;
      margin-bottom: 16px;
    }
    .login-badge {
      display: inline-flex;
      padding: 3px 10px;
      border-radius: 999px;
      background: var(--green-soft);
      font-size: 11px;
      margin-bottom: 6px;
    }
    .login-title {
      font-size: 19px;
      font-weight: 700;
    }
    .login-subtitle {
      font-size: 12px;
      opacity: 0.75;
    }
    .login-form-group {
      text-align: left;
      margin-bottom: 12px;
      font-size: 13px;
    }
    .login-form-group label {
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
    }
    .login-form-group input {
      width: 100%;
      padding: 9px 11px;
      border-radius: 10px;
      border: 1px solid var(--blue-soft2);
      font-size: 13px;
      outline: none;
    }
    .login-form-group input:focus {
      border-color: var(--blue);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.35);
    }
    .password-wrapper {
      position: relative;
    }
    .password-wrapper input {
      padding-right: 80px;
    }
    .toggle-password {
      position: absolute;
      right: 9px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 11px;
      padding: 2px 4px;
    }
    .login-button {
      width: 100%;
      margin-top: 8px;
      padding: 10px 10px;
      border-radius: 999px;
      border: 1px solid var(--green);
      background: var(--green);
      color: var(--white);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .login-button:hover {
      background: #059669;
      border-color: #059669;
    }
    .login-error {
      margin-top: 8px;
      font-size: 12px;
      color: #b91c1c;
      min-height: 16px;
    }
    .login-footer {
      margin-top: 10px;
      font-size: 11px;
      text-align: center;
      opacity: 0.8;
    }
    /* RAPOT PAGE */
    .rapot-page {
      display: none;
      flex-direction: column;
      gap: 10px;
    }
    .rapot-header {
      margin-bottom: 6px;
    }
    .rapot-title {
      font-size: 17px;
      font-weight: 700;
    }
    .rapot-subtitle {
      font-size: 11px;
      opacity: 0.75;
    }
    .profile {
      display: grid;
      grid-template-columns: minmax(220px, 0.9fr) minmax(260px, 1.3fr) minmax(220px, 0.9fr);
      gap: 14px;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    @media (max-width: 1024px) {
      .profile {
        grid-template-columns: minmax(220px, 0.9fr) minmax(260px, 1.1fr);
      }
      .academic-status { grid-column: 1 / -1; }
    }
    @media (max-width: 780px) {
      .profile { grid-template-columns: 1fr; }
    }
    .profile-photo {
      background: var(--blue-soft2);
      border-radius: 14px;
      padding: 10px;
      text-align: center;
    }
    .profile-photo img {
      width: 100%;
      border-radius: 12px;
      object-fit: cover;
      border: 2px solid var(--white);
      box-shadow: 0 8px 20px rgba(0,0,0,0.25);
    }
    .photo-label {
      margin-top: 7px;
      font-size: 12px;
      opacity: 0.85;
    }
    .profile-data {
      border-radius: 14px;
      border: 1px solid var(--blue-soft2);
      padding: 10px 12px;
      background: var(--white);
    }
    .profile-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12.5px;
    }
    .profile-table td {
      padding: 3px 4px;
      vertical-align: top;
    }
    .profile-table td.label {
      width: 130px;
      font-weight: 600;
    }
    .profile-table td.sep {
      width: 8px;
    }
    .academic-status {
      border-radius: 14px;
      border: 1px solid var(--green-soft);
      padding: 10px 11px;
      background: linear-gradient(180deg, var(--green-soft2), var(--white));
      font-size: 11.5px;
    }
    .academic-status-title {
      font-weight: 700;
      font-size: 12.5px;
      margin-bottom: 6px;
      text-align: center;
    }
    .academic-status .field-row {
      display: flex;
      flex-direction: column;
      margin-bottom: 5px;
    }
    .academic-status label {
      font-size: 10.5px;
      margin-bottom: 2px;
    }
    .academic-status select {
      width: 100%;
      padding: 4px 6px;
      border-radius: 999px;
      border: 1px solid var(--blue-soft2);
      font-size: 11.5px;
      background: var(--white);
      outline: none;
    }
    .academic-status select:focus {
      border-color: var(--blue);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.35);
    }
    .academic-status-info {
      margin-top: 6px;
      font-size: 10px;
      text-align: center;
    }
    .academic-status-info span {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--blue-soft);
      margin: 2px 2px 0 0;
    }
    .semester-info {
      font-size: 11.5px;
      margin-bottom: 6px;
      padding: 5px 10px;
      border-radius: 999px;
      background: var(--green-soft2);
      display: inline-block;
    }
    .data-layout {
      display: grid;
      grid-template-columns: minmax(320px, 1.1fr) minmax(320px, 1fr);
      gap: 12px;
    }
    @media (max-width: 960px) {
      .data-layout { grid-template-columns: 1fr; }
    }
    .card {
      background: var(--white);
      border-radius: 14px;
      padding: 10px 11px 9px;
      border: 1px solid var(--blue-soft2);
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
    }
    .card-title {
      font-size: 13.5px;
      font-weight: 700;
      margin-bottom: 7px;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }
    .card-title small {
      font-size: 11px;
      font-weight: 400;
      opacity: 0.85;
    }
    .card-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11.5px;
    }
    .card-table th,
    .card-table td {
      border: 1px solid var(--blue-soft2);
      padding: 4px 5px;
      text-align: center;
    }
    .card-table th {
      background: var(--blue-soft2);
      font-weight: 600;
    }
    .card-table td.label-left {
      text-align: left;
    }
    .table-4col th,
    .table-4col td {
      width: 25%;
    }
    .card-footer {
      margin-top: 5px;
      font-size: 10.5px;
      opacity: 0.85;
    }
    .col-right {
      display: flex;
      flex-direction: column;
      gap: 9px;
    }
    .actions {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    .btn {
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--blue);
      background: var(--blue);
      color: var(--white);
      font-size: 11.5px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    .btn.secondary {
      border-color: var(--green);
      background: var(--green);
    }
    .btn:hover { opacity: 0.92; }
    @media print {
      .no-print { display: none !important; }
      body {
        background: var(--white);
        padding: 0;
      }
      .app-shell {
        box-shadow: none;
        border-radius: 0;
      }
      .sidebar { display: none; }
      .main-header { border-bottom: 1px solid #000; }
    }
    .header-logout-btn {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--blue);
      background: var(--white);
      font-size: 11px;
      cursor: pointer;
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- SIDEBAR -->
    <aside class="sidebar no-print">
      <div class="sidebar-header">
        <div class="logo-box">
          <img src="https://uploads.onecompiler.io/444e96suz/444e96fm2/cropped-00_Logo-HK-Utama.webp" alt="Logo HK">
        </div>
        <div class="sidebar-title">
          <strong>SISPO HK</strong>
          <span>Sistem Informasi Santri</span>
        </div>
      </div>

      <div class="sidebar-nav">
        <div class="nav-section-title">Mode Akses</div>

        <!-- Santri (aktif) -->
        <div class="nav-item active">
          <span>Santri & Wali Santri</span>
          <span class="nav-tag">Rapot</span>
        </div>

        <!-- Guru -->
        <div class="nav-item">
          <a href="guru.html">
            <span>Guru</span>
            <span class="nav-tag">Akademik</span>
          </a>
        </div>

        <!-- Musyrif -->
        <div class="nav-item">
          <a href="musyrif.html">
            <span>Musyrif</span>
            <span class="nav-tag">TTQ</span>
          </a>
        </div>

        <!-- Murobbi -->
        <div class="nav-item">
          <a href="murobbi.html">
            <span>Murobbi</span>
            <span class="nav-tag">Mutabaah</span>
          </a>
        </div>

        <!-- Bahasa -->
        <div class="nav-item">
          <a href="bahasa.html">
            <span>Bahasa</span>
            <span class="nav-tag">Arab &amp; Inggris</span>
          </a>
        </div>

        <!-- Pengasuhan -->
        <div class="nav-item">
          <a href="pengasuhan.html">
            <span>Pengasuhan</span>
            <span class="nav-tag">Poin Pelanggaran</span>
          </a>
        </div>

        <!-- Admin -->
        <div class="nav-item">
          <a href="admin.html">
            <span>Admin</span>
            <span class="nav-tag">Data Profil</span>
          </a>
        </div>
      </div>

      <div class="sidebar-footer">
        Pontren Husnul Khotimah
        <span>Dashboard Rapot Terintegrasi</span>
      </div>
    </aside>

    <!-- MAIN -->
    <div class="main">
      <header class="main-header no-print">
        <div class="main-header-left">
          <div class="main-title">Sistem Informasi Santri Pontren Husnul Khotimah</div>
          <div class="main-subtitle">
            Antarmuka Rapot Santri, TTQ, Bahasa, Mutabaah, dan Poin Pelanggaran dalam satu layar.
          </div>
        </div>
        <div class="main-header-right">
          Mode: <span>Santri &amp; Wali Santri</span>
          <span class="badge" id="statusBadge">Login diperlukan</span>
          <button type="button"
                  id="logoutSantriBtn"
                  class="btn"
                  onclick="handleLogoutSantri()"
                  style="display:none;">
            Logout
          </button>
        </div>
      </header>

      <main class="main-body">
        <!-- LOGIN -->
        <div id="loginContainer" class="login-page no-print">
          <div class="login-header">
            <div class="login-badge">ðŸ”‘ Login</div>
            <div class="login-title">Santri & Wali Santri</div>
            <div class="login-subtitle">
              Masukkan email dan password yang terdaftar untuk melihat Rapot Santri.
            </div>
          </div>

          <form id="loginForm" onsubmit="handleLoginSantri(event)">
            <div class="login-form-group">
              <label for="loginUsername">Email Santri/Wali</label>
              <input type="text" id="loginUsername" placeholder="nama@domain.com" autocomplete="username" />
            </div>
            <div class="login-form-group">
              <label for="loginPassword">Password</label>
              <div class="password-wrapper">
                <input type="password" id="loginPassword" placeholder="password" autocomplete="current-password" />
                <button 
                  type="button" 
                  class="toggle-password" 
                  data-target="loginPassword" 
                  onclick="togglePassword(this)">
                  Show
                </button>
              </div>
            </div>
            <button type="submit" class="login-button">Masuk</button>
          </form>

          <div id="loginError" class="login-error"></div>

          <div class="login-footer">
            Akun santri & wali dikelola melalui dashboard Supabase.
          </div>
        </div>

        <!-- RAPOT -->
        <div class="rapot-page" id="rapotContainer">
          <div class="rapot-header">
            <div class="rapot-title">Rapot Santri</div>
            <div class="rapot-subtitle">
              Tampilan portofolio nilai, Rapot TTQ, Rapot Bahasa Asing, Mutabaah Yaumiyyah, dan Rapot Pelanggaran (Tata Tertib).
            </div>
          </div>

          <!-- PROFIL -->
          <section class="profile">
            <!-- FOTO -->
            <div class="profile-photo">
              <img src="https://uploads.onecompiler.io/444e96suz/444e96fm2/Bio%20Royyan%20Rusnandi%20OPK_4808%20copy.jpg" alt="Foto Santri">
              <div class="photo-label">Foto Santri</div>
            </div>

            <!-- IDENTITAS -->
            <div class="profile-data">
              <table class="profile-table">
                <tr>
                  <td class="label">Nama</td><td class="sep">:</td>
                  <td id="fieldNama">Ahmad Husnul Karim</td>
                </tr>
                <tr>
                  <td class="label">NIS</td><td class="sep">:</td>
                  <td id="fieldNIS">2023.001234</td>
                </tr>
                <tr>
                  <td class="label">NISN</td><td class="sep">:</td>
                  <td id="fieldNISN">1234567890</td>
                </tr>
                <tr>
                  <td class="label">Jenis Kelamin</td><td class="sep">:</td>
                  <td id="fieldGender">Ikhwan</td>
                </tr>
                <tr>
                  <td class="label">Tempat Lahir</td><td class="sep">:</td>
                  <td id="fieldTempat">Kuningan</td>
                </tr>
                <tr>
                  <td class="label">Tanggal Lahir</td><td class="sep">:</td>
                  <td id="fieldTglLahir">15 Agustus 2008</td>
                </tr>
                <tr>
                  <td class="label">Jenjang</td><td class="sep">:</td>
                  <td id="fieldJenjang">MA</td>
                </tr>
                <tr>
                  <td class="label">Kelas</td><td class="sep">:</td>
                  <td id="fieldKelas">XI</td>
                </tr>
                <tr>
                  <td class="label">Paralel/Rombel</td><td class="sep">:</td>
                  <td id="fieldParalel">A</td>
                </tr>
                <tr>
                  <td class="label">Asrama</td><td class="sep">:</td>
                  <td id="fieldAsrama">Utsman Bin Affan</td>
                </tr>
                <tr>
                  <td class="label">Alamat</td><td class="sep">:</td>
                  <td id="fieldAlamat">Desa X, Kecamatan Y, Kabupaten Kuningan</td>
                </tr>
                <tr>
                  <td class="label">Nama Ayah</td><td class="sep">:</td>
                  <td id="fieldAyah">Abdullah</td>
                </tr>
                <tr>
                  <td class="label">No. Telp. Ayah</td><td class="sep">:</td>
                  <td id="fieldTelpAyah">0812-3456-7890</td>
                </tr>
                <tr>
                  <td class="label">Nama Ibu</td><td class="sep">:</td>
                  <td id="fieldIbu">Fatimah</td>
                </tr>
                <tr>
                  <td class="label">No. Telp. Ibu</td><td class="sep">:</td>
                  <td id="fieldTelpIbu">0813-9876-5432</td>
                </tr>
              </table>
            </div>

            <!-- STATUS AKADEMIK -->
            <div class="academic-status no-print">
              <div class="academic-status-title">Status Akademik</div>

              <!-- 1. Tahun Ajaran -->
              <div class="field-row">
                <label for="filterTahun">Tahun Ajaran</label>
                <select id="filterTahun">
                  <option value="2023_2024">2023/2024</option>
                  <option value="2024_2025" selected>2024/2025</option>
                  <option value="2025_2026">2025/2026</option>
                </select>
              </div>

              <!-- 2. Semester -->
              <div class="field-row">
                <label for="filterSemester">Semester (1/2)</label>
                <select id="filterSemester">
                  <option value="1" selected>1</option>
                  <option value="2">2</option>
                </select>
              </div>

              <!-- 3. Jenjang -->
              <div class="field-row">
                <label for="filterJenjang">Jenjang</label>
                <select id="filterJenjang">
                  <option value="MTs (HK1)">MTs (HK1)</option>
                  <option value="MTs (HK2)">MTs (HK2)</option>
                  <option value="MA" selected>MA</option>
                </select>
              </div>

              <!-- 4. Kelas -->
              <div class="field-row">
                <label for="filterKelas">Kelas (VIIâ€“XII)</label>
                <select id="filterKelas">
                  <option value="VII">VII</option>
                  <option value="VIII">VIII</option>
                  <option value="IX">IX</option>
                  <option value="X">X</option>
                  <option value="XI" selected>XI</option>
                  <option value="XII">XII</option>
                </select>
              </div>

              <!-- 5. Paralel / Rombel -->
              <div class="field-row">
                <label for="filterParalel">Paralel / Rombel</label>
                <select id="filterParalel">
                  <!-- A-Z -->
                  <option value="A">A</option>
                  <option value="B">B</option>
                  <option value="C">C</option>
                  <option value="D">D</option>
                  <option value="E">E</option>
                  <option value="F">F</option>
                  <option value="G">G</option>
                  <option value="H">H</option>
                  <option value="I">I</option>
                  <option value="J">J</option>
                  <option value="K">K</option>
                  <option value="L">L</option>
                  <option value="M">M</option>
                  <option value="N">N</option>
                  <option value="O">O</option>
                  <option value="P">P</option>
                  <option value="Q">Q</option>
                  <option value="R">R</option>
                  <option value="S">S</option>
                  <option value="T">T</option>
                  <option value="U">U</option>
                  <option value="V">V</option>
                  <option value="W">W</option>
                  <option value="X">X</option>
                  <option value="Y">Y</option>
                  <option value="Z">Z</option>
                  <!-- IPA -->
                  <option value="IPA 1">IPA 1</option>
                  <option value="IPA 2">IPA 2</option>
                  <option value="IPA 3">IPA 3</option>
                  <option value="IPA 4">IPA 4</option>
                  <option value="IPA 5">IPA 5</option>
                  <option value="IPA 6">IPA 6</option>
                  <option value="IPA 7">IPA 7</option>
                  <option value="IPA 8">IPA 8</option>
                  <option value="IPA 9">IPA 9</option>
                  <option value="IPA 10">IPA 10</option>
                  <option value="IPA 11">IPA 11</option>
                  <option value="IPA 12">IPA 12</option>
                  <option value="IPA 13">IPA 13</option>
                  <option value="IPA 14">IPA 14</option>
                  <option value="IPA 15">IPA 15</option>
                  <!-- IPS -->
                  <option value="IPS 1">IPS 1</option>
                  <option value="IPS 2">IPS 2</option>
                  <option value="IPS 3">IPS 3</option>
                  <option value="IPS 4">IPS 4</option>
                  <option value="IPS 5">IPS 5</option>
                  <option value="IPS 6">IPS 6</option>
                  <option value="IPS 7">IPS 7</option>
                  <option value="IPS 8">IPS 8</option>
                  <option value="IPS 9">IPS 9</option>
                  <option value="IPS 10">IPS 10</option>
                  <!-- PK -->
                  <option value="PK 1">PK 1</option>
                  <option value="PK 2">PK 2</option>
                  <option value="PK 3">PK 3</option>
                  <option value="PK 4">PK 4</option>
                  <option value="PK 5">PK 5</option>
                  <option value="PK 6">PK 6</option>
                  <option value="PK 7">PK 7</option>
                  <option value="PK 8">PK 8</option>
                  <option value="PK 9">PK 9</option>
                  <option value="PK 10">PK 10</option>
                </select>
              </div>

              <!-- 6. Jenis Kelamin -->
              <div class="field-row">
                <label for="filterGender">Jenis Kelamin</label>
                <select id="filterGender">
                  <option value="Ikhwan" selected>Ikhwan</option>
                  <option value="Akhwat">Akhwat</option>
                </select>
              </div>

              <!-- 7. Asrama -->
              <div class="field-row">
                <label for="filterAsrama">Asrama</label>
                <select id="filterAsrama">
                  <option value="Ali Bin Abi Thalib">Ali Bin Abi Thalib</option>
                  <option value="Utsman Bin Affan" selected>Utsman Bin Affan</option>
                  <option value="Umar Bin Khattab">Umar Bin Khattab</option>
                  <option value="Abu Bakar Ash Shiddiq">Abu Bakar Ash Shiddiq</option>
                  <option value="Fathimah Az Zahra">Fathimah Az Zahra</option>
                  <option value="Asma Binti Abu Bakar">Asma Binti Abu Bakar</option>
                  <option value="Aisyah Binti Abu Bakar">Aisyah Binti Abu Bakar</option>
                  <option value="Ummu Kultsum binti Rasulullah SAW">Ummu Kultsum binti Rasulullah SAW</option>
                  <option value="Hafshoh binti Umar bin Khattab">Hafshoh binti Umar bin Khattab</option>
                  <option value="Khodijah">Khodijah</option>
                </select>
              </div>

              <div class="academic-status-info" id="statusRingkasan"></div>
            </div>
          </section>

          <div class="semester-info">
            Menampilkan: TA <span id="labelTahun">2024/2025</span>,
            Jenjang <span id="labelJenjangInfo">MA</span>,
            Kelas <span id="labelKelasInfo">XI</span>,
            Paralel <span id="labelParalelInfo">A</span>,
            Semester <span id="labelSemester">1</span>.
          </div>

          <!-- DATA RAPOT -->
          <section class="data-layout">
            <!-- KIRI: AKADEMIK -->
            <div class="col-left">
              <div class="card">
                <div class="card-title">
                  <span>Rapot Akademik</span>
                  <small>TA <span id="miniTahun1">2024/2025</span> &mdash; Sem <span id="miniSem1">1</span></small>
                </div>
                <table class="card-table" id="tabelNilai">
                  <thead>
                    <tr>
                      <th>Mapel</th>
                      <th>Pengetahuan</th>
                      <th>Keterampilan</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
                <div class="card-footer">
                  *Daftar mapel mengikuti struktur kurikulum Pontren Husnul Khotimah (data simulasi).
                </div>
              </div>
            </div>

            <!-- KANAN: TTQ, BAHASA, MUTABAAH, PELANGGARAN -->
            <div class="col-right">
              <div class="card">
                <div class="card-title">
                  <span>Rapot Tahsin dan Tahfidz Qur'an (TTQ)</span>
                  <small>TA <span id="miniTahun2">2024/2025</span> &mdash; Sem <span id="miniSem2">1</span></small>
                </div>
                <table class="card-table table-4col" id="tabelHafalan">
                  <thead>
                    <tr>
                      <th>Komponen</th>
                      <th>Nilai</th>
                      <th>Komponen</th>
                      <th>Nilai</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
                <div class="card-footer">
                  *Meliputi Hafalan Muqorror, Ujian Muqorror, Hafalan Murojaah, Hafalan Ziyadah, Ujian Ziyadah.
                </div>
              </div>

              <div class="card">
                <div class="card-title">
                  <span>Rapot Bahasa Asing (Arab dan Inggris)</span>
                  <small>TA <span id="miniTahun4">2024/2025</span> &mdash; Sem <span id="miniSem4">1</span></small>
                </div>
                <table class="card-table table-4col" id="tabelBahasa">
                  <thead>
                    <tr>
                      <th>Aspek</th>
                      <th>Nilai</th>
                      <th>Aspek</th>
                      <th>Nilai</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
                <div class="card-footer">
                  *Muhadhoroh &mdash; Speaking, Hiwar &mdash; Conversation, Mufrodat &mdash; Vocabulary.
                </div>
              </div>

              <div class="card">
                <div class="card-title">
                  <span>Rapot Mutabaah Yaumiyyah</span>
                  <small>TA <span id="miniTahun5">2024/2025</span> &mdash; Sem <span id="miniSem5">1</span></small>
                </div>
                <table class="card-table" id="tabelMutabaah">
                  <thead>
                    <tr>
                      <th>Amalan</th>
                      <th>Nilai</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
                <div class="card-footer">
                  *Shalat berjamaah, rawatib, qiyamullail, dhuha, tilawah, matsurat, shaum sunnah, olahraga.
                </div>
              </div>

              <div class="card">
                <div class="card-title">
                  <span>Rapot Pelanggaran (Tata Tertib)</span>
                  <small>TA <span id="miniTahun3">2024/2025</span> &mdash; Sem <span id="miniSem3">1</span></small>
                </div>
                <table class="card-table" id="tabelPelanggaran">
                  <thead>
                    <tr>
                      <th>Jenis Pelanggaran</th>
                      <th>Jumlah Poin</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                  <tfoot>
                    <tr>
                      <th>Total Poin</th>
                      <th id="totalPoin">0</th>
                    </tr>
                  </tfoot>
                </table>
                <div class="card-footer">
                  *Akumulasi poin pelanggaran pada semester terpilih (data simulasi).
                </div>
              </div>
            </div>
          </section>

          <!-- TOMBOL CETAK -->
          <div class="actions no-print">
            <button class="btn secondary" onclick="window.print()">ðŸ–¨ Cetak Rapot</button>
            <button class="btn" onclick="exportPDF()">ðŸ“„ Export PDF</button>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const { createClient } = supabase;

    const SUPABASE_URL = 'https://esravodnlmwstdtudism.supabase.co';
    const SUPABASE_ANON_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzcmF2b2RubG13c3RkdHVkaXNtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4NDE1ODUsImV4cCI6MjA3OTQxNzU4NX0.rWxlzueSdUvd6Vc6VKaGwZv47djT-3HvyhgfI3BpxAY';

    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <!-- html2pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <script>
    // KONSTAN DATA DEMO PROFIL (sementara masih dummy)
    const DEMO_NIS  = "2023.001234";
    const DEMO_NISN = "1234567890";

    // SESSION LOGIN SANTRI/WALI â€“ 5 MENIT (selaras mode lain)
    const SANTRI_SESSION_KEY = "sispo_santri_session";
    const SESSION_DURATION_MS = 5 * 60 * 1000;
    let santriLogoutTimer = null;

    // LOGIN via SUPABASE AUTH + user_roles.mode = 'santri'
    async function handleLoginSantri(event) {
      event.preventDefault();
      const email = document.getElementById("loginUsername").value.trim();
      const pass  = document.getElementById("loginPassword").value.trim();
      const errorEl = document.getElementById("loginError");

      if (!email || !pass) {
        errorEl.textContent = "Email dan password wajib diisi.";
        return;
      }

      const { data, error } = await db.auth.signInWithPassword({
        email,
        password: pass
      });

      if (error) {
        console.error(error);
        errorEl.textContent = "Login gagal. Periksa kembali email dan password.";
        return;
      }

      // cek role di tabel user_roles
      const { data: roleData, error: roleError } = await db
        .from("user_roles")
        .select("mode")
        .eq("id", data.user.id)
        .single();

      if (roleError || !roleData) {
        console.error(roleError);
        errorEl.textContent = "Role pengguna tidak ditemukan.";
        await db.auth.signOut();
        return;
      }

      // sesuaikan nilai 'santri' ini dengan yang Tim buat di user_roles
      if (roleData.mode !== "santri") {
        errorEl.textContent = "Akun ini bukan akun Santri/Wali.";
        await db.auth.signOut();
        return;
      }

      errorEl.textContent = "";
      setSantriSession();
      applySantriLoginUI();
      scheduleSantriAutoLogout();

      // di tahap berikutnya, di sini bisa ditambahkan fetch rapot dari Supabase
    }

    function applySantriLoginUI() {
      document.getElementById("loginContainer").style.display = "none";
      document.getElementById("rapotContainer").style.display = "flex";
      document.getElementById("statusBadge").textContent = "Login";
      const btn = document.getElementById("logoutSantriBtn");
      if (btn) btn.style.display = "inline-block";
    }

    function applySantriLogoutUI() {
      document.getElementById("loginContainer").style.display = "block";
      document.getElementById("rapotContainer").style.display = "none";
      document.getElementById("statusBadge").textContent = "Login diperlukan";
      const btn = document.getElementById("logoutSantriBtn");
      if (btn) btn.style.display = "none";
    }

    function setSantriSession() {
      const expiresAt = Date.now() + SESSION_DURATION_MS;
      localStorage.setItem(SANTRI_SESSION_KEY, JSON.stringify({ expiresAt }));
    }

    function clearSantriSession() {
      localStorage.removeItem(SANTRI_SESSION_KEY);
      if (santriLogoutTimer) {
        clearTimeout(santriLogoutTimer);
        santriLogoutTimer = null;
      }
    }

    function scheduleSantriAutoLogout() {
      const raw = localStorage.getItem(SANTRI_SESSION_KEY);
      if (!raw) return;

      try {
        const { expiresAt } = JSON.parse(raw);
        const remaining = expiresAt - Date.now();
        if (remaining <= 0) {
          handleLogoutSantri();
        } else {
          if (santriLogoutTimer) clearTimeout(santriLogoutTimer);
          santriLogoutTimer = setTimeout(handleLogoutSantri, remaining);
        }
      } catch (e) {
        handleLogoutSantri();
      }
    }

    async function handleLogoutSantri() {
      try {
        await db.auth.signOut();
      } catch (e) {
        console.error(e);
      }
      clearSantriSession();
      applySantriLogoutUI();

      const form = document.getElementById("loginForm");
      if (form) form.reset();
      const errorEl = document.getElementById("loginError");
      if (errorEl) errorEl.textContent = "";
    }

    // Restore session bila masih valid (berbasis localStorage, sama seperti mode lain)
    document.addEventListener("DOMContentLoaded", function () {
      const raw = localStorage.getItem(SANTRI_SESSION_KEY);
      if (raw) {
        try {
          const { expiresAt } = JSON.parse(raw);
          if (expiresAt && expiresAt > Date.now()) {
            applySantriLoginUI();
            scheduleSantriAutoLogout();
          } else {
            clearSantriSession();
            applySantriLogoutUI();
          }
        } catch (e) {
          clearSantriSession();
          applySantriLogoutUI();
        }
      } else {
        applySantriLogoutUI();
      }
    });

    function togglePassword(btn) {
      const targetId = btn.getAttribute("data-target");
      const input = document.getElementById(targetId);
      if (!input) return;

      if (input.type === "password") {
        input.type = "text";
        btn.textContent = "Hide";
      } else {
        input.type = "password";
        btn.textContent = "Show";
      }
    }

    // DATA SIMULASI RAPOT (sementara belum tarik dari Supabase)
    const MAPEL_AKADEMIK = [
      "Al-Qur'an Hadits (Tafsir)",
      "Akidah Akhlak",
      "Fikih",
      "Sejarah Kebudayaan Islam",
      "Pendidikan Kewarganegaraan",
      "Bahasa Indonesia",
      "Bahasa Arab",
      "Matematika",
      "Sejarah Indonesia",
      "Bahasa Inggris",
      "Fisika",
      "Kimia",
      "Biologi",
      "Ekonomi",
      "Geografi",
      "Sosiologi",
      "Informatika",
      "Matematika Peminatan (IPA)",
      "Fisika Peminatan",
      "Kimia Peminatan",
      "Biologi Peminatan",
      "Sejarah Peminatan",
      "Ekonomi Peminatan",
      "Geografi Peminatan",
      "Sosiologi Peminatan",
      "Tafsir - Ilmu Tafsir",
      "Hadis - Ilmu Hadis",
      "Fiqih - Ushul Fiqih",
      "Bahasa Arab Peminatan (Balaghoh)",
      "Tahfidz Al-Qur'an",
      "Bahasa Inggris Tingkat Lanjut",
      "Nahwu (Qawaid)",
      "Hadits (Pesantren)",
      "Faroidh",
      "Bimbingan Konseling (BK)"
    ];

    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function generateDummyData(tahun, jenjang, kelas, paralel, semester) {
      const nilai = MAPEL_AKADEMIK.map(nama => ({
        mapel: nama,
        pengetahuan: randInt(70, 95),
        keterampilan: randInt(70, 95)
      }));

      const hafalan = {
        muqorror: randInt(70, 95),
        murojaah: randInt(70, 95),
        ujianMuqorror: randInt(70, 95),
        ziyadah: randInt(70, 95),
        ujianZiyadah: randInt(70, 95)
      };

      const semuaPelanggaran = [
        "Terlambat Shalat Jamaah",
        "Tidak Ikut Muhadharah",
        "Tidak Mengisi Mutabaah",
        "Tidak Izin Keluar Asrama"
      ];
      const jumlahPelanggaran = randInt(1, 3);
      const pelanggaran = [];
      for (let i = 0; i < jumlahPelanggaran; i++) {
        const jenis = semuaPelanggaran[i];
        pelanggaran.push({ jenis, poin: randInt(2, 10) });
      }

      const bahasa = {
        muhadhoroh: randInt(70, 95),
        speaking: randInt(70, 95),
        hiwar: randInt(70, 95),
        conversation: randInt(70, 95),
        mufrodat: randInt(70, 95),
        vocabulary: randInt(70, 95)
      };

      const mutabaah = {
        berjamaah: randInt(70, 100),
        rawatib: randInt(60, 100),
        qiyamullail: randInt(50, 100),
        dhuha: randInt(60, 100),
        tilawah: randInt(70, 100),
        matsurat: randInt(60, 100),
        shaumSunnah: randInt(50, 100),
        olahraga: randInt(60, 100)
      };

      return { nilai, hafalan, pelanggaran, bahasa, mutabaah };
    }

    function updateStatusRingkasan() {
      const tahun = document.getElementById("filterTahun").value;
      const jenjang = document.getElementById("filterJenjang").value;
      const kelas = document.getElementById("filterKelas").value;
      const paralel = document.getElementById("filterParalel").value;
      const semester = document.getElementById("filterSemester").value;
      const gender = document.getElementById("filterGender").value;
      const asrama = document.getElementById("filterAsrama").value;

      const statusEl = document.getElementById("statusRingkasan");
      statusEl.innerHTML = `
        <span>${tahun.replace("_", "/")}</span>
        <span>Semester ${semester}</span>
        <span>${jenjang}</span>
        <span>Kelas ${kelas}</span>
        <span>Paralel/Rombel ${paralel}</span>
        <span>${gender}</span>
        <span>${asrama}</span>
      `;

      document.getElementById("labelTahun").textContent = tahun.replace("_", "/");
      document.getElementById("labelJenjangInfo").textContent = jenjang;
      document.getElementById("labelKelasInfo").textContent = kelas;
      document.getElementById("labelParalelInfo").textContent = paralel;
      document.getElementById("labelSemester").textContent = semester;

      ["miniTahun1","miniTahun2","miniTahun3","miniTahun4","miniTahun5"].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.textContent = tahun.replace("_","/");
      });
      ["miniSem1","miniSem2","miniSem3","miniSem4","miniSem5"].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.textContent = semester;
      });
    }

    function loadDataSantri() {
      const tahun = document.getElementById("filterTahun").value;
      const jenjang = document.getElementById("filterJenjang").value;
      const kelas = document.getElementById("filterKelas").value;
      const paralel = document.getElementById("filterParalel").value;
      const semester = document.getElementById("filterSemester").value;
      const genderSelected = document.getElementById("filterGender").value;
      const asramaSelected = document.getElementById("filterAsrama").value;

      const fieldNama = document.getElementById("fieldNama");
      const fieldNIS = document.getElementById("fieldNIS");
      const fieldNISN = document.getElementById("fieldNISN");
      const fieldGender = document.getElementById("fieldGender");
      const fieldTempat = document.getElementById("fieldTempat");
      const fieldTglLahir = document.getElementById("fieldTglLahir");
      const fieldJenjang = document.getElementById("fieldJenjang");
      const fieldKelas = document.getElementById("fieldKelas");
      const fieldParalel = document.getElementById("fieldParalel");
      const fieldAsrama = document.getElementById("fieldAsrama");
      const fieldAlamat = document.getElementById("fieldAlamat");
      const fieldAyah = document.getElementById("fieldAyah");
      const fieldTelpAyah = document.getElementById("fieldTelpAyah");
      const fieldIbu = document.getElementById("fieldIbu");
      const fieldTelpIbu = document.getElementById("fieldTelpIbu");

      const tbodyNilai = document.querySelector("#tabelNilai tbody");
      const tbodyHafalan = document.querySelector("#tabelHafalan tbody");
      const tbodyPelanggaran = document.querySelector("#tabelPelanggaran tbody");
      const tbodyBahasa = document.querySelector("#tabelBahasa tbody");
      const tbodyMutabaah = document.querySelector("#tabelMutabaah tbody");
      const totalPoinEl = document.getElementById("totalPoin");

      tbodyNilai.innerHTML = "";
      tbodyHafalan.innerHTML = "";
      tbodyPelanggaran.innerHTML = "";
      tbodyBahasa.innerHTML = "";
      tbodyMutabaah.innerHTML = "";
      totalPoinEl.textContent = "0";

      // identitas contoh (nantinya bisa diisi dari Supabase)
      fieldNama.textContent = "Ahmad Husnul Karim";
      fieldNIS.textContent = DEMO_NIS;
      fieldNISN.textContent = DEMO_NISN;
      fieldGender.textContent = genderSelected;
      fieldTempat.textContent = "Kuningan";
      fieldTglLahir.textContent = "15 Agustus 2008";
      fieldJenjang.textContent = jenjang;
      fieldKelas.textContent = kelas;
      fieldParalel.textContent = paralel;
      fieldAsrama.textContent = asramaSelected;
      fieldAlamat.textContent = "Desa X, Kecamatan Y, Kabupaten Kuningan";
      fieldAyah.textContent = "Abdullah";
      fieldTelpAyah.textContent = "0812-3456-7890";
      fieldIbu.textContent = "Fatimah";
      fieldTelpIbu.textContent = "0813-9876-5432";

      const semData = generateDummyData(tahun, jenjang, kelas, paralel, semester);

      // Akademik
      semData.nilai.forEach(n => {
        const tr = document.createElement("tr");
        tr.innerHTML =
          `<td class="label-left">${n.mapel}</td>` +
          `<td>${n.pengetahuan}</td>` +
          `<td>${n.keterampilan}</td>`;
        tbodyNilai.appendChild(tr);
      });

      // TTQ
      const h = semData.hafalan;
      const ttqPairs = [
        ["Hafalan Muqorror", h.muqorror, "Hafalan Ziyadah", h.ziyadah],
        ["Ujian Muqorror", h.ujianMuqorror, "Ujian Ziyadah", h.ujianZiyadah],
        ["Hafalan Murojaah", h.murojaah, "", ""]
      ];
      ttqPairs.forEach(([c1, v1, c2, v2]) => {
        const tr = document.createElement("tr");
        tr.innerHTML =
          `<td class="label-left">${c1}</td><td>${v1}</td>` +
          `<td class="label-left">${c2}</td><td>${v2}</td>`;
        tbodyHafalan.appendChild(tr);
      });

      // Bahasa
      const b = semData.bahasa;
      const pasanganBahasa = [
        ["Muhadhoroh", b.muhadhoroh, "Speaking", b.speaking],
        ["Hiwar", b.hiwar, "Conversation", b.conversation],
        ["Mufrodat", b.mufrodat, "Vocabulary", b.vocabulary]
      ];
      pasanganBahasa.forEach(([a1, n1, a2, n2]) => {
        const tr = document.createElement("tr");
        tr.innerHTML =
          `<td class="label-left">${a1}</td><td>${n1}</td>` +
          `<td class="label-left">${a2}</td><td>${n2}</td>`;
        tbodyBahasa.appendChild(tr);
      });

      // Mutabaah
      const m = semData.mutabaah;
      [
        ["Shalat Berjamaah", m.berjamaah],
        ["Shalat Rawatib", m.rawatib],
        ["Shalat Qiyamullail", m.qiyamullail],
        ["Shalat Dhuha", m.dhuha],
        ["Tilawah", m.tilawah],
        ["Matsurat", m.matsurat],
        ["Shaum Sunnah", m.shaumSunnah],
        ["Olahraga", m.olahraga],
      ].forEach(([label, nilai]) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="label-left">${label}</td><td>${nilai}</td>`;
        tbodyMutabaah.appendChild(tr);
      });

      // Pelanggaran
      let totalPoin = 0;
      semData.pelanggaran.forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="label-left">${p.jenis}</td><td>${p.poin}</td>`;
        tbodyPelanggaran.appendChild(tr);
        totalPoin += p.poin;
      });
      totalPoinEl.textContent = totalPoin;
    }

    function exportPDF() {
      const original = document.querySelector('.app-shell');
      const clone = original.cloneNode(true);
      clone.querySelectorAll('.no-print').forEach(el => el.remove());

      const opt = {
        margin:       0.5,
        filename:     'rapot-santri-hk.pdf',
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2 },
        jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
      };
      html2pdf().set(opt).from(clone).save();
    }

    document.addEventListener('DOMContentLoaded', function() {
      ["filterTahun","filterJenjang","filterKelas","filterParalel","filterSemester","filterGender","filterAsrama"]
        .forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.addEventListener("change", () => {
              updateStatusRingkasan();
              loadDataSantri();
            });
          }
        });

      updateStatusRingkasan();
      loadDataSantri();
    });
  </script>
</body>
</html>
