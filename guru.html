<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SISPO HK - Guru</title>
  <link rel="stylesheet" href="sispo.css" />
  <style>
    :root {
      --blue: #1d4ed8;
      --blue-soft: #bfdbfe;
      --blue-soft2: #dbeafe;
      --green: #10b981;
      --green-soft: #bbf7d0;
      --green-soft2: #dcfce7;
      --white: #ffffff;
      --text: #000000;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #dbeafe, #dcfce7);
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 12px;
      color: var(--text);
    }
    .app-shell {
      width: 100%;
      max-width: 1280px;
      min-height: 620px;
      background: var(--white);
      border-radius: 18px;
      overflow: hidden;
      display: flex;
      box-shadow: 0 16px 40px rgba(0,0,0,0.2);
    }
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--white);
    }
    .main-header {
      padding: 12px 18px;
      border-bottom: 2px solid var(--blue-soft2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .main-header-left {
      display: flex;
      flex-direction: column;
    }
    .main-title {
      font-size: 17px;
      font-weight: 700;
    }
    .main-subtitle {
      font-size: 11px;
      opacity: 0.75;
    }
    .main-header-right {
      font-size: 11px;
      text-align: right;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--green);
      background: var(--green);
      color: var(--white);
      font-size: 11.5px;
    }
    .main-body {
      flex: 1;
      padding: 14px 18px 16px;
      background: linear-gradient(135deg, #ffffff, #eff6ff);
      overflow-y: auto;
    }
    .btn {
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--blue);
      background: var(--blue);
      color: var(--white);
      font-size: 11.5px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    .btn.secondary {
      border-color: var(--green);
      background: var(--green);
    }
    .btn:hover {
      opacity: 0.92;
    }

    /* LOGIN GURU */
    .login-page {
      max-width: 420px;
      margin: 32px auto;
      background: var(--white);
      border-radius: 16px;
      border: 1px solid var(--blue-soft2);
      box-shadow: 0 12px 30px rgba(0,0,0,0.15);
      padding: 20px 18px 18px;
    }
    .login-header {
      text-align: center;
      margin-bottom: 16px;
    }
    .login-badge {
      display: inline-flex;
      padding: 3px 10px;
      border-radius: 999px;
      background: var(--green-soft);
      font-size: 11px;
      margin-bottom: 6px;
    }
    .login-title {
      font-size: 19px;
      font-weight: 700;
    }
    .login-subtitle {
      font-size: 12px;
      opacity: 0.75;
    }
    .login-form-group {
      text-align: left;
      margin-bottom: 12px;
      font-size: 13px;
    }
    .login-form-group label {
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
    }
    .login-form-group input {
      width: 100%;
      padding: 9px 11px;
      border-radius: 10px;
      border: 1px solid var(--blue-soft2);
      font-size: 13px;
      outline: none;
    }
    .login-form-group input:focus {
      border-color: var(--blue);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.35);
    }
    .password-wrapper {
      position: relative;
    }
    .password-wrapper input {
      padding-right: 70px;
    }
    .toggle-password {
      position: absolute;
      right: 9px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 11px;
      padding: 2px 4px;
    }
    .login-button {
      width: 100%;
      margin-top: 8px;
      padding: 10px 10px;
      border-radius: 999px;
      border: 1px solid var(--green);
      background: var(--green);
      color: var(--white);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .login-button:hover {
      background: #059669;
      border-color: #059669;
    }
    .login-error {
      margin-top: 8px;
      font-size: 12px;
      color: #b91c1c;
      min-height: 16px;
    }
    .login-footer {
      margin-top: 10px;
      font-size: 11px;
      text-align: center;
      opacity: 0.8;
    }

    /* WRAPPER MODE GURU */
    .guru-wrapper {
      max-width: 1100px;
      margin: 0 auto;
      display: none;
      flex-direction: column;
      gap: 16px;
    }

    /* FILTER */
    .guru-filter-card {
      background: var(--white);
      border-radius: 14px;
      padding: 10px 11px;
      border: 1px solid var(--blue-soft2);
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      font-size: 12px;
    }
    .guru-filter-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 8px 12px;
    }
    @media (max-width: 820px) {
      .guru-filter-grid {
        grid-template-columns: repeat(2, minmax(0,1fr));
      }
    }
    @media (max-width: 600px) {
      .guru-filter-grid {
        grid-template-columns: 1fr;
      }
    }
    .guru-filter-item {
      display: flex;
      flex-direction: column;
    }
    .guru-filter-item label {
      font-size: 11px;
      margin-bottom: 2px;
      font-weight: 600;
    }
    .guru-filter-item select {
      padding: 4px 6px;
      border-radius: 999px;
      border: 1px solid var(--blue-soft2);
      font-size: 12px;
      background: var(--white);
      outline: none;
    }
    .guru-filter-item select:focus {
      border-color: var(--blue);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.35);
    }
    .guru-filter-note {
      margin-top: 6px;
      font-size: 10.5px;
      opacity: 0.8;
    }

    .guru-filter-actions {
      margin-top: 8px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* TABEL NILAI GURU */
    .guru-table-card {
      background: var(--white);
      border-radius: 14px;
      padding: 10px 11px 9px;
      border: 1px solid var(--blue-soft2);
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
      margin-top: 4px;
      font-size: 11.5px;
    }
    .guru-table-title {
      font-size: 13.5px;
      font-weight: 700;
      margin-bottom: 7px;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      flex-wrap: wrap;
    }
    .guru-table-title small {
      font-size: 11px;
      opacity: 0.8;
    }
    .guru-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11.5px;
    }
    .guru-table th,
    .guru-table td {
      border: 1px solid var(--blue-soft2);
      padding: 4px 5px;
      text-align: center;
    }
    .guru-table th {
      background: var(--blue-soft2);
      font-weight: 600;
    }
    .guru-table td.align-left {
      text-align: left;
    }
    .guru-table input[type="number"] {
      width: 100%;
      box-sizing: border-box;
      padding: 2px 4px;
      border-radius: 6px;
      border: 1px solid var(--blue-soft2);
      font-size: 11px;
      outline: none;
      text-align: center;
    }
    .guru-table input[type="number"]:focus {
      border-color: var(--green);
      box-shadow: 0 0 0 1px rgba(16,185,129,0.35);
    }
    .guru-table .readonly-cell {
      background: #f9fafb;
    }
    .guru-footer-note {
      margin-top: 6px;
      font-size: 10.5px;
      opacity: 0.8;
    }

    .guru-actions {
      margin-top: 8px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo-box">
          <img src="https://uploads.onecompiler.io/444e96suz/444e96fm2/cropped-00_Logo-HK-Utama.webp" alt="Logo HK">
        </div>
        <div class="sidebar-title">
          <strong>SISPO HK</strong>
          <span>Sistem Informasi Santri</span>
        </div>
      </div>

      <div class="sidebar-nav">
        <div class="nav-section-title">Mode Akses</div>

        <div class="nav-item">
          <a href="index.html">
            <span>Santri &amp; Wali Santri</span>
            <span class="nav-tag">Rapot</span>
          </a>
        </div>

        <div class="nav-item active">
          <span>Guru</span>
          <span class="nav-tag">Akademik</span>
        </div>

        <div class="nav-item">
          <a href="musyrif.html">
            <span>Musyrif</span>
            <span class="nav-tag">TTQ</span>
          </a>
        </div>

        <div class="nav-item">
          <a href="murobbi.html">
            <span>Murobbi</span>
            <span class="nav-tag">Mutabaah</span>
          </a>
        </div>

        <div class="nav-item">
          <a href="bahasa.html">
            <span>Bahasa</span>
            <span class="nav-tag">Arab &amp; Inggris</span>
          </a>
        </div>

        <div class="nav-item">
          <a href="pengasuhan.html">
            <span>Pengasuhan</span>
            <span class="nav-tag">Poin Pelanggaran</span>
          </a>
        </div>

        <div class="nav-item">
          <a href="admin.html">
            <span>Admin</span>
            <span class="nav-tag">Data Profil</span>
          </a>
        </div>
      </div>

      <div class="sidebar-footer">
        Pontren Husnul Khotimah
        <span>Dashboard Rapot Terintegrasi</span>
      </div>
    </aside>

    <!-- MAIN -->
    <div class="main">
      <header class="main-header">
        <div class="main-header-left">
          <div class="main-title">Sistem Informasi Santri Pontren Husnul Khotimah</div>
          <div class="main-subtitle">
            Input Nilai Akademik Santri oleh Guru.
          </div>
        </div>
        <div class="main-header-right">
          Mode: <span>Guru</span>
          <span class="badge" id="statusBadgeGuru">Login diperlukan</span>
          <button type="button"
                  id="logoutGuruBtn"
                  class="btn"
                  onclick="handleLogoutGuru()"
                  style="display:none;">
            Logout
          </button>
        </div>
      </header>

      <main class="main-body">
        <!-- LOGIN GURU -->
        <div id="loginGuruContainer" class="login-page">
          <div class="login-header">
            <div class="login-badge">ðŸ”‘ Login</div>
            <div class="login-title">Guru</div>
            <div class="login-subtitle">
              Masuk dengan akun guru untuk mengisi nilai akademik santri.
            </div>
          </div>

          <form id="loginGuruForm" onsubmit="handleLoginGuru(event)">
            <div class="login-form-group">
              <label for="loginGuruID">Email Guru</label>
              <input type="text" id="loginGuruID" placeholder="nama@domain.com" autocomplete="username" />
            </div>
            <div class="login-form-group">
              <label for="loginGuruPassword">Password</label>
              <div class="password-wrapper">
                <input type="password" id="loginGuruPassword" placeholder="password" autocomplete="current-password" />
                <button
                  type="button"
                  class="toggle-password"
                  data-target="loginGuruPassword"
                  onclick="togglePassword(this)">
                  Show
                </button>
              </div>
            </div>
            <button class="login-button" type="submit">Masuk</button>
          </form>

          <div id="loginGuruError" class="login-error"></div>

          <div class="login-footer">
            Akun guru dikelola melalui dashboard Supabase.
          </div>
        </div>

        <!-- MODE GURU -->
        <div id="guruWrapper" class="guru-wrapper">
          <!-- FILTER -->
          <div class="guru-filter-card">
            <div style="font-weight:700; font-size:13.5px; margin-bottom:6px;">
              Filter Kelas Nilai Akademik Santri
            </div>

            <div class="guru-filter-grid">
              <!-- Tahun Ajaran -->
              <div class="guru-filter-item">
                <label for="guruTahun">Tahun Ajaran</label>
                <select id="guruTahun">
                  <option value="2023_2024">2023/2024</option>
                  <option value="2024_2025" selected>2024/2025</option>
                  <option value="2025_2026">2025/2026</option>
                </select>
              </div>

              <!-- Semester -->
              <div class="guru-filter-item">
                <label for="guruSemester">Semester</label>
                <select id="guruSemester">
                  <option value="1" selected>1</option>
                  <option value="2">2</option>
                </select>
              </div>

              <!-- Jenjang -->
              <div class="guru-filter-item">
                <label for="guruJenjang">Jenjang</label>
                <select id="guruJenjang">
                  <option value="MTs (HK1)">MTs (HK1)</option>
                  <option value="MTs (HK2)">MTs (HK2)</option>
                  <option value="MA" selected>MA</option>
                </select>
              </div>

              <!-- Kelas -->
              <div class="guru-filter-item">
                <label for="guruKelas">Kelas</label>
                <select id="guruKelas">
                  <option value="VII">VII</option>
                  <option value="VIII">VIII</option>
                  <option value="IX">IX</option>
                  <option value="X">X</option>
                  <option value="XI" selected>XI</option>
                  <option value="XII">XII</option>
                </select>
              </div>

              <!-- Paralel / Rombel -->
              <div class="guru-filter-item">
                <label for="guruParalel">Paralel / Rombel</label>
                <select id="guruParalel">
                  <option value="A">A</option>
                  <option value="B">B</option>
                  <option value="C">C</option>
                  <option value="D">D</option>
                  <option value="E">E</option>
                  <option value="F">F</option>
                  <option value="G">G</option>
                  <option value="H">H</option>
                  <option value="I">I</option>
                  <option value="J">J</option>
                  <option value="K">K</option>
                  <option value="L">L</option>
                  <option value="M">M</option>
                  <option value="N">N</option>
                  <option value="O">O</option>
                  <option value="P">P</option>
                  <option value="Q">Q</option>
                  <option value="R">R</option>
                  <option value="S">S</option>
                  <option value="T">T</option>
                  <option value="U">U</option>
                  <option value="V">V</option>
                  <option value="W">W</option>
                  <option value="X">X</option>
                  <option value="Y">Y</option>
                  <option value="Z">Z</option>
                  <!-- contoh rombel khusus (opsional, biar tetap ada) -->
                  <option value="IPA 1">IPA 1</option>
                  <option value="IPA 2">IPA 2</option>
                  <option value="IPA 3">IPA 3</option>
                  <option value="IPA 4">IPA 4</option>
                  <option value="IPA 5">IPA 5</option>
                  <option value="IPA 6">IPA 6</option>
                  <option value="IPA 7">IPA 7</option>
                  <option value="IPA 8">IPA 8</option>
                  <option value="IPA 9">IPA 9</option>
                  <option value="IPA 10">IPA 10</option>
                  <option value="IPA 11">IPA 11</option>
                  <option value="IPA 12">IPA 12</option>
                  <option value="IPA 13">IPA 13</option>
                  <option value="IPA 14">IPA 14</option>
                  <option value="IPA 15">IPA 15</option>
                  <option value="IPS 1">IPS 1</option>
                  <option value="IPS 2">IPS 2</option>
                  <option value="IPS 3">IPS 3</option>
                  <option value="IPS 4">IPS 4</option>
                  <option value="IPS 5">IPS 5</option>
                  <option value="IPS 6">IPS 6</option>
                  <option value="PK 1">PK 1</option>
                  <option value="PK 2">PK 2</option>
                  <option value="PK 3">PK 3</option>
                  <option value="PK 4">PK 4</option>
                  <option value="PK 5">PK 5</option>
                  <option value="PK 6">PK 6</option>
                </select>
              </div>
              
              <!-- Mapel -->
              <div class="guru-filter-item">
                <label for="guruMapel">Mata Pelajaran</label>
                <select id="guruMapel">
                  <option value="Tafsir">Tafsir</option>
                  <option value="Aqidah Akhlak">Aqidah Akhlak</option>
                  <option value="Fiqih">Fiqih</option>
                  <option value="Sejarah Kebudayaan Islam">Sejarah Kebudayaan Islam</option>
                  <option value="Pendidikan Kewarganegaraan">Pendidikan Kewarganegaraan</option>
                  <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                  <option value="Bahasa Arab">Bahasa Arab</option>
                  <option value="Matematika">Matematika</option>
                  <option value="Sejarah Indonesia">Sejarah Indonesia</option>
                  <option value="Bahasa Inggris">Bahasa Inggris</option>
                  <option value="Fisika">Fisika</option>
                  <option value="Kimia">Kimia</option>
                  <option value="Biologi">Biologi</option>
                  <option value="Ekonomi">Ekonomi</option>
                  <option value="Geografi">Geografi</option>
                  <option value="Sosiologi">Sosiologi</option>
                  <option value="Informatika">Informatika</option>
                  <option value="Matematika Peminatan">Matematika Peminatan</option>
                  <option value="Fisika Peminatan">Fisika Peminatan</option>
                  <option value="Kimia Peminatan">Kimia Peminatan</option>
                  <option value="Biologi Peminatan">Biologi Peminatan</option>
                  <option value="Sejarah Peminatan">Sejarah Peminatan</option>
                  <option value="Ekonomi Peminatan">Ekonomi Peminatan</option>
                  <option value="Geografi Peminatan">Geografi Peminatan</option>
                  <option value="Sosiologi Peminatan">Sosiologi Peminatan</option>
                  <option value="Ilmu Tafsir">Ilmu Tafsir</option>
                  <option value="Ilmu Hadis">Ilmu Hadits</option>
                  <option value="Ushul Fiqih">Ushul Fiqih</option>
                  <option value="Balaghoh">Balaghoh</option>
                  <option value="Tahfidz Al-Qur'an">Tahfidz Al-Qur'an</option>
                  <option value="Bahasa Inggris Tingkat Lanjut">Bahasa Inggris Tingkat Lanjut</option>
                  <option value="Nahwu (Qawaid)">Nahwu (Qawaid)</option>
                  <option value="Hadits">Hadits</option>
                  <option value="Faroidh">Faroidh</option>
                  <option value="Bimbingan Konseling (BK)">Bimbingan Konseling (BK)</option>
                </select>
              </div>
            </div>

            <div class="guru-filter-note">
              Data identitas santri diambil dari tabel <code>rekap_santri</code> untuk
              Tahun Ajaran, Semester, Jenjang, dan Paralel yang dipilih di sini.
            </div>

            <div class="guru-filter-actions">
              <button class="btn secondary" type="button" onclick="muatDataSantriGuru()">
                ðŸ”„ Muat Data Santri
              </button>
            </div>
          </div>

          <!-- TABEL NILAI -->
          <div class="guru-table-card">
            <div class="guru-table-title">
              <span>Input Nilai Akademik Santri</span>
              <small>
                Kelas: <span id="labelGuruKelas">XI</span> /
                TA <span id="labelGuruTahun">2024/2025</span> /
                Sem <span id="labelGuruSemester">1</span>
              </small>
            </div>

            <table class="guru-table" id="guruNilaiTable">
              <thead>
                <tr>
                  <th>No.</th>
                  <th>NIS</th>
                  <th>Nama Lengkap</th>
                  <th id="thPengetahuan">Nilai Pengetahuan</th>
                  <th id="thKeterampilan">Nilai Keterampilan</th>
                </tr>
              </thead>
              <tbody>
                <!-- Diisi JS -->
              </tbody>
            </table>

            <div class="guru-actions">
              <button class="btn" type="button" onclick="simpanNilaiGuru()">
                ðŸ’¾ Simpan Nilai ke Database
              </button>
            </div>

            <div class="guru-footer-note">
              *Nama &amp; NIS berasal dari input Admin (rekap_santri).  
              *Guru hanya mengisi / mengubah kolom nilai. Penyimpanan menggunakan upsert berdasarkan (NIS, Tahun Ajaran, Semester).
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    const { createClient } = supabase;

    const SUPABASE_URL = 'https://esravodnlmwstdtudism.supabase.co';
    const SUPABASE_ANON_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzcmF2b2RubG13c3RkdHVkaXNtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4NDE1ODUsImV4cCI6MjA3OTQxNzU4NX0.rWxlzueSdUvd6Vc6VKaGwZv47djT-3HvyhgfI3BpxAY';

    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <script>
    // --- SESSION LOGIN GURU ---
    const GURU_SESSION_KEY = "sispo_guru_session";
    const SESSION_DURATION_MS = 5 * 60 * 1000;
    let guruLogoutTimer = null;

    async function handleLoginGuru(event) {
      event.preventDefault();
      const email = document.getElementById("loginGuruID").value.trim();
      const pass  = document.getElementById("loginGuruPassword").value.trim();
      const errorEl = document.getElementById("loginGuruError");

      if (!email || !pass) {
        errorEl.textContent = "Username dan password wajib diisi.";
        return;
      }

      const { data, error } = await db.auth.signInWithPassword({
        email,
        password: pass
      });

      if (error) {
        console.error(error);
        errorEl.textContent = "Login gagal. Periksa kembali username dan password.";
        return;
      }

      // cek role guru
      const { data: roleData, error: roleError } = await db
        .from("user_roles")
        .select("mode")
        .eq("id", data.user.id)
        .single();

      if (roleError || !roleData) {
        console.error(roleError);
        errorEl.textContent = "Role pengguna tidak ditemukan.";
        await db.auth.signOut();
        return;
      }

      if (roleData.mode !== "guru") {
        errorEl.textContent = "Akun ini bukan akun Guru.";
        await db.auth.signOut();
        return;
      }

      errorEl.textContent = "";
      setGuruSession();
      applyGuruLoginUI();
      updateGuruLabels();
      scheduleGuruAutoLogout();
    }

    function applyGuruLoginUI() {
      document.getElementById("loginGuruContainer").style.display = "none";
      document.getElementById("guruWrapper").style.display = "flex";
      document.getElementById("statusBadgeGuru").textContent = "Login";
      const btn = document.getElementById("logoutGuruBtn");
      if (btn) btn.style.display = "inline-block";
    }

    function applyGuruLogoutUI() {
      document.getElementById("loginGuruContainer").style.display = "block";
      document.getElementById("guruWrapper").style.display = "none";
      document.getElementById("statusBadgeGuru").textContent = "Login diperlukan";
      const btn = document.getElementById("logoutGuruBtn");
      if (btn) btn.style.display = "none";

      const tbody = document.querySelector("#guruNilaiTable tbody");
      if (tbody) tbody.innerHTML = "";
    }

    function setGuruSession() {
      const expiresAt = Date.now() + SESSION_DURATION_MS;
      localStorage.setItem(GURU_SESSION_KEY, JSON.stringify({ expiresAt }));
    }

    function clearGuruSession() {
      localStorage.removeItem(GURU_SESSION_KEY);
      if (guruLogoutTimer) {
        clearTimeout(guruLogoutTimer);
        guruLogoutTimer = null;
      }
    }

    function scheduleGuruAutoLogout() {
      const raw = localStorage.getItem(GURU_SESSION_KEY);
      if (!raw) return;

      try {
        const { expiresAt } = JSON.parse(raw);
        const remaining = expiresAt - Date.now();
        if (remaining <= 0) {
          handleLogoutGuru();
        } else {
          if (guruLogoutTimer) clearTimeout(guruLogoutTimer);
          guruLogoutTimer = setTimeout(handleLogoutGuru, remaining);
        }
      } catch (e) {
        handleLogoutGuru();
      }
    }

    async function handleLogoutGuru() {
      try {
        await db.auth.signOut();
      } catch (e) {
        console.error(e);
      }
      clearGuruSession();
      applyGuruLogoutUI();

      const form = document.getElementById("loginGuruForm");
      if (form) form.reset();
      const errorEl = document.getElementById("loginGuruError");
      if (errorEl) errorEl.textContent = "";
    }

    document.addEventListener("DOMContentLoaded", function () {
      const raw = localStorage.getItem(GURU_SESSION_KEY);
      // ... kode lama
    
      ["guruTahun","guruKelas","guruSemester","guruMapel"].forEach(id => {
        const el = document.getElementById(id);
        if (el && !el.dataset.listenerAttached) {
          el.addEventListener("change", updateGuruLabels);
          el.dataset.listenerAttached = "true";
        }
      });
    });

    function togglePassword(btn) {
      const targetId = btn.getAttribute("data-target");
      const input = document.getElementById(targetId);
      if (!input) return;

      if (input.type === "password") {
        input.type = "text";
        btn.textContent = "Hide";
      } else {
        input.type = "password";
        btn.textContent = "Show";
      }
    }

    function updateGuruLabels() {
      const tahun = document.getElementById("guruTahun").value;
      const kelas = document.getElementById("guruKelas").value;
      const semester = document.getElementById("guruSemester").value;
      const mapelKey = document.getElementById("guruMapel")?.value;
      const cfg = MAPEL_CONFIG[mapelKey] || null;
    
      document.getElementById("labelGuruTahun").textContent = tahun.replace("_","/");
      document.getElementById("labelGuruKelas").textContent = kelas;
      document.getElementById("labelGuruSemester").textContent = semester;
    
      const judulKecil = document.querySelector(".guru-table-title small");
      if (judulKecil && cfg) {
        judulKecil.innerHTML =
          `Kelas: <span id="labelGuruKelas">${kelas}</span> / ` +
          `TA <span id="labelGuruTahun">${tahun.replace("_","/")}</span> / ` +
          `Sem <span id="labelGuruSemester">${semester}</span> / ` +
          `Mapel: <strong>${cfg.label}</strong>`;
      }
    
      // update header nama kolom nilai biar jelas
      const thP = document.getElementById("thPengetahuan");
      const thK = document.getElementById("thKeterampilan");
      if (cfg && thP && thK) {
        thP.textContent = `Nilai ${cfg.label} (Pengetahuan)`;
        thK.textContent = `Nilai ${cfg.label} (Keterampilan)`;
      }
    }

      // MAPEL CONFIG: key = nilai di <select id="guruMapel">
      const MAPEL_CONFIG = {
        "Tafsir": {
          kolomP: "nilai_tafsir_p",
          kolomK: "nilai_tafsir_k",
          label: "Tafsir"
        },
        "Aqidah Akhlak": {
          kolomP: "nilai_aqidah_akhlak_p",
          kolomK: "nilai_aqidah_akhlak_k",
          label: "Aqidah Akhlak"
        },
        "Fiqih": {
          kolomP: "nilai_fiqih_p",
          kolomK: "nilai_fiqih_k",
          label: "Fiqih"
        },
        "Sejarah Kebudayaan Islam": {
          kolomP: "nilai_ski_p",
          kolomK: "nilai_ski_k",
          label: "Sejarah Kebudayaan Islam"
        },
        "Pendidikan Kewarganegaraan": {
          kolomP: "nilai_pkn_p",
          kolomK: "nilai_pkn_k",
          label: "Pendidikan Kewarganegaraan"
        },
        "Bahasa Indonesia": {
          kolomP: "nilai_b_indonesia_p",
          kolomK: "nilai_b_indonesia_k",
          label: "Bahasa Indonesia"
        },
        "Bahasa Arab": {
          kolomP: "nilai_b_arab_p",
          kolomK: "nilai_b_arab_k",
          label: "Bahasa Arab"
        },
        "Matematika": {
          kolomP: "nilai_matematika_p",
          kolomK: "nilai_matematika_k",
          label: "Matematika"
        },
        "Sejarah Indonesia": {
          kolomP: "nilai_sejarah_indo_p",
          kolomK: "nilai_sejarah_indo_k",
          label: "Sejarah Indonesia"
        },
        "Bahasa Inggris": {
          kolomP: "nilai_b_inggris_p",
          kolomK: "nilai_b_inggris_k",
          label: "Bahasa Inggris"
        },
        "Fisika": {
          kolomP: "nilai_fisika_p",
          kolomK: "nilai_fisika_k",
          label: "Fisika"
        },
        "Kimia": {
          kolomP: "nilai_kimia_p",
          kolomK: "nilai_kimia_k",
          label: "Kimia"
        },
        "Biologi": {
          kolomP: "nilai_biologi_p",
          kolomK: "nilai_biologi_k",
          label: "Biologi"
        },
        "Ekonomi": {
          kolomP: "nilai_ekonomi_p",
          kolomK: "nilai_ekonomi_k",
          label: "Ekonomi"
        },
        "Geografi": {
          kolomP: "nilai_geografi_p",
          kolomK: "nilai_geografi_k",
          label: "Geografi"
        },
        "Sosiologi": {
          kolomP: "nilai_sosiologi_p",
          kolomK: "nilai_sosiologi_k",
          label: "Sosiologi"
        },
        "Informatika": {
          kolomP: "nilai_informatika_p",
          kolomK: "nilai_informatika_k",
          label: "Informatika"
        },
        "Matematika Peminatan": {
          kolomP: "nilai_mtk_ipa_p",
          kolomK: "nilai_mtk_ipa_k",
          label: "Matematika Peminatan"
        },
        "Fisika Peminatan": {
          kolomP: "nilai_fisika_ipa_p",
          kolomK: "nilai_fisika_ipa_k",
          label: "Fisika Peminatan"
        },
        "Kimia Peminatan": {
          kolomP: "nilai_kimia_ipa_p",
          kolomK: "nilai_kimia_ipa_k",
          label: "Kimia Peminatan"
        },
        "Biologi Peminatan": {
          kolomP: "nilai_biologi_ipa_p",
          kolomK: "nilai_biologi_ipa_k",
          label: "Biologi Peminatan"
        },
        "Sejarah Peminatan": {
          kolomP: "nilai_sejarah_ips_p",
          kolomK: "nilai_sejarah_ips_k",
          label: "Sejarah Peminatan"
        },
        "Ekonomi Peminatan": {
          kolomP: "nilai_ekonomi_ips_p",
          kolomK: "nilai_ekonomi_ips_k",
          label: "Ekonomi Peminatan"
        },
        "Geografi Peminatan": {
          kolomP: "nilai_geografi_ips_p",
          kolomK: "nilai_geografi_ips_k",
          label: "Geografi Peminatan"
        },
        "Sosiologi Peminatan": {
          kolomP: "nilai_sosiologi_ips_p",
          kolomK: "nilai_sosiologi_ips_k",
          label: "Sosiologi Peminatan"
        },
        "Ilmu Tafsir": {
          kolomP: "nilai_ilmu_tafsir_p",
          kolomK: "nilai_ilmu_tafsir_k",
          label: "Ilmu Tafsir"
        },
        "Ilmu Hadits": {
          kolomP: "nilai_ilmu_hadits_p",
          kolomK: "nilai_ilmu_hadits_k",
          label: "Ilmu Hadits"
        },
        "Ushul Fiqih": {
          kolomP: "nilai_ushul_fiqih_p",
          kolomK: "nilai_ushul_fiqih_k",
          label: "Ushul Fiqih"
        },
        "Balaghoh": {
          kolomP: "nilai_balaghoh_p",
          kolomK: "nilai_balaghoh_k",
          label: "Balaghoh"
        },
        "Tahfidz Al-Qur'an": {
          kolomP: "nilai_ttq_p",
          kolomK: "nilai_ttq_k",
          label: "Tahfidz Al-Qur'an"
        },
        "Bahasa Inggris Tingkat Lanjut": {
          kolomP: "nilai_b_inggris_bhs_p",
          kolomK: "nilai_b_inggris_bhs_k",
          label: "Bahasa Inggris Tingkat Lanjut"
        },
        "Nahwu (Qawaid)": {
          kolomP: "nilai_qowaid_p",
          kolomK: "nilai_qowaid_k",
          label: "Nahwu (Qawaid)"
        },
        "Hadits": {
          kolomP: "nilai_hadits_p",
          kolomK: "nilai_hadits_k",
          label: "Hadits"
        },
        "Faroidh": {
          kolomP: "nilai_faroidh_p",
          kolomK: "nilai_faroidh_k",
          label: "Faroidh"
        },
        "Bimbingan Konseling (BK)": {
          kolomP: "nilai_bk_p",
          kolomK: "nilai_bk_k",
          label: "Bimbingan Konseling (BK)"
        }
      };

      // --- MUAT DATA SANTRI DARI rekap_santri ---
      async function muatDataSantriGuru() {
        const tahunRaw = document.getElementById("guruTahun").value;
        const tahun    = tahunRaw.replace("_", "/");
        const semester = parseInt(document.getElementById("guruSemester").value, 10);
        const jenjang  = document.getElementById("guruJenjang").value;
        const kelas    = document.getElementById("guruKelas").value;
        const paralel  = document.getElementById("guruParalel").value;
        const mapelKey = document.getElementById("guruMapel").value;
      
        const cfg = MAPEL_CONFIG[mapelKey];
        if (!cfg) {
          alert("Mapel belum dikonfigurasi di MAPEL_CONFIG.");
          return;
        }
      
        const tbody = document.querySelector("#guruNilaiTable tbody");
        if (!tbody) return;
        tbody.innerHTML = "";
      
        const { data, error } = await db
          .from("rekap_santri")
          .select("*")
          .eq("tahun_ajaran", tahun)
          .eq("semester", semester)
          .eq("jenjang", jenjang)
          .eq("kelas", kelas)
          .eq("paralel", paralel)
          .order("nama_lengkap", { ascending: true });
      
        if (error) {
          console.error(error);
          alert("Gagal mengambil data santri: " + error.message);
          return;
        }
      
        if (!data || data.length === 0) {
          alert("Belum ada data santri untuk filter yang dipilih.\nPastikan admin sudah mengisi profil di rekap_santri.");
          return;
        }
      
        data.forEach((row, idx) => {
          const nilaiP = row[cfg.kolomP] ?? "";
          const nilaiK = row[cfg.kolomK] ?? "";
      
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${idx + 1}</td>
            <td class="readonly-cell" data-nis="${row.nis || ""}">${row.nis || ""}</td>
            <td class="readonly-cell align-left">${row.nama_lengkap || ""}</td>
            <td>
              <input
                type="number"
                step="0.01"
                min="0"
                max="100"
                data-field="${cfg.kolomP}"
                value="${nilaiP}"
              />
            </td>
            <td>
              <input
                type="number"
                step="0.01"
                min="0"
                max="100"
                data-field="${cfg.kolomK}"
                value="${nilaiK}"
              />
            </td>
          `;
          tbody.appendChild(tr);
        });
      
        updateGuruLabels();
        alert("Data santri berhasil dimuat. Silakan isi nilai pengetahuan & keterampilan, lalu klik 'Simpan Nilai ke Database'.");
      }

    // --- SIMPAN NILAI GURU KE rekap_santri (UPSERT) ---
    async function simpanNilaiGuru() {
      const tbody = document.querySelector("#guruNilaiTable tbody");
      if (!tbody) return;
    
      const tahunRaw = document.getElementById("guruTahun").value;
      const tahun    = tahunRaw.replace("_", "/");
      const semester = parseInt(document.getElementById("guruSemester").value, 10);
      const mapelKey = document.getElementById("guruMapel").value;
    
      const cfg = MAPEL_CONFIG[mapelKey];
      if (!cfg) {
        alert("Mapel belum dikonfigurasi di MAPEL_CONFIG.");
        return;
      }
    
      const rows = Array.from(tbody.querySelectorAll("tr"));
      const payload = [];
    
      const getNilai = (tr, fieldName) => {
        const input = tr.querySelector(`input[data-field="${fieldName}"]`);
        if (!input) return null;
        const val = input.value.trim();
        if (val === "") return null;
        const num = parseFloat(val.replace(",", "."));
        return isNaN(num) ? null : num;
      };
    
      for (const tr of rows) {
        const nisCell = tr.children[1];
        if (!nisCell) continue;
        const nis = nisCell.getAttribute("data-nis") || nisCell.textContent.trim();
        if (!nis) continue;
    
        const nilaiP = getNilai(tr, cfg.kolomP);
        const nilaiK = getNilai(tr, cfg.kolomK);
    
        // Kalau dua-duanya kosong, lewati (tidak mengubah apa-apa)
        if (nilaiP === null && nilaiK === null) continue;
    
        const rowData = {
          nis,
          tahun_ajaran: tahun,
          semester
        };
    
        if (nilaiP !== null) rowData[cfg.kolomP] = nilaiP;
        if (nilaiK !== null) rowData[cfg.kolomK] = nilaiK;
    
        payload.push(rowData);
      }
    
      if (payload.length === 0) {
        alert("Tidak ada nilai yang diisi / diubah.");
        return;
      }
    
      const { data, error } = await db
        .from("rekap_santri")
        .upsert(payload, {
          onConflict: "nis,tahun_ajaran,semester"
        });
    
      if (error) {
        console.error(error);
        alert("Gagal menyimpan nilai santri: " + error.message);
      } else {
        alert("Nilai santri berhasil disimpan / diperbarui di rekap_santri.");
        console.log("Data tersimpan:", data);
      }
    }
  </script>
</body>
</html>











