<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SISPO HK - Musyrif</title>
  <link rel="stylesheet" href="sispo.css" />
  <style>
    :root {
      --blue: #1d4ed8;
      --blue-soft: #bfdbfe;
      --blue-soft2: #dbeafe;
      --green: #10b981;
      --green-soft: #bbf7d0;
      --green-soft2: #dcfce7;
      --white: #ffffff;
      --text: #000000;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #dbeafe, #dcfce7);
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 12px;
      color: var(--text);
    }
    .app-shell {
      width: 100%;
      max-width: 1280px;
      min-height: 620px;
      background: var(--white);
      border-radius: 18px;
      overflow: hidden;
      display: flex;
      box-shadow: 0 16px 40px rgba(0,0,0,0.2);
    }
    /* MAIN */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--white);
    }
    .main-header {
      padding: 12px 18px;
      border-bottom: 2px solid var(--blue-soft2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .main-header-left {
      display: flex;
      flex-direction: column;
    }
    .main-title {
      font-size: 17px;
      font-weight: 700;
    }
    .main-subtitle {
      font-size: 11px;
      opacity: 0.75;
    }
    .main-header-right {
      font-size: 11px;
      text-align: right;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--green);
      background: var(--green);
      color: var(--white);
      font-size: 11.5px;
    }
    .main-body {
      flex: 1;
      padding: 14px 18px 16px;
      background: linear-gradient(135deg, #ffffff, #eff6ff);
      overflow-y: auto;
    }
    /* LOGIN MUSYRIF */
    .login-page {
      max-width: 420px;
      margin: 32px auto;
      background: var(--white);
      border-radius: 16px;
      border: 1px solid var(--blue-soft2);
      box-shadow: 0 12px 30px rgba(0,0,0,0.15);
      padding: 20px 18px 18px;
    }
    .login-header {
      text-align: center;
      margin-bottom: 16px;
    }
    .login-badge {
      display: inline-flex;
      padding: 3px 10px;
      border-radius: 999px;
      background: var(--green-soft);
      font-size: 11px;
      margin-bottom: 6px;
    }
    .login-title {
      font-size: 19px;
      font-weight: 700;
    }
    .login-subtitle {
      font-size: 12px;
      opacity: 0.75;
    }
    .login-form-group {
      text-align: left;
      margin-bottom: 12px;
      font-size: 13px;
    }
    .login-form-group label {
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
    }
    .login-form-group input {
      width: 100%;
      padding: 9px 11px;
      border-radius: 10px;
      border: 1px solid var(--blue-soft2);
      font-size: 13px;
      outline: none;
    }
    .login-form-group input:focus {
      border-color: var(--blue);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.35);
    }
    .password-wrapper {
      position: relative;
    }
    .password-wrapper input {
      padding-right: 70px;
    }
    .toggle-password {
      position: absolute;
      right: 9px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 11px;
      padding: 2px 4px;
    }
    .login-button {
      width: 100%;
      margin-top: 8px;
      padding: 10px 10px;
      border-radius: 999px;
      border: 1px solid var(--green);
      background: var(--green);
      color: var(--white);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .login-button:hover {
      background: #059669;
      border-color: #059669;
    }
    .login-error {
      margin-top: 8px;
      font-size: 12px;
      color: #b91c1c;
      min-height: 16px;
    }
    .login-footer {
      margin-top: 10px;
      font-size: 11px;
      text-align: center;
      opacity: 0.8;
    }
    /* MUSYRIF MODE */
    .musyrif-header {
      margin-bottom: 10px;
    }
    .musyrif-title {
      font-size: 17px;
      font-weight: 700;
    }
    .musyrif-subtitle {
      font-size: 11px;
      opacity: 0.75;
    }
    .musyrif-form-wrapper {
      max-width: 980px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .musyrif-filter-card {
      background: var(--white);
      border-radius: 14px;
      padding: 10px 11px;
      border: 1px solid var(--blue-soft2);
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      font-size: 12px;
    }
    .musyrif-filter-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 8px 12px;
    }
    @media (max-width: 820px) {
      .musyrif-filter-grid {
        grid-template-columns: repeat(2, minmax(0,1fr));
      }
    }
    @media (max-width: 600px) {
      .musyrif-filter-grid {
        grid-template-columns: 1fr;
      }
    }
    .musyrif-filter-item {
      display: flex;
      flex-direction: column;
    }
    .musyrif-filter-item label {
      font-size: 11px;
      margin-bottom: 2px;
      font-weight: 600;
    }
    .musyrif-filter-item select {
      padding: 4px 6px;
      border-radius: 999px;
      border: 1px solid var(--blue-soft2);
      font-size: 12px;
      background: var(--white);
      outline: none;
    }
    .musyrif-filter-item select:focus {
      border-color: var(--blue);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.35);
    }
    .musyrif-filter-note {
      margin-top: 6px;
      font-size: 10.5px;
      opacity: 0.8;
    }
    .musyrif-table-card {
      background: var(--white);
      border-radius: 14px;
      padding: 10px 11px 9px;
      border: 1px solid var(--blue-soft2);
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    }
    .musyrif-table-title {
      font-size: 13.5px;
      font-weight: 700;
      margin-bottom: 7px;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }
    .musyrif-table-title small {
      font-size: 11px;
      opacity: 0.8;
    }
    .template-tools {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      gap: 8px;
      font-size: 11px;
      flex-wrap: wrap;
    }
    .template-left {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
    }
    .template-right {
      font-style: italic;
      opacity: 0.8;
    }
    .template-btn {
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--blue);
      background: var(--blue);
      color: var(--white);
      font-size: 11.5px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    .template-btn.secondary {
      border-color: var(--green);
      background: var(--green);
    }
    .template-btn:hover {
      opacity: 0.92;
    }
    .template-btn input[type="file"] {
      display: none;
    }
    .musyrif-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11.5px;
    }
    .musyrif-table th,
    .musyrif-table td {
      border: 1px solid var(--blue-soft2);
      padding: 4px 5px;
      text-align: center;
    }
    .musyrif-table th {
      background: var(--blue-soft2);
      font-weight: 600;
    }
    .musyrif-table td.label-left {
      text-align: left;
    }
    .musyrif-table input {
      width: 100%;
      padding: 2px 4px;
      border-radius: 6px;
      border: 1px solid var(--blue-soft2);
      font-size: 11px;
      text-align: center;
      outline: none;
    }
    .musyrif-table td.label-left input {
      text-align: left;
    }
    .musyrif-table input:focus {
      border-color: var(--green);
      box-shadow: 0 0 0 1px rgba(16,185,129,0.35);
    }
    .musyrif-actions {
      margin-top: 8px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    .btn {
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--blue);
      background: var(--blue);
      color: var(--white);
      font-size: 11.5px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    .btn.secondary {
      border-color: var(--green);
      background: var(--green);
    }
    .btn:hover { opacity: 0.92; }
    .musyrif-footer-note {
      margin-top: 6px;
      font-size: 10.5px;
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo-box">
          <img src="https://uploads.onecompiler.io/444e96suz/444e96fm2/cropped-00_Logo-HK-Utama.webp" alt="Logo HK">
        </div>
        <div class="sidebar-title">
          <strong>SISPO HK</strong>
          <span>Sistem Informasi Santri</span>
        </div>
      </div>

      <div class="sidebar-nav">
        <div class="nav-section-title">Mode Akses</div>

        <div class="nav-item">
          <a href="index.html">
            <span>Santri &amp; Wali Santri</span>
            <span class="nav-tag">Rapot</span>
          </a>
        </div>

        <div class="nav-item">
          <a href="guru.html">
            <span>Guru</span>
            <span class="nav-tag">Akademik</span>
          </a>
        </div>

        <div class="nav-item active">
          <span>Musyrif</span>
          <span class="nav-tag">TTQ</span>
        </div>

        <div class="nav-item">
          <a href="murobbi.html">
            <span>Murobbi</span>
            <span class="nav-tag">Mutabaah</span>
          </a>
        </div>

        <div class="nav-item">
          <a href="bahasa.html">
            <span>Bahasa</span>
            <span class="nav-tag">Arab &amp; Inggris</span>
          </a>
        </div>

        <div class="nav-item">
          <a href="pengasuhan.html">
            <span>Pengasuhan</span>
            <span class="nav-tag">Poin Pelanggaran</span>
          </a>
        </div>

        <div class="nav-item">
          <a href="admin.html">
            <span>Admin</span>
            <span class="nav-tag">Data Profil</span>
          </a>
        </div>
      </div>

      <div class="sidebar-footer">
        Pontren Husnul Khotimah
        <span>Dashboard Rapot Terintegrasi</span>
      </div>
    </aside>

    <!-- MAIN -->
    <div class="main">
      <header class="main-header">
        <div class="main-header-left">
          <div class="main-title">Sistem Informasi Santri Pontren Husnul Khotimah</div>
          <div class="main-subtitle">
            Form input Nilai Tahsin dan Tahfidz Qur'an (TTQ) Santri oleh Musyrif.
          </div>
        </div>
        <div class="main-header-right">
          Mode: <span>Musyrif</span>
          <span class="badge" id="statusBadgeMusyrif">Login diperlukan</span>
          <button type="button"
                  id="logoutMusyrifBtn"
                  class="btn"
                  onclick="handleLogoutMusyrif()"
                  style="display:none;">
            Logout
          </button>
        </div>
      </header>

      <main class="main-body">
        <!-- LOGIN MUSYRIF -->
        <div id="musyrifLoginContainer" class="login-page">
          <div class="login-header">
            <div class="login-badge">ðŸ”‘ Login</div>
            <div class="login-title">Musyrif</div>
            <div class="login-subtitle">
              Gunakan akun Musyrif yang telah didaftarkan untuk mengisi Nilai TTQ santri.
            </div>
          </div>

          <form id="loginMusyrifForm" onsubmit="handleLoginMusyrif(event)">
            <div class="login-form-group">
              <label for="loginMusyrifID">Username (Email)</label>
              <input type="text" id="loginMusyrifID" placeholder="email musyrif" autocomplete="username" />
            </div>
            <div class="login-form-group">
              <label for="loginMusyrifPassword">Password</label>
              <div class="password-wrapper">
                <input type="password" id="loginMusyrifPassword" placeholder="password" autocomplete="current-password" />
                <button
                  type="button"
                  class="toggle-password"
                  data-target="loginMusyrifPassword"
                  onclick="togglePassword(this)">
                  Show
                </button>
              </div>
            </div>
            <button type="submit" class="login-button">Masuk</button>
          </form>

          <div id="loginMusyrifError" class="login-error"></div>

          <div class="login-footer">
            Akses login diatur oleh Admin SISPO HK.
          </div>
        </div>

        <!-- FORM TTQ -->
        <div id="musyrifFormContainer" style="display:none;">
          <div class="musyrif-header">
            <div class="musyrif-title">Input Rapot TTQ oleh Musyrif</div>
            <div class="musyrif-subtitle">
              Musyrif mengisi nilai Hafalan Muqorror, Ujian Muqorror, Hafalan Murojaah, Hafalan Ziyadah, dan Ujian Ziyadah.
            </div>
          </div>

          <div class="musyrif-form-wrapper">
            <!-- FILTER -->
            <div class="musyrif-filter-card">
              <div class="musyrif-filter-grid">
                <!-- 1. Tahun Ajaran -->
                <div class="musyrif-filter-item">
                  <label for="musyrifTahun">Tahun Ajaran</label>
                  <select id="musyrifTahun">
                    <option value="2023_2024">2023/2024</option>
                    <option value="2024_2025" selected>2024/2025</option>
                    <option value="2025_2026">2025/2026</option>
                  </select>
                </div>
                <!-- 2. Semester -->
                <div class="musyrif-filter-item">
                  <label for="musyrifSemester">Semester</label>
                  <select id="musyrifSemester">
                    <option value="1" selected>1</option>
                    <option value="2">2</option>
                  </select>
                </div>
                <!-- 3. Jenjang -->
                <div class="musyrif-filter-item">
                  <label for="musyrifJenjang">Jenjang</label>
                  <select id="musyrifJenjang">
                    <option value="MTs (HK1)">MTs (HK1)</option>
                    <option value="MTs (HK2)">MTs (HK2)</option>
                    <option value="MA" selected>MA</option>
                  </select>
                </div>
                <!-- 4. Kelas -->
                <div class="musyrif-filter-item">
                  <label for="musyrifKelas">Kelas</label>
                  <select id="musyrifKelas">
                    <option value="VII">VII</option>
                    <option value="VIII">VIII</option>
                    <option value="IX">IX</option>
                    <option value="X">X</option>
                    <option value="XI" selected>XI</option>
                    <option value="XII">XII</option>
                  </select>
                </div>
                <!-- 5. Paralel / Rombel -->
                <div class="musyrif-filter-item">
                  <label for="musyrifParalel">Paralel / Rombel</label>
                  <select id="musyrifParalel">
                    <option value="A">A</option>
                    <option value="B" selected>B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                    <!-- dst, tetap sama seperti sebelumnya -->
                  </select>
                </div>
              </div>
              <div class="musyrif-filter-note">
                Data Tahun Ajaran, Semester, Jenjang, Kelas, dan Paralel akan tersimpan bersama nilai TTQ.
              </div>
            </div>

            <!-- TABEL TTQ -->
            <div class="musyrif-table-card">
              <div class="musyrif-table-title">
                <span>Daftar Nilai TTQ Santri</span>
                <small>
                  Kelas: <span id="labelMusyrifKelas">XI</span> /
                  TA <span id="labelMusyrifTahun">2024/2025</span> /
                  Sem <span id="labelMusyrifSemester">1</span>
                </small>
              </div>

              <!-- TOOLS TEMPLATE -->
              <div class="template-tools">
                <div class="template-left">
                  <button type="button" class="template-btn" onclick="downloadTemplateTTQ()">
                    â¬‡ Download Template (.xls)
                  </button>
                  <label class="template-btn secondary">
                    â¬† Upload Template (.xls/.xlsx)
                    <input type="file" id="fileTemplate" accept=".xls,.xlsx" onchange="handleUploadTemplateTTQ(event)" />
                  </label>
                </div>
                <div class="template-right">
                  Template mengikuti kolom input manual di bawah (NIS, Nama dan nilai TTQ).
                </div>
              </div>

              <table class="musyrif-table" id="tabelMusyrifTTQ">
                <thead>
                  <tr>
                    <th>No</th>
                    <th>NIS</th>
                    <th>Nama Santri</th>
                    <th>Hafalan Muqorror</th>
                    <th>Ujian Muqorror</th>
                    <th>Hafalan Murojaah</th>
                    <th>Hafalan Ziyadah</th>
                    <th>Ujian Ziyadah</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- akan diisi dengan baris input kosong oleh JS -->
                </tbody>
              </table>

              <div class="musyrif-actions">
                <button class="btn secondary" type="button" onclick="resetMusyrifTTQ()">ðŸ”„ Reset</button>
                <button class="btn" type="button" onclick="simpanMusyrifTTQ()">ðŸ’¾ Simpan Nilai</button>
              </div>
              <div class="musyrif-footer-note">
                *Musyrif mengisi manual NIS, Nama Santri, dan seluruh kolom nilai TTQ.  
                *Download/Upload Template mengikuti struktur kolom pada tabel di atas (simulasi upload di sisi frontend).
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- SUPABASE CLIENT -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const { createClient } = supabase;
    const SUPABASE_URL = 'https://esravodnlmwstdtudism.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzcmF2b2RubG13c3RkdHVkaXNtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4NDE1ODUsImV4cCI6MjA3OTQxNzU4NX0.rWxlzueSdUvd6Vc6VKaGwZv47djT-3HvyhgfI3BpxAY';
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <!-- LOGIC MUSYRIF -->
  <script>
    const MUSYRIF_SESSION_KEY = "sispo_musyrif_session";
    const SESSION_DURATION_MS = 5 * 60 * 1000;
    let musyrifLogoutTimer = null;

    async function handleLoginMusyrif(event) {
      event.preventDefault();
      const id = document.getElementById("loginMusyrifID").value.trim();
      const pass = document.getElementById("loginMusyrifPassword").value;
      const errorEl = document.getElementById("loginMusyrifError");
    
      if (!id || !pass) {
        errorEl.textContent = "Username dan password wajib diisi.";
        return;
      }
    
      const { data, error } = await db.auth.signInWithPassword({
        email: id,
        password: pass
      });
    
      if (error) {
        console.error(error);
        errorEl.textContent = "Login gagal. Periksa kembali username dan password.";
        return;
      }
    
      const { data: roleData, error: roleError } = await db
        .from('user_roles')
        .select('mode')
        .eq('id', data.user.id)
        .single();
    
      if (roleError || !roleData) {
        console.error(roleError);
        errorEl.textContent = "Role pengguna tidak ditemukan.";
        await db.auth.signOut();
        return;
      }
    
      if (roleData.mode !== 'musyrif') {
        errorEl.textContent = "Akun ini bukan akun Musyrif.";
        await db.auth.signOut();
        return;
      }
    
      errorEl.textContent = "";
      setMusyrifSession();
      applyMusyrifLoginUI();
      initMusyrifTable();
      scheduleMusyrifAutoLogout();
    }

    function applyMusyrifLoginUI() {
      document.getElementById("musyrifLoginContainer").style.display = "none";
      document.getElementById("musyrifFormContainer").style.display = "block";
      document.getElementById("statusBadgeMusyrif").textContent = "Login";
      const btn = document.getElementById("logoutMusyrifBtn");
      if (btn) btn.style.display = "inline-block";
    }
    
    function applyMusyrifLogoutUI() {
      document.getElementById("musyrifLoginContainer").style.display = "block";
      document.getElementById("musyrifFormContainer").style.display = "none";
      document.getElementById("statusBadgeMusyrif").textContent = "Login diperlukan";
      const btn = document.getElementById("logoutMusyrifBtn");
      if (btn) btn.style.display = "none";
    }
    
    function setMusyrifSession() {
      const expiresAt = Date.now() + SESSION_DURATION_MS;
      localStorage.setItem(MUSYRIF_SESSION_KEY, JSON.stringify({ expiresAt }));
    }
    
    function clearMusyrifSession() {
      localStorage.removeItem(MUSYRIF_SESSION_KEY);
      if (musyrifLogoutTimer) {
        clearTimeout(musyrifLogoutTimer);
        musyrifLogoutTimer = null;
      }
    }
    
    function scheduleMusyrifAutoLogout() {
      const raw = localStorage.getItem(MUSYRIF_SESSION_KEY);
      if (!raw) return;
    
      try {
        const { expiresAt } = JSON.parse(raw);
        const remaining = expiresAt - Date.now();
        if (remaining <= 0) {
          handleLogoutMusyrif();
        } else {
          if (musyrifLogoutTimer) clearTimeout(musyrifLogoutTimer);
          musyrifLogoutTimer = setTimeout(handleLogoutMusyrif, remaining);
        }
      } catch (e) {
        handleLogoutMusyrif();
      }
    }
    
    function handleLogoutMusyrif() {
      clearMusyrifSession();
      applyMusyrifLogoutUI();
    
      const form = document.getElementById("loginMusyrifForm");
      if (form) form.reset();
      const errorEl = document.getElementById("loginMusyrifError");
      if (errorEl) errorEl.textContent = "";
    }
    
    document.addEventListener("DOMContentLoaded", function () {
      const raw = localStorage.getItem(MUSYRIF_SESSION_KEY);
      if (!raw) return;
    
      try {
        const { expiresAt } = JSON.parse(raw);
        if (expiresAt && expiresAt > Date.now()) {
          applyMusyrifLoginUI();
          initMusyrifTable();
          scheduleMusyrifAutoLogout();
        } else {
          clearMusyrifSession();
          applyMusyrifLogoutUI();
        }
      } catch (e) {
        clearMusyrifSession();
        applyMusyrifLogoutUI();
      }
    });
    
    function togglePassword(btn) {
      const targetId = btn.getAttribute("data-target");
      const input = document.getElementById(targetId);
      if (!input) return;

      if (input.type === "password") {
        input.type = "text";
        btn.textContent = "Hide";
      } else {
        input.type = "password";
        btn.textContent = "Show";
      }
    }

    /* ====== TABEL INPUT MANUAL (TANPA DUMMY) ====== */

    function createEmptyMusyrifRow(no) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="col-no">${no}</td>
        <td><input type="text" data-field="nis" placeholder="NIS"></td>
        <td class="label-left"><input type="text" data-field="nama" placeholder="Nama Santri"></td>
        <td><input type="number" min="0" max="100" data-field="muqorror"></td>
        <td><input type="number" min="0" max="100" data-field="ujianMuqorror"></td>
        <td><input type="number" min="0" max="100" data-field="murojaah"></td>
        <td><input type="number" min="0" max="100" data-field="ziyadah"></td>
        <td><input type="number" min="0" max="100" data-field="ujianZiyadah"></td>
      `;
      return tr;
    }

    function renumberMusyrifRows() {
      const rows = document.querySelectorAll("#tabelMusyrifTTQ tbody tr");
      rows.forEach((tr, idx) => {
        const noCell = tr.querySelector(".col-no");
        if (noCell) noCell.textContent = idx + 1;
      });
    }

    function initMusyrifTable() {
      const tbody = document.querySelector("#tabelMusyrifTTQ tbody");
      tbody.innerHTML = "";
      // misalnya sediakan 5 baris kosong awal
      for (let i = 1; i <= 5; i++) {
        tbody.appendChild(createEmptyMusyrifRow(i));
      }
      updateMusyrifLabels();
      setupMusyrifFilterListeners();
    }

    function setupMusyrifFilterListeners() {
      ["musyrifTahun","musyrifKelas","musyrifSemester"].forEach(id => {
        const el = document.getElementById(id);
        if (el && !el.dataset.listenerAttached) {
          el.addEventListener("change", updateMusyrifLabels);
          el.dataset.listenerAttached = "true";
        }
      });
    }

    function updateMusyrifLabels() {
      const tahun = document.getElementById("musyrifTahun").value;
      const kelas = document.getElementById("musyrifKelas").value;
      const semester = document.getElementById("musyrifSemester").value;

      document.getElementById("labelMusyrifTahun").textContent = tahun.replace("_","/");
      document.getElementById("labelMusyrifKelas").textContent = kelas;
      document.getElementById("labelMusyrifSemester").textContent = semester;
    }

    function resetMusyrifTTQ() {
      initMusyrifTable();
      alert("Form nilai TTQ dikosongkan.");
    }

    /* ====== SIMPAN KE SUPABASE (INPUT MANUAL) ====== */

    async function simpanMusyrifTTQ() {
      const rows = document.querySelectorAll("#tabelMusyrifTTQ tbody tr");
    
      const tahun = document.getElementById("musyrifTahun").value;
      const semester = parseInt(document.getElementById("musyrifSemester").value, 10);
      const jenjang = document.getElementById("musyrifJenjang").value;
      const kelas = document.getElementById("musyrifKelas").value;
      const paralel = document.getElementById("musyrifParalel").value;
    
      const payload = [];
    
      rows.forEach((tr) => {
        const nis   = tr.querySelector('input[data-field="nis"]').value.trim();
        const nama  = tr.querySelector('input[data-field="nama"]').value.trim();
        const muq   = tr.querySelector('input[data-field="muqorror"]').value;
        const ujMuq = tr.querySelector('input[data-field="ujianMuqorror"]').value;
        const mur   = tr.querySelector('input[data-field="murojaah"]').value;
        const ziy   = tr.querySelector('input[data-field="ziyadah"]').value;
        const ujZiy = tr.querySelector('input[data-field="ujianZiyadah"]').value;

        // lewati baris kosong (tanpa NIS dan Nama)
        if (!nis && !nama && !muq && !ujMuq && !mur && !ziy && !ujZiy) return;
        if (!nis || !nama) return; // wajib ada identitas
        
        payload.push({
          nis,
          nama,
          tahun_ajaran: tahun,
          semester: semester,
          jenjang,
          kelas,
          paralel,
          hafalan_muqorror:   muq   === "" ? null : Number(muq),
          ujian_muqorror:     ujMuq === "" ? null : Number(ujMuq),
          hafalan_murojaah:   mur   === "" ? null : Number(mur),
          hafalan_ziyadah:    ziy   === "" ? null : Number(ziy),
          ujian_ziyadah:      ujZiy === "" ? null : Number(ujZiy)
        });
      });
    
      if (payload.length === 0) {
        alert("Tidak ada data santri yang diisi. Lengkapi minimal satu baris (NIS & Nama).");
        return;
      }

      console.log("Payload TTQ akan dikirim:", payload);
    
      const { data, error } = await db
        .from("nilai_ttq")
        .insert(payload);
    
      if (error) {
        console.error(error);
        alert("Gagal menyimpan nilai TTQ: " + error.message);
      } else {
        console.log("Data TTQ tersimpan:", data);
        alert("Nilai TTQ berhasil disimpan ke database Supabase.");
      }
    }

    /* ====== TEMPLATE DOWNLOAD / UPLOAD (SINKRON DENGAN INPUT MANUAL) ====== */

    function downloadTemplateTTQ() {
      const tahun = document.getElementById("musyrifTahun").value.replace("_","/");
      const kelas = document.getElementById("musyrifKelas").value;
      const semester = document.getElementById("musyrifSemester").value;
      const paralel = document.getElementById("musyrifParalel").value;

      let csv = "";
      csv += `Tahun Ajaran,${tahun}\r\n`;
      csv += `Semester,${semester}\r\n`;
      csv += `Kelas,${kelas}\r\n`;
      csv += `Paralel/Rombel,${paralel}\r\n`;
      csv += `Jenis,TTQ\r\n\r\n`;
      csv += "NIS,Nama Santri,Hafalan Muqorror,Ujian Muqorror,Hafalan Murojaah,Hafalan Ziyadah,Ujian Ziyadah\r\n";

      const rows = document.querySelectorAll("#tabelMusyrifTTQ tbody tr");
      rows.forEach(tr => {
        const nis   = tr.querySelector('input[data-field="nis"]').value.trim();
        const nama  = tr.querySelector('input[data-field="nama"]').value.trim();
        const muq   = tr.querySelector('input[data-field="muqorror"]').value.trim();
        const ujMuq = tr.querySelector('input[data-field="ujianMuqorror"]').value.trim();
        const mur   = tr.querySelector('input[data-field="murojaah"]').value.trim();
        const ziy   = tr.querySelector('input[data-field="ziyadah"]').value.trim();
        const ujZiy = tr.querySelector('input[data-field="ujianZiyadah"]').value.trim();

        csv += `${nis},${nama},${muq},${ujMuq},${mur},${ziy},${ujZiy}\r\n`;
      });

      const blob = new Blob([csv], {
        type: "application/vnd.ms-excel"
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `template_TTQ_kelas_${kelas}_${paralel}.xls`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function handleUploadTemplateTTQ(event) {
      const file = event.target.files[0];
      if (!file) return;

      const ext = file.name.toLowerCase().split(".").pop();
      const reader = new FileReader();

      if (ext === "xls" || ext === "xlsx") {
        reader.onload = function(e) {
          const buffer = e.target.result;
          console.log("File TTQ .xls/.xlsx ter-upload (simulasi), size:", buffer.byteLength, "bytes");
          alert("Template TTQ berhasil di-upload (simulasi). Untuk parsing isi file dibutuhkan library tambahan di backend.");
        };
        reader.readAsArrayBuffer(file);
      } else {
        alert("Format file tidak dikenali. Gunakan file .xls atau .xlsx.");
      }
    }
  </script>
</body>
</html>
